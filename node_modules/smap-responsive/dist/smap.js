var smap={core:{},event:$("<div />"),copyright:"© 2014 Malmö stad, Kristianstad kommun, Helsingborg stad, Lunds kommun"};
smap.core.Div=L.Class.extend({initialize:function(){this.parentTag=$("body"),this.draw()},draw:function(){var a=$("#mapdiv");if(!a.length){var a=$('<div id="mapdiv" class="mapdiv" />'),i=$('<div id="maindiv" class="maindiv" />');i.append(a),this.parentTag.append(i)}utils.isTouchOnly();L.Browser.touch&&$(window).on("orientationchange",function(){window.scrollTo(0,0)}),smap.event.on("smap.core.pluginsadded",function(){($("body > header").length||smap.cmd.getControl("MalmoHeader"))&&i.addClass("map-with-header");var a=utils.getBrowser();a.ie&&a.ieVersion<=8&&$(".leaflet-top.leaflet-right").addClass("map-with-header-ie8")})},CLASS_NAME:"smap.core.Div"});
smap.core.Init=L.Class.extend({_selectedFeatures:[],initialize:function(){this.defineProjs(),smap.core.divInst=new smap.core.Div,smap.cmd.loading(!0),this.init()},_checkBrowserSupport:function(){var e=utils.getBrowser();e.ie&&e.ieVersion<=8&&smap.cmd.notify("Obs! Applikationen stödjer inte din webbläsare. Använd en nyare version.","warning")},init:function(e){function n(e){t.push(e),o.loadConfig(e).done(function(){function n(){smap.config.configName=a.CONFIG,smap.config.langCode=smap.cmd.getLang(),o.applyConfig(smap.config),a=$.extend({},utils.objectToUpperCase(smap.config.params||{}),a),smap.core.paramInst.applyParams(a),smap.cmd.loading(!1)}if(t.length>1&&smap.event.on("smap.core.createparams",function(n,o){o.config=e}),smap.config=config||window.config,smap.config.onLoad){var s=smap.config.onLoad(smap.config);s.done(n)}else n(smap.config)}).fail(function(e,o,i){var r=smap.core.mainConfig.configDirs||null;if(!(r&&r instanceof Array&&t.length<=r.length))throw smap.cmd.loading(!1),new Error("The specified config file was not found: "+a.CONFIG);n(r[t.length-1]+s)})}e=e||{};var o=this;this.drawMap(),this._checkBrowserSupport(),smap.core.layerInst=new smap.core.Layer(this.map),smap.core.selectInst=new smap.core.Select(this.map),smap.core.paramInst=new smap.core.Param(this.map),smap.core.pluginHandlerInst=new smap.core.PluginHandler(this.map);var a=e.params||smap.core.paramInst.getParams(),t=[];a.CONFIG||(a.CONFIG="config.js");var s=a.CONFIG.substring(a.CONFIG.lastIndexOf("/")+1);n(a.CONFIG)},applyConfig:function(e){this.preProcessConfig(e);var n=e.coreConfig||{};$.extend(smap.core.selectInst.options,n.select||{}),$.extend(this.map.options,e.mapConfig||{}),$.extend(smap.core.mainConfig.smapOptions,e.smapOptions||{});var o=smap.core.mainConfig.smapOptions,a=utils.getBrowser();a.ie&&a.ieVersion<=8||$("title").text(o.title);var t=o.favIcon;if(t&&!(a.ie&&a.ieVersion<=8)){var s=$('<link rel="shortcut icon" type="image/x-icon" href="'+t+'" />');$("[rel=shortcut]").remove(),$("title").after(s)}this.map.options.maxBounds&&this.map.setMaxBounds(this.map.options.maxBounds),smap.core.pluginHandlerInst.addPlugins(e.plugins)},resetMap:function(){smap.map.off();for(var e=smap.core.controls,n=0,o=e.length;o>n;n++)try{smap.map.removeControl(e[n])}catch(a){}this.map.remove(),this.map=null,delete this.map,smap.map=null,delete smap.map,window.config=null;try{delete window.config}catch(a){}smap.config=null,delete smap.config,smap.event.off(),smap.core.controls=[],smap.core.layerInst=null,smap.core.modInst=null,smap.core.paramInst=null,delete smap.core.layerInst,delete smap.core.modInst,delete smap.core.paramInst},drawMap:function(e){e=e||{};var n=L.Browser.touch&&L.Browser.msTouch;n&&(e.tapTolerance=30);var o=smap.core.mainConfig.mapConfig||{},a=$.extend(o,e);this.map=L.map("mapdiv",a),smap.map=this.map;var t=this.map.attributionControl;t.addAttribution('<a href="//github.com/getsmap/smap-responsive" target="_blank">sMap responsive</a>&nbsp;|'),a.disabledRightClick&&this.map.on("contextmenu",function(e){e.originalEvent.preventDefault(),e.originalEvent.stopPropagation()}),utils.getBrowser().ie9&&$(".leaflet-bottom.leaflet-right").addClass(".leaflet-bottom-right-ie9")},loadConfig:function(e){return e=e||"config.js",$.ajax({url:e,context:this,dataType:"script"})},preProcessConfig:function(e){e.ws&&e.ws.hasOwnProperty(document.domain)&&(e.ws=e.ws[document.domain]);for(var n=e.bl||[],o=0,a=n.length;a>o;o++)n[o].options=n[o].options||{},n[o].options.isBaseLayer=!0;for(var t,s=e.bl.concat(e.ol||[]),i=this._createLegendUrl,o=0,a=s.length;a>o;o++)t=s[o],void 0===t.options.legend&&t.options.layers&&_.indexOf(["L.TileLayer.WMS","L.NonTiledLayer.WMS"],t.init)>-1&&(t.options.legend=i(t.url,t.options.layers))},_createLegendUrl:function(e,n){n.split(",").length>1&&(n=n.split(",")[0]);var o="version=1.1.1&request=GetLegendGraphic&format=image/png&width=20&height=20&layer="+n;return utils.urlAppend(e,o)},defineProjs:function(){window.proj4&&(proj4=window.proj4,proj4.defs([["EPSG:4326","+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"],["EPSG:3857","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"],["EPSG:3008","+proj=tmerc +lat_0=0 +lon_0=13.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"],["EPSG:3006","+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"],["EPSG:3021","+proj=tmerc +lat_0=0 +lon_0=15.8062845294444 +k=1.00000561024+x_0=1500064.274 +y_0=-667.711 +ellps=GRS80 +units=m"]]))},CLASS_NAME:"smap.core.Init"});
smap.core.Layer=L.Class.extend({options:{defaultStyle:{color:"#00F",fillColor:"#00F",opacity:1,fillOpacity:.3,radius:8,weight:1},selectStyle:{weight:5,color:"#00DDFF",dashArray:"",fillOpacity:.8,strokeOpacity:1}},_layers:{},_bindEvents:function(){var e=this.map;this._onLayerAdd=this._onLayerAdd||$.proxy(this.onLayerAdd,this),this._onLayerRemove=this._onLayerRemove||$.proxy(this.onLayerRemove,this),e.on("layeradd",this._onLayerAdd),e.on("layerremove",this._onLayerRemove),smap.event.on("smap.core.applyparams",function(t,a){var r;if(a.BL&&(r=smap.cmd.getLayerConfig(a.BL)),r=r||smap.config.bl[0],r&&r.options&&(r.options.isBaseLayer=!0,e.addLayer(this._createLayer(r))),a.OL){var i,n,o=a.OL instanceof Array?a.OL:a.OL.split(",");for(i=0,n=o.length;n>i;i++)this._addLayerWithConfig(smap.cmd.getLayerConfig(o[i]))}}.bind(this))},initialize:function(e){this.map=e,this._bindEvents()},addOverlays:function(e){this._addLayers(e)},_addLayers:function(e){e=e||[];var t,a;for(t=0,len=e.length;t<len;t++)a=e[t],this._addLayerWithConfig(a)},_addLayerWithConfig:function(e){if(!e||!e.options)return!1;var t=this._createLayer(e);if(!t)return!1;var a=e.options.parentLayerId?this._getLayer(e.options.parentLayerId)||this.map:this.map;return a.addLayer(t),t},onLayerAdd:function(e){var t=e.layer;if(t.options&&!t.options._silent&&t.options.layerId&&!t.feature&&(t instanceof L.NonTiledLayer||t._tileContainer||t._layers)){var a=t.options.layerId;this._layers[a]=t,t._layers&&this._wfsLayers.push(t)}},onLayerRemove:function(e){var t=e.layer;t._layers&&this._wfsLayers.splice(t,1)},_getLayer:function(e){return this._layers[e]||null},_wfsLayers:[],_createLayer:function(t){var layerAlreadyAdded=this._getLayer(t.options.layerId);if(layerAlreadyAdded)return layerAlreadyAdded;var init=eval(t.init);init.options=init.options||{},t.options.isBaseLayer?t.options.zIndex=t.options.zIndex||0:t.options.zIndex=t.options.zIndex||10;var layer;if(t.params)layer=Object.create(init.prototype),init.apply(layer,t.params),t.options&&t.options instanceof Object&&$.extend(layer.options,t.options);else{if(t.url){var opts=t.options;if(init===L.TileLayer.WMS){var newOpts=$.extend(!0,{},opts);newOpts=_.pick(newOpts,["service","request","version","layers","styles","format","width","height","bbox","angle","buffer","cql_filter","env","featureid","filter","format_options","maxfeatures","namespace","palette","propertyname","tiled","tilesorigin","scalemethod","srs","map_resolution","transparent","sld","sld_body"]),layer=new init(t.url,newOpts),$.extend(layer.wmsParams,newOpts),$.extend(layer.options,opts),layer.setZIndex(opts.zIndex)}else layer=t.url?new init(t.url,opts):new init(opts)}else t.key?(layer=new init(t.key,t.options),layer.options.layerid=t.options.layerId,this._layers[t.options.layerId]=layer):layer=new init(t.options);(layer instanceof L.esri.Layers.DynamicMapLayer||layer instanceof L.esri.Layers.TiledMapLayer)&&(this._layers[t.options.layerId]=layer)}var self=this;return layer.on&&layer.options&&(layer._layers?(!layer.options.style&&(!layer.options.geomType||layer.options.geomType&&layer.options.geomType.search(/POINT/gi))>-1?layer.options.style=null:layer.options.style=layer.options.style||$.extend({},self.options.defaultStyle),layer.on("loadcancel loaderror",function(e){smap.cmd.loading(!1)})):layer.on("load",function(e){smap.cmd.loading(!1)}),layer.on&&(layer.on("load",function(e){smap.cmd.loading(!1)}),layer.on("loading",function(e){smap.cmd.loading(!0)}))),layer},showLayer:function(e){var t=e instanceof Object?e:smap.cmd.getLayerConfig(e);if(t){var a=this._getLayer(e);a||(a=this._createLayer(t));var r=t.options.parentLayerId?this._getLayer(t.options.parentLayerId)||this.map:this.map;return r.hasLayer(a)===!1&&r.addLayer(a),a}},hideLayer:function(e){var t=e instanceof Object?e:this._getLayer(e);t.fire&&t.fire("loadcancel",{layer:this});var a=t.options.parentLayerId?this._getLayer(t.options.parentLayerId)||this.map:this.map;return a.removeLayer(t),t},CLASS_NAME:"smap.core.Layer"});
smap.core.Param=L.Class.extend({initialize:function(e){this.map=e,$(window).on("hashchange",function(e){var a=this._getHashAsObject();a._originalEvent=e,smap.event.trigger("hashchange",a)}.bind(this)),smap.event.on("hashchange",this._onHashChange.bind(this))},_lang:{sv:{remove:"Ta bort"},en:{remove:"Remove"}},_setLang:function(){langCode=smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[langCode]:null)},getParams:function(){var e=this._cachedParams||null;return e||(e=this.getWebParamsAsObject(),smap.config&&(configParams=smap.config.params||{},e=$.extend({},utils.objectToUpperCase(configParams),e),this._cachedParams=e)),e},_getHashAsObject:function(e){e=e||location.hash.substring(1);var a=utils.paramsStringToObject(e,!0);return a},getWebParamsAsObject:function(e){e=e||"?";var a=location.href,t=a.indexOf("#"),s=a.substring(0,-1===t?a.length:t).split(e),n=s.length>1?s[1]:"";return paramsObject=utils.paramsStringToObject(n,!0),paramsObject},getHashParamsAsObject:function(){return this.getWebParamsAsObject("#")},createParamsAsObject:function(){var e,a,t,s=this.map.getCenter(),n=this.map._layers,r=[];for(var o in n)a=n[o],a&&a.options&&a.options.layerId&&(t=a.options.layerId,a.options.isBaseLayer?e=t:-1===$.inArray(a.options.layerId,r)&&r.push(t));var i={zoom:this.map.getZoom(),center:[utils.round(s.lng,5),utils.round(s.lat,5)],ol:r,bl:e};return smap.config.configName&&(i.config=smap.config.configName),smap.event.trigger("smap.core.createparams",i),smap.event.trigger("smap.core.aftercreateparams",i),i},createParams:function(e){e=e||!1;var a,t=this.createParamsAsObject(),s="";for(var n in t){if(a=t[n],a instanceof Array){if(!a.length)continue;a=a.join(",")}s+="&"+n+"="+a}if(s=s.substring(1),e){var r="";e===!0?r=document.URL.split("?")[0]+"?":"string"==typeof e&&(r=e),s=r+s}return s},_loadGeoJson:function(e,a,t){function s(){return this._prevZoom&&this._prevZoom<this.map.getZoom()?void(this._prevZoom=this.map.getZoom()):(this._prevZoom=this.map.getZoom(),o._map=smap.map,o._refresh(),void delete o._map)}function n(e){e.target.eachLayer(function(e){i.addLayer(e)})}function r(e){this.map.whenReady(function(){var a=e.target.getBounds();setTimeout(function(){this.map.fitBounds(a)}.bind(this),100),o.off("load",m)}.bind(this))}a=a===!1?!1:!0,t=t||!1;var o=this._geoJsonLayer,i=this._cluster;if(i&&i.clearLayers(),o&&(o.clearLayers(),o._featureIndexes=[],o.getFeatureUrl=e),!o){var p={url:e,init:"L.GeoJSON.WFS",options:{layerId:L.stamp(this),displayName:"External data",xhrType:"GET",attribution:"",inputCrs:"EPSG:4326",uniqueKey:"id",selectable:!0,reverseAxis:!1,reverseAxisBbox:!1,showInLayerSwitcher:!0,includeParams:["bbox"],separator:"&",noParams:!1,popup:"*",style:{icon:L.AwesomeMarkers.icon({icon:"circle",markerColor:"blue",prefix:"fa"})}}};p.options=$.extend(!0,p.options,smap.core.mainConfig.smapOptions.externalJsonOptions),smap.event.trigger("smap.core.createjsonlayer",p.options),o=smap.core.layerInst._createLayer(p),this._geoJsonLayer=o}if(a?(i||(i=L.markerClusterGroup(),this._cluster=i,this.map.addLayer(i),this.map.fire("layeradd",{layer:o,target:o}),o.on("load",n.bind(this)),this.map.on("zoomend dragend",s.bind(this))),s.call(this)):(this.map.addLayer(o),o._refresh()),t===!0){var m=r.bind(this);o.on("load",m)}smap.event.trigger("smap.core.addedjsonlayer",[o,i])},_onHashChange:function(e,a){if(a.GEOJSON){var t=a.GEOJSON instanceof Array?a.GEOJSON:a.GEOJSON.split(","),s=decodeURIComponent(t[0]),n=t.length>1&&"TRUE"===t[1].toString().toUpperCase()?!0:!1,r=t.length>2&&"TRUE"===t[2].toString().toUpperCase()?!0:!1;this._loadGeoJson(s,n,r)}},applyParams:function(e){function a(){$(".smap-core-btn-popup").on("click",function(){return t.map.removeLayer(u),!1})}e=e||{};var t=this;smap.event.trigger("smap.core.beforeapplyparams",e),this._setLang();var s=e.ZOOM?parseInt(e.ZOOM):0,n=e.CENTER?L.latLng([parseFloat(e.CENTER[1]),parseFloat(e.CENTER[0])]):null;if(s||0===s||(s=this.map.options.minZoom||0),n){if(e.CENTER.length>2){var r="EPSG:"+e.CENTER[2],o=utils.projectPoint(e.CENTER[0],e.CENTER[1],r,"EPSG:4326");n=L.latLng(o[1],o[0])}this.map.setView(n,s,{animate:!1})}else this.map.fitWorld();if(e.XY){var i=this.getWebParamsAsObject(),p=parseFloat(e.XY[1]),m=parseFloat(e.XY[0]),c=null;if(e.XY.length>2){var l=e.XY[2];if(l&&l.length&&"null"!=l&&(c="<p>"+l+'</p><button class="btn btn-default smap-core-btn-popup">'+this.lang.remove+"</button>"),e.XY.length>3){var h=e.XY[3];1!=/^EPSG:/.test(h)&&(h="EPSG:"+h);var g=utils.projectPoint(m,p,h,"EPSG:4326");m=g[0],p=g[1]}}var u=L.marker([p,m]);this.map.addLayer(u),i.CENTER||this.map.setView(u.getLatLng(),i.ZOOM||16,{animate:!1}),c&&(this.map.off("popupopen",a).on("popupopen",a),u.bindPopup(c).openPopup())}var f=paramsObject._hash=this._getHashAsObject();f&&this._onHashChange(null,f),smap.event.trigger("smap.core.applyparams",e)},CLASS_NAME:"smap.core.Param"});
smap.core.PluginHandler=L.Class.extend({initialize:function(t){this.map=t;var i=this;smap.event.on("smap.core.pluginsadded",function(){i._processQueue()})},addPlugins:function(arr){var t,init,autoActivates=[];smap.core.controls=smap.core.controls||[];for(var i=0,len=arr.length;len>i;i++)t=arr[i],init=eval(t.init),init&&(init=new init(t.options||{}),this.map.addControl(init),smap.core.controls.push(init),init.options.autoActivate&&autoActivates.push(init));smap.event.trigger("smap.core.pluginsadded"),smap.event.pluginsadded=!0;for(var i=0,len=autoActivates.length;len>i;i++)autoActivates[i].activate();$(".leaflet-bottom.leaflet-right button").tooltip({placement:"left",container:"#mapdiv"})},_callQueue:[],callPlugin:function(t,i,n,e){n=n||[];var a=L.Control[t];smap.event.pluginsadded?this._callPlugin(a,i,n,e):this._callQueue.push([a,i,n,e])},_callPlugin:function(t,i,n,e){if(!t)return null;for(var a,l=smap.core.controls||[],o=null,r=0,s=l.length;s>r;r++)if(a=l[r],a instanceof t){o=a[i].apply(a,n||[]);break}return e?e(o):o},_processQueue:function(){var t,i,n,e=this._callQueue||[];for(i=0,len=e.length;i<len;i++)t=e[i],n=this._callPlugin.apply(this,t);return this._callQueue=[],n},CLASS_NAME:"smap.core.PluginHandler"});
smap.core.Select=L.Class.extend({options:{manyUseDialog:!0},_selectedFeaturesVector:[],_selectedFeaturesWms:[],initialize:function(e){this.map=e,this._bindEvents(e),this._wfsLayers=smap.core.layerInst._wfsLayers},_getVectorVal:function(e,t){var r,e=e||{};if(paramVal=null,t.split(";").length>1){var a=t.split(";");r=e[a[0]]+";"+e[a[1]]}else r=e[t];return r},_setSelectStyle:function(e){var t=e.target;t.setStyle&&t.setStyle(this.options.selectStyle),!t.bringToFront||L.Browser.ie||L.Browser.opera||t.bringToFront()},_resetStyle:function(e){e.resetStyle&&e.eachLayer(function(t){e.resetStyle(t)})},_processHtml:function(e){var t=$("<div>"+e+"</div>");return t.find("a").each(function(){var e=$(this),t=e.attr("href"),r=e.text();if(t&&t.length>=4&&-1===$.inArray(t,["null","undefined"])){"HTTP"!==t.substring(0,4).toUpperCase()&&(t="http://"+t);var a=e.attr("target")||"_blank",s=$('<button class="btn btn-default btn-sm">'+r+"</button>");s.attr("onclick",'window.open("'+t+'", "'+a+'")'),e.after(s)}e.remove()}),t.html()},_extractAllAttributes:function(e,t){t=t||{};var r="",a="<div><strong>_key_:</strong>&nbsp;<span>_val_</span></div>";for(var s in t)r+=a.replace(/_key_/g,s).replace(/_val_/g,"${"+s+"}");var n="*";return e.search(/\$\{\*\}/)>-1&&(n=/\$\{\*\}/g),e.replace(n,r)},_bindEvents:function(e){function t(t){var r=$(".leaflet-popup-close-button"),a='<a class="leaflet-popup-close-button leaflet-popup-minimize-button" href="#">–</a>';r.before(a),$(".leaflet-popup-minimize-button").on("click",function(e){return smap.map.closePopup(),!1}),r.on("click",function(){return e.fire("unselected",{}),!1})}var r=this;e.on("popupopen",t),e.on("layerremove",function(t){var a=void 0!==t.layer._tip;return a?!1:void(r._rasterFeature&&(e.removeLayer(r._rasterFeature),r._rasterFeature=null))}),e.on("click",function(){for(var t=r._wfsLayers,a=0,s=t.length;s>a;a++)r._resetStyle(t[a]);e.fire("unselected",{})}),e.on("unselected",function(e){r._rasterFeature&&(r.map.removeLayer(r._rasterFeature),r._rasterFeature=null),e.feature?$.each(r._selectedFeaturesVector,function(t,a){return e.feature.id===a.id?(r._selectedFeaturesVector.splice(t,1),!1):void 0}):(r._selectedFeaturesVector=[],r._selectedFeaturesWms=[])}),e.on("selected",function(t){function a(e,t,r){var a="",s="";return s+='<div class="'+a+'"><h4 class="popup-layertitle">'+r+"</h4>",s+=utils.extractToHtml(e,t)+"</div>"}function s(){r._rasterFeature&&(r._rasterFeature.resetStyle(),r.map.removeLayer(r._rasterFeature),r._rasterFeature=null)}function n(e){return s(),e.geometry.type&&"Point"!==e.geometry.type&&"MultiPoint"!==e.geometry.type&&(r._rasterFeature=L.geoJson(e.geometry),r._rasterFeature.options=$.extend({},e.options),r._rasterFeature.options._silent=!0,r._rasterFeature.latLng=e.latLng,r._rasterFeature.setStyle({color:"#0FF",fillColor:"#0FF",weight:10,opacity:.9,fillOpacity:.3}),r._rasterFeature.options.selectable=!1,r._rasterFeature.eachLayer(function(e){e.eachLayer&&e.eachLayer(function(e){e.options.clickable=!1}),e.options&&(e.options.clickable=!1)}),r.map.addLayer(r._rasterFeature),r._rasterFeature.setZIndex(900)),r._rasterFeature}function o(){var e=$(this).data("index"),t=r._selectedFeaturesWms[e];n(t);var s=L.popup(),o=a(t.options.popup,t.properties,t.options.displayName);if(o=r._processHtml(o),s.setContent(o),r._rasterFeature&&r._rasterFeature.getBounds&&1===t.geometry.coordinates.length){var i=r._rasterFeature.getBounds(),l=i.getCenter();s.setLatLng(l)}else s.setLatLng(t.latLng);s.openOn(r.map);var u=$(".leaflet-popup-content:visible");return u.find("img").each(function(){utils.addImageLoadIndicator($(this),{height:"100px"})}),$(this).trigger("mouseenter"),r._selectManyModal.modal("hide"),!1}var i=t.layer,l=i.hasOwnProperty("_layers")||i.options&&i.options.clickable,u=(i.options.layerId,t.feature),p=t.selectedFeatures||[],c=(i.options.uniqueKey||"-",t.shiftKeyWasPressed),d=u.properties,f=t.latLng;if(l?(r._selectedFeaturesWms=[],c?(r._selectedFeaturesVector=utils.makeUniqueArr(r._selectedFeaturesVector.concat(p)),$.each(r._wfsLayers,function(e,t){t.eachLayer(function(e){e.unbindPopup&&e.unbindPopup(),e._layers&&$.each(e._layers,function(e,t){t.unbindPopup&&t.unbindPopup()})})})):r._selectedFeaturesVector=[].concat(p)):(r._selectedFeaturesVector=[],r._selectedFeaturesWms=utils.makeUniqueArr(r._selectedFeaturesWms.concat(p))),l&&!c&&r._selectedFeaturesVector.length<=1){for(var m,_=r._wfsLayers,y=0,g=_.length;g>y;y++)m=_[y],m!==i&&(m.resetStyle&&(m._layers?m.eachLayer(function(e){m.resetStyle(e)}):m.resetStyle(m)),m._selectedFeatures=[]);var h=i.options.popup;(i.options.popup&&"*"===i.options.popup||i.options.popup.search(/\$\{\*\}/)>-1)&&(h=r._extractAllAttributes(h,d));var v=utils.extractToHtml(h,d);v=r._processHtml(v);var m=utils.getLayerFromFeature(u,i)||u;if(m._popup&&m.unbindPopup(),m.bindPopup(v,{autoPan:!0,keepInView:!1,autoPanPadding:L.point(smap.core.mainConfig.smapOptions.popupAutoPanPadding)}),m._map){m.openPopup(f);var F=$(".leaflet-popup-content:visible");F.find("img").each(function(){utils.addImageLoadIndicator($(this),{height:"100px"})})}}if(!l){var b=L.popup(),M=r._selectedFeaturesWms[0];if(1===r._selectedFeaturesWms.length)n(M);else{if(r.options.manyUseDialog){if(!r._selectManyModal){var d,k,S=$('<button type="button" class="btn btn-default">Stäng</button>'),x=$('<div class="list-group"></div>');S.on("tap click",function(){return s(),r._selectManyModal.modal("hide"),!1}),r._selectManyModal=utils.drawDialog("Flera träffar: Välj ett objekt",x,S,{size:"sm"}),r._selectManyModal.find(".modal-header").addClass("panel-heading"),r._selectManyModal.on("hidden.bs.modal",function(){$(this).find(".list-group").empty()}),r._selectManyModal.on("shown.bs.modal",function(){$(this).scrollTop(0)}),r._selectManyModal.addClass("core-select-modal")}for(var w,P,V=r._selectManyModal.find(".list-group"),y=0,g=p.length;g>y;y++)w=p[y],d=w.properties,P=utils.extractToHtml(w.options.popup,d),(P&&"*"===P||P.search(/\$\{\*\}/)>-1)&&(P=r._extractAllAttributes(P,d)),P=r._processHtml(P),k=$('<a href="#" class="list-group-item"><span><strong>'+w.options.displayName+"</strong>"+P.replace(/^\'+|\'+$/gm,"")+'</span><div class="btn btn-success select-btn-zoom-to-feature">Zooma hit</div></a>'),k.data("index",y),utils.isTouchOnly()&&k.addClass("select-row-touch"),V.append(k);var I=V.find(".list-group-item");return I.find(".select-btn-zoom-to-feature").on("touchend click",function(){if(o.call($(this).parent()[0]),r._rasterFeature){var e=r._rasterFeature.getBounds(),t=L.Browser.touch?[100,100]:[200,150];r.map.fitBounds(e,{paddingTopLeft:t,paddingBottomRight:[100,100]})}else{var a=($(this).parent().data("index"),15);a=r.map.getZoom()<a?a:r.map.getZoom()+1,r.map.setZoomAround(M.latLng,a)}return r._selectManyModal.modal("hide"),!1}),L.Browser.touch?I.on("tap",function(){var e=$(this).data("index"),t=r._selectedFeaturesWms[e];return n(t),o.call(this),!1}):I.on("click",o),r._selectManyModal.modal("show"),!0}for(var W,A=r._selectedFeaturesWms||[],y=0,g=A.length;g>y;y++)if(M=A[y],M.geometry&&M.geometry.type&&M.geometry.type.search(/point/gi)>-1){W=M;break}if(!W){var C=parseInt(r._selectedFeaturesWms.length/2);W=r._selectedFeaturesWms[C]}n(W),M=W}var v="",d=M.properties,h=M.options.popup;(h&&"*"===h||h.search(/\$\{\*\}/)>-1)&&(h=r._extractAllAttributes(h,d)),v=a(h,M.properties,M.options.displayName),v=r._processHtml(v),e.closePopup(),b.setContent(v),b.setLatLng(M.latLng),setTimeout(function(){var t=smap.cmd.getControl("SelectWMS");if(t&&t._dblclickWasRegistered===!0)return!1;b.openOn(e);var r=$(".leaflet-popup-content:visible");r.find("img").each(function(){utils.addImageLoadIndicator($(this),{height:"100px"})})},100)}}),smap.event.on("smap.core.createparams",function(e,t){function a(e,t,r){e&&(i[e]||(i[e]={}),i[e][t]||(i[e][t]=[]),i[e][t].push(r))}var s,n,o,i={};if(r._selectedFeaturesVector&&r._selectedFeaturesVector.length){o=r._selectedFeaturesVector;for(var l=0,u=o.length;u>l;l++)s=o[l],s.properties&&s.uniqueKey&&(n=r._getVectorVal(s.properties,s.uniqueKey),a(s.layerId,"vals",n),i[s.layerId].key=s.uniqueKey)}if(r._selectedFeaturesWms&&r._selectedFeaturesWms.length){o=r._selectedFeaturesWms;for(var l=0,u=o.length;u>l;l++)s=o[l],n=[s.latLng.lng,s.latLng.lat],a(s.options.layerId,"xy",n)}$.isEmptyObject(i)===!1&&(t.sel=encodeURIComponent(JSON.stringify(i)))}),smap.event.on("smap.core.applyparams",$.proxy(function(e,t){function r(){var e,t,s,n,l,u,p=this,c=this.options.layerId,d=this.options.uniqueKey,f=o[c],m=f.vals;for(s=0,len=m.length;s<len;s++)t=m[s],e=null,$.each(p._layers,function(r,a){if(a.feature){if(n=a.feature.properties,d.split(";").length>1?(l=d.split(";"),u=n[l[0]]+";"+n[l[1]]):u=a.feature.properties[d],!u)return!1;if(u===t)return e=a,!1}}),e&&e.fire("click",{properties:e.feature.properties,latlng:a,originalEvent:{shiftKey:i}});p.off("load",r)}if(t.SEL){var a,s,n,o=JSON.parse(decodeURIComponent(t.SEL)),i=!1,l=0;for(var u in o)if(l+=1,l>1||o[u].vals&&o[u].vals.length>1){i=!0;break}for(n in o)if(s=o[n],s.key){var p=smap.core.layerInst.showLayer(n);p&&p.on("load",r)}}}))}});
smap.cmd={createParams:function(e){return smap.core.paramInst.createParams(e)},createParamsAsObject:function(){return smap.core.paramInst.createParamsAsObject()},getControl:function(e){var t=this.getControls(e);return t.length?t[0]:null},getControls:function(e){e.search(/\./)>-1&&(e=e.split(".").slice(2).join("."));var t,n=smap.core.controls||[],a=[],r=L.Control[e];if(!r)throw"smap.cmd.getControls: No control with name L.Control."+e;for(var i=0,s=n.length;s>i;i++)t=n[i],t instanceof r&&a.push(t);return a},notify:function(e,t,n){switch(n=n||{},n.parent=n.parent||$("body"),t){case"success":t="alert-success";break;case"warning":t="alert-danger";break;case"info":t="alert-info";break;case"error":t="alert-danger";break;default:t="alert-"+t}var a=$('<div class="alert map-alert '+t+' alert-dismissable"> <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+e+"</div>");return n.parent.find(".alert").remove(),n.parent.append(a),n.fade&&(a.addClass("notify-transition"),setTimeout(function(){a.addClass("notify-visible")},1),n.fadeOut=n.fadeOut||5e3),this._notifyTimeOut&&clearTimeout(this._notifyTimeOut),n.fadeOut&&(this._notifyTimeOut=setTimeout(function(){$(".alert").remove()},n.fadeOut)),a},showLayer:function(e){return smap.core.layerInst.showLayer(e)},hideLayer:function(e){return smap.core.layerInst.hideLayer(e)},addLayerWithConfig:function(e){return smap.core.layerInst._addLayerWithConfig(e)},getLayer:function(e){return smap.core.layerInst._getLayer(e)},getLayerConfig:function(e){return this.getLayerConfigBy("layerId",e)},getLayerConfigBy:function(key,val,options){options=options||{};var arr=smap.config.bl.concat(smap.config.ol||[]),i,t,compVal;for(i=0,len=arr.length;i<len;i++){if(t=arr[i],-1!==key.search(/\./))try{compVal=eval("t."+key)}catch(e){continue}else compVal=t.options[key];if(options.inText){if(void 0!==compVal&&compVal.search(val)>-1)return t}else if(void 0!==compVal&&compVal===val)return t}return null},getLang:function(){var e=smap.core.mainConfig.smapOptions.defaultLanguage||"en",t=smap.core.paramInst?smap.core.paramInst.getParams().LANG:e,n=t?t.split("-")[0]:e;return n},reloadCore:function(e){e=e||{},smap.core.initInst.resetMap(),smap.core.initInst.init(e)},loading:function(e,t){if(t=t||{},!window.Spinner)return!1;var n={sv:{loading:"Laddar"},en:{loading:"Loading"}},a=this.getLang(),r=n.hasOwnProperty(a)?n[a]:n.en,i=t.text;if(i instanceof Object&&(i=i[r]),e&&e===!0){if(!this.spinner){var s={lines:12,length:4,width:6,radius:40};this.spinner=new Spinner(s).spin()}this.spinner.spin(),$("#mapdiv").append(this.spinner.el),$("div .spinner").css({top:"50%",left:"50%"}),$(this.spinner.el).append('<div id="loadingText">'+(i||r.loading)+"</div>")}else this.spinner.stop()}};
smap.core.mainConfig={mapConfig:{layers:[],crs:L.CRS.EPSG3857,attributionControl:!0,zoomControl:!1,maxZoom:18,disabledRightClick:!0},smapOptions:{title:"sMap-responsive",favIcon:"https://assets-cdn.github.com/favicon.ico",popupAutoPanPadding:[0,70],defaultLanguage:"sv",externalJsonOptions:{}},toolbarPlugin:"Menu",defaultTheme:"smap",configDirs:["/rest/leaf/configs-1.0/","configs/","dist/configs/"]};
var utils={rmPx:function(e){return e&&e.replace?parseInt(e.replace(/px/gi,"").replace(/em/gi,"").replace(/pt/gi,"")):e},log:function(e){window.console},isTouchOnly:function(){return L.Browser.touch&&((L.Browser.ie?L.Browser.msTouch:!0)||navigator.userAgent.toLowerCase().indexOf("windows phone")>-1)},capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},addImageLoadIndicator:function(e,t){t=t||{};var r={height:"100px"};$.extend(r,t);var n=$('<div class="img-load-indicator"><i class="fa fa-spinner"></i></div>');n.css("height","100px"),e.before(n),e.addClass("hidden img-smooth-loading"),e.on("load",function(){var e=$(this);e.prev(".img-load-indicator").remove(),e.removeClass("hidden"),setTimeout(function(){e.addClass("img-fade-in")},200)})},textInsert:function(e,t){for(var r=0,n=t.length;n>r;r++)e=e.replace("%s",t[r]);return e},getBrowser:function(){var e=navigator.userAgent.match(/(?:MSIE |Trident\/.*; rv:)(\d+)/),t=e?parseInt(e[1]):void 0;return{ie:e,ieVersion:t,ie8:8===t,ie9:9===t,ie10:10===t,ie11:11===t}},urlAppend:function(e,t,r){r=r||"?";var n="?"===r?/\?/g:/#/g,a=t.charAt(t.length-1);return"&"===a&&(e=a.substring(0,t.length-1)),-1===e.search(n)&&(e+=r),e+t},isInIframe:function(){return top.location!=self.location},makeUniqueArr:function(e){var t=[];return $.each(e,function(e,r){-1===$.inArray(r,t)&&t.push(r)}),t},objectToUpperCase:function(e){var t={};for(var r in e)t[r.toUpperCase()]=e[r];return t},drawDialog:function(e,t,r,n){n=n||{},n.size=n.size||"";var a=$('<div class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'+(-1===e.search(/</g)?'<h4 class="modal-title">'+e+"</h4>":e)+'</div><div class="modal-body"></div></div>');if(a.find(".modal-body").append(t),r){var i=$('<div class="modal-footer"></div>');a.find(".modal-body").after(i),i.append(r)}return n.size&&a.find(".modal-dialog").addClass("modal-"+n.size),a},getLayerFromFeature:function(e,t){var r=t._layers;for(var n in r){var a=r[n];if(a.feature&&a.feature.id===e.id)return a}return null},round:function(e,t){var r=Math.pow(10,t||0);return Math.round(e*r)/r},makeUnselectable:function(e){e.attr("unselectable","unselectable").addClass("unselectable")},extractToHtml:function(html,props){function getFunctionEnd(e){var t=1,r=!1,n=e.search(/\{/g);e=e.substring(n+1);var a=0;for(a=0,len=e.length;a<len;a++)if("{"===e.charAt(a)?t+=1:"}"===e.charAt(a)&&(t-=1),0===t){r=!0,a=a+n+2;break}return r||(a=-1),a}function extractAttribute(a,txt){var index=txt.search(/\${/g);if(-1!==index){var extractedAttribute="",attr=html.substring(index+2),endIndex=0;if(endIndex="function"===attr.substring(0,8)?getFunctionEnd(attr):attr.search(/\}/g),attr=attr.substring(0,endIndex),"function"===attr.substring(0,8)){var theFunc=attr.replace("function","function f");eval(theFunc),extractedAttribute=f.call(this,a)}else{var paramsArr=attr.split(",");if(paramsArr.length>1){var firstParam=$.trim(paramsArr[0]),secondParam=$.trim(paramsArr[1]);if(extractedAttribute=a[firstParam]||"",secondParam&&1===parseInt(secondParam))try{extractedAttribute=decodeURIComponent(extractedAttribute)}catch(e){}}else extractedAttribute=a[attr]||""}txt=txt.replace("${"+attr+"}",extractedAttribute&&extractedAttribute.replace?extractedAttribute.replace(/^\'+|\'+$/gm,""):extractedAttribute)}return txt}if(!props)return"";if("undefined"==typeof html)return html=null;for(var index=html.search(/\${/g);-1!==index;)html=extractAttribute(props,html),index=html.search(/\${/g);return html},createLabel:function(e,t,r){r=r||"leaflet-maplabel";var n=L.marker(e,{icon:new L.DivIcon({iconSize:null,className:r,html:"<div>"+t+"</div>"})});return n.options._noprint=!0,n.options.clickable=!1,n.options.selectable=!1,n},getLength:function(e){var t,r=0;for(t=0,len=e.length-1;t<len;t++)r+=e[t].distanceTo(e[t+1]);return r},paramsStringToObject:function(e,t){t=t||!1;for(var r,n,a,i={},o=e.split(/[&;]/),s=0,c=o.length;c>s;s++)if(a=o[s].split("="),a[0]){r=a[0];try{r=decodeURIComponent(r)}catch(l){r=unescape(r)}n=(a[1]||"").replace(/\+/g," ");try{n=decodeURIComponent(n)}catch(l){n=unescape(n)}n=n.split(","),1==n.length&&(n=n[0]),t&&(r=r.toUpperCase()),i[r]=n}return i},projectPoint:function(e,t,r,n){return window.proj4(r,n,[e,t])},projectLatLng:function(e,t,r,n,a){var i=n?[e.lat,e.lng]:[e.lng,e.lat],o=window.proj4(t,r,i),s=a?L.latLng(o[0],o[1]):L.latLng(o[1],o[0]);return s},projectFeature:function(e,t,r,n){function a(e,t){var n=g(e[0],e[1],t,r);return p&&(n=[f(n[0],u),f(n[1],u)]),n}function i(e){return[e[1],e[0]]}n=n||{};var o,s,c,l,d,u=n.decimals,p=n.decimals||0===n.decimals?!0:!1,f=this.round,g=this.projectPoint;switch(d=e.geometry,d.type){case"Point":o=d.coordinates,n.reverseAxisInput&&(o=i(o)),c=a(o,t),n.reverseAxisOutput&&(c=i(c)),d.coordinates=c;break;case"MultiPoint":for(l=0,v=d.coordinates.length;v>l;l++)o=d.coordinates[l],n.reverseAxisInput&&(o=i(o)),c=a(o,t),n.reverseAxisOutput&&(c=i(c)),d.coordinates[l]=c;break;case"LineString":for(s=d.coordinates,l=0,lenP=s.length;l<lenP;l++)o=s[l],n.reverseAxisInput&&(o=i(o)),c=a(o,t),n.reverseAxisOutput&&(c=i(c)),s[l]=c;break;case"MultiLineString":s=[];var h,v,m;for(l=0,v=d.coordinates.length;v>l;l++){for(s=d.coordinates[l],h=0,m=s.length;m>h;h++)o=s[h],n.reverseAxisInput&&(o=i(o)),c=a(o,t),n.reverseAxisOutput&&(c=i(c)),s[h]=c;d.coordinates[l]=s}break;case"Polygon":for(s=d.coordinates[0],l=0,lenP=s.length;l<lenP;l++)o=s[l],n.reverseAxisInput&&(o=i(o)),c=a(o,t),n.reverseAxisOutput&&(c=i(c)),s[l]=c;break;case"MultiPolygon":s=[];var h,x,v,m,b,A;for(l=0,v=d.coordinates.length;v>l;l++)for(s=d.coordinates[l],h=0,m=s.length;m>h;h++)for(A=s[h],x=0,b=A.length;b>x;x++)o=A[x],n.reverseAxisInput&&(o=i(o)),c=a(o,t),n.reverseAxisOutput&&(c=i(c)),A[x]=c}}};
!function(e){function t(o){if(n[o])return n[o].exports;var a=n[o]={exports:{},id:o,loaded:!1};return e[o].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){"use strict";L.Control.BackwardCompat=L.Control.extend({options:{position:"bottomright"},_lang:{sv:{btnLabel:"Ett exempel"},en:{btnLabel:"An example"}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e)},onAdd:function(e){return this.map=e,this._container=L.DomUtil.create("div","leaflet-control-BackwardCompat"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),smap.event.on("smap.core.beforeapplyparams",this._onBeforeApplyParams),this._container},onRemove:function(e){smap.event.off("smap.core.beforeapplyparams",this._onBeforeApplyParams)},_onBeforeApplyParams:function(e,t){t=t||{},delete t.FEATURES,delete t.ADDMARKER;var n=t.CENTER;if(n&&n[0]>96e3&&n[0]<215e3&&n[1]>6e6&&2===n.length){var o=utils.projectPoint(Number(n[0]),Number(n[1]),"EPSG:3008","EPSG:4326");if(t.CENTER=o.concat(n.slice(2)),void 0!==t.ZOOM&&t.ZOOM<=6){var a=parseInt(t.ZOOM);t.ZOOM=a+12}else t.POI&&(t.ZOOM=15)}t.MAPTYPE&&(t.BL=t.MAPTYPE,delete t.MAPTYPE),t.OVERLAYS&&(t.OL=t.OVERLAYS,delete t.OVERLAYS),t.ZOOMLEVEL&&(t.ZOOM=t.ZOOMLEVEL,delete t.ZOOMLEVEL)}})}]);
!function(e){function t(r){if(o[r])return o[r].exports;var i=o[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};L.Control.Editor=L.Control.extend({options:{position:"bottomright",useProxy:!1,reverseAxis:!1,encodeKeys:null,saveOnPressEnter:!1},_lang:{sv:{dTitle:"Objektets attribut",close:"Avbryt",save:"Spara",remove:"Ta bort",move:"Flytta",editProps:"Ändra",moveLP:"Ändra geometri",editPropsLP:"Ändra attribut",ruSureRemove:"Ta bort objektet? Åtgärden kan inte ångras.",saveNewMarker:"Spara",saveMove:"Spara",undo:"Ångra",cancel:"Avbryt"},en:{dTitle:"Object attributes",close:"Cancel",save:"Save",remove:"Remove",move:"Move",editProps:"Edit",moveLP:"Edit geometry",editPropsLP:"Edit attributes",doYouWantTo:"Do you want to",cannotBeUndoed:"Cannot be undoed",ruSureRemove:"Remove feature? Cannot be undoed.",saveNewMarker:"Save",saveMove:"Save",undo:"Undo",cancel:"Cancel"}},_geomTypes:{POINT:"marker",MULTIPOINT:"marker",LINESTRING:"polyline",MULTILINESTRING:"polyline",POLYGON:"polygon",MULTIPOLYGON:"polygon"},_geomType:"marker",_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode),this._inserts=[],this._updates=[],this._deletes=[]},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-editor"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawModal();var t=this;return smap.event.on("smap.core.pluginsadded",function(){t._setEditableLayer()}),this._container},onRemove:function(e){},_addBtnAdd:function(){var e=this,t=$(".smap-editor-btnadd");if(!t.length){var t=$('<button class="btn btn-default btn-lg smap-editor-btnadd"><i class="glyphicon glyphicon-plus"></i></button>');$(".leaflet-top.leaflet-left").prepend(t),t.on("click touchend",function(){var t=e._getDrawToolbar();return $(this).toggleClass("btn-danger"),$(this).hasClass("btn-danger")?(t.handler.type&&"marker"===t.handler.type&&(e._onTouchHold=e._onTouchHold||function(o){var r=t.handler;e._tooltip=e._tooltip||{updatePosition:function(){}},r._onMouseMove({latlng:o.latlng}),r._onClick({latlng:o.latlng})},e.map.on("click",e._onTouchHold,e)),t.handler.enable()):(utils.isTouchOnly()&&t.handler.type&&"marker"===t.handler.type&&(e.map.off("click",e._onTouchHold,e),$("#smap-editor-uglyhackconfirm").remove()),t.handler.disable()),!1})}},_setEditableLayer:function(){function e(e){if($(this).parent().hasClass("list-group-item-danger"))n.stopEditing();else{var t=$(this).data("t")||{};t=$.extend(!0,{},t),"L.GeoJSON.WFS"===t.init?n.startEditing(t,$(this).parent()):void 0}return!1}var t,o,r,i=smap.config.ol||[],a=smap.cmd.getControl("LayerSwitcher");if(!a)return!1;for(var n=this,s=0,d=i.length;d>s;s++)t=i[s],r=$('<i class="fa fa-edit smap-editor-switcher-icon"></i>'),t.options.isEditable&&(o=$("#"+a._makeId(t.options.layerId)),o.append(r),r.data("t",t),r.on("click",e))},_disabledRowClick:function(e){return e.stopPropagation(),e.preventDefault(),$(e.target).hasClass("smap-editor-switcher-icon")?$(".smap-editor-switcher-icon").trigger("click"):($(e.target).tooltip("show"),setTimeout(function(){$(e.target).tooltip("hide")},2e3)),!1},stopEditing:function(){if(this._editLayer){this._editLayer.options.editable=!1;var e=this._editLayer.options.layerId,t=e.substring(0,e.length-"-edit".length),o=smap.cmd.getLayer(t);o&&o.clearLayers&&o.clearLayers(),o&&o._refresh&&o._refresh({force:!0}),this.map.removeLayer(this._editLayer)}return $(".lswitch-panel-ol .list-group-item").off("click",this._disabledRowClick).removeClass("list-group-item-danger"),$(".lswitch-panel-ol .list-group-item").tooltip("destroy"),this.map.off("draw:created"),this.map.off("popupopen",this.__onPopupOpen),$(".smap-editor-btnadd").remove(),!0},_validateConfig:function(e){e=e||{};var t=e.options||{},o=[];for(var r in this._geomTypes)o.push(r);return t.geomType?-1===$.inArray(t.geomType.toUpperCase(),o)?!1:!0:!1},startEditing:function(e,t){function o(e){var t=e.layer.jsonData.features||[];if(t.length)r.options.geomType=r._geomType=r._geomTypes[e.layer.options.geomType.toUpperCase()],r._geomType||void 0;else{var o=e.layer.options.geomType;o?r._geomType=r._geomTypes[o.toUpperCase()]:void 0}}var r=this,i=this.map;if(this.stopEditing()!==!0)return!1;if(this._addBtnAdd(),r._tooltip=r._tooltip||{updatePosition:function(){}},$(".lswitch-panel-ol .list-group-item.active").trigger("tap"),$(".lswitch-panel-ol .list-group-item-danger").removeClass("list-group-item-danger"),$(".lswitch-panel-ol .list-group-item").tooltip({title:"Redigering är aktiv. Deaktivera redigering för att tända lagret.",trigger:"manual",placement:"right",container:"#maindiv"}).on("click",this._disabledRowClick),t.addClass("list-group-item-danger"),this._validateConfig(e)===!1)return!1;var a=$.extend({},e.options),n=a.params.typeName;a.url=e.url,a.featureNS=n.split(":")[0],a.featureType=n.split(":")[1],a.layerId=a.layerId+"-edit";var s=a.geomType.toUpperCase(),d="POINT"===s?this.lang.move:this.lang.moveLP,l="POINT"===s?this.lang.editProps:this.lang.editPropsLP,p=this.lang.remove;a.popup='${*}<div class="popup-divider"></div><div style="white-space:nowrap;min-width:25em;" class="btn-group btn-group-sm editor-popup-edit"><button id="editor-popup-edit" type="button" class="btn btn-default">'+l+'</button><button id="editor-popup-move" type="button" class="btn btn-default">'+d+'</button><button id="editor-popup-remove" type="button" class="btn btn-default">'+p+"</button></div>",this._editLayer=L.wfst(e.url,a),this._editLayer.options.editing=this._editLayer.options.editing||{},this._editLayer.on("wfst:savesuccess",function(){smap.cmd.loading(!1)}),this._editLayer.on("wfst:saveerror",function(){smap.cmd.loading(!1)}),this._editLayer.on("wfst:ajaxerror",function(){smap.cmd.loading(!1)}),i.addLayer(this._editLayer),this._drawControl=new L.Control.Draw({edit:{featureGroup:this._editLayer}}),i.addControl(this._drawControl),$(".leaflet-draw").remove(),this._editLayer.on("load",o),i.on("draw:created",function(e){$(".smap-editor-btnadd").removeClass("btn-danger"),r._editLayer.addLayer(e.layer),r._marker=e.layer,r._showSaveToolbar("insert")}),this.__onPopupOpen=this.__onPopupOpen||$.proxy(this._onPopupOpen,this),this.map.on("popupopen",this.__onPopupOpen)},_getLayerById:function(e,t){function o(a){var n=a._layers||{};if(!n)return null;if(n.hasOwnProperty(t))return{marker:n[t],markerGeometry:n[t]};var s,d;for(d in n)if(0===i&&(r=d),i+=1,s=o(n[d]),i-=1,s)return{marker:e._layers[r],markerGeometry:s.marker};return null}var r,i=0;return o(e)},_onPopupOpen:function(e){var t=this;if(this._marker&&this._marker.dragging&&this._marker.dragging._draggable&&this._marker.dragging._draggable._enabled){if(this.map.closePopup(),confirm("Do you to stop editing this feature? Any changes made to the feature will be removed.")!==!0)return;this.cancelEdit()}var o=$(e.popup._container);if(e.popup._source.feature&&"polyline"!=this._geomType)this._marker=e.popup._source,this._markerGeometry=null;else{var r=this._getLayerById(this._editLayer,e.popup._source._leaflet_id);this._marker=r.marker,this._markerGeometry=e.popup._source}o.find("#editor-popup-remove").on("click",function(){return confirm(t.lang.ruSureRemove)===!0&&t._editLayer.wfstRemove(t._marker).done(function(){t._editLayer.clearLayers(),t._editLayer._refresh({force:!0})}),!1}),o.find("#editor-popup-move").on("click",function(){t.map.closePopup();var e=t._getEditToolbar();return e.handler._enableLayerEdit(t._markerGeometry||t._marker),t._showSaveToolbar("update"),t._editLayer.options.editable=!0,!1}),o.find("#editor-popup-edit").on("click",function(){return t._modalEdit.modal("show"),!1})},_getEditToolbar:function(){var e;for(var t in this._drawControl._toolbars)if(e=this._drawControl._toolbars[t],e&&e._modes&&e._modes.edit)return e._modes.edit;return null},_getDrawToolbar:function(){var e;for(var t in this._drawControl._toolbars)if(e=this._drawControl._toolbars[t],e&&e._modes&&e._modes[this._geomType])return e._modes[this._geomType];return null},wfstSave:function(e){e=e?L.Util.isArray(e)?e:[e]:[];var t,r,i=[],a=this._editLayer;for(r=0,len=e.length;r<len;r++)if("object"==o(e[r]._layers))for(t in e[r]._layers)smap.cmd.loading(!0),i.push(a._wfstSave(e[r]._layers[t]));else i.push(a._wfstSave(e[r]));return $.when.apply($,i)},save:function(e){e=e||null;var t,o,r=this._inserts,i=this._updates,a=this._editLayer,n=r.length;for(t=0;n>t;t++)o=r[t],a._wfstAdd(o).done(function(){r.splice(o,1),e&&e()});for(n=i.length,t=0;n>t;t++)o=i[t],this.wfstSave(o).done(function(){i.splice(o,1)})},cancelEdit:function(){var e=this._getEditToolbar();e.handler._disableLayerEdit(this._markerGeometry||this._marker),this._editLayer.clearLayers(),this._editLayer._refresh({force:!0}),this._hideSaveToolbar()},_showSaveToolbar:function(e){if(this._editType=e,!this._saveToolbar){var t=this;this._saveToolbar=$('<div class="smap-editor-savetoolbar btn-group btn-group-lg" />');var o=$('<button class="btn btn-success">Save</button>'),r=$('<button class="btn btn-default">Cancel</button>');this._saveToolbar.append(r).append(o),$(".leaflet-top.leaflet-left").append(this._saveToolbar),o.on("click",function(){if(t._marker.options.geomType=t._editLayer.options.geomType.toUpperCase(),"update"===t._editType){var e=t._marker.options.geomType;"POINT"===e||"POLYGON"===e?t.wfstSave(t._marker):(t._markerGeometry.feature=$.extend({},t._marker.feature),t.wfstSave(t._markerGeometry))}var o=t._getEditToolbar();return o.handler._disableLayerEdit(t._markerGeometry||t._marker),"insert"===t._editType?(t._inserts.push(t._marker),t.save(function(){t._editLayer.clearLayers(),t._editLayer._refresh({force:!0}),t._hideSaveToolbar()})):"update"===t._editType&&(t.save(),t._hideSaveToolbar()),!1}),r.on("click",function(){return t.cancelEdit(),!1})}var i="insert"==this._editType?this.lang.saveNewMarker:this.lang.saveMove,a=this.lang.cancel;this._saveToolbar.find("button:eq(0)").text(a),this._saveToolbar.find("button:eq(1)").text(i),this._saveToolbar.show()},_hideSaveToolbar:function(){this._saveToolbar.hide()},_fillModal:function(e){if(e=e||null,null===e)return!1;var t,o,r,i,a=this._modalEdit.find("#smap-editor-content"),n=$('<form role="form" />'),s=this.options.encodeKeys||[];for(t in e)"fid"!==t&&"id"!==t&&"gid"!==t&&(o=e[t],o=o||"",("*"===s||$.inArray(t,s)>-1)&&(o=decodeURIComponent(o)),i="smap-editor-propentry-"+t,r='<div class="form-group">						<label for="'+i+'">'+t+'</label>						<textarea rows="1" resizable name="'+t+'" class="form-control" id="'+i+'">'+o+"</textarea>					</div>",n.append(r));n.find("textarea").on("change",function(){$(this).addClass("changed")}).on("focus",function(){$(this).prop("rows",5)}).on("blur",function(){$(this).prop("rows",1)}),a.append(n)},_onSaveAttributesSuccess:function(e){this._marker.fire("click")},_saveAttributes:function(){var e=this._marker.feature.properties,t={},o=this._modalEdit.find("form").find("textarea.changed");if(!o.length)return this._modalEdit.modal("hide"),!1;var r,i,a=this.options.encodeKeys||[];o.each(function(){r=$(this).attr("name"),i=$(this).val(),("*"===a||$.inArray(r,a)>-1)&&(i=encodeURIComponent(i)),t[r]=i});var n=$.extend({},e,t);this._marker.feature.properties=n,this._marker.toGML||(this._markerGeometry.feature=$.extend({},this._marker.feature)),this.__onSaveAttributesSuccess=this.__onSaveAttributesSuccess||$.proxy(this._onSaveAttributesSuccess,this),this._editLayer.off("wfst:savesuccess",this.__onSaveAttributesSuccess).on("wfst:savesuccess",this.__onSaveAttributesSuccess),this._editLayer._wfstSave(this._markerGeometry||this._marker,{newProps:t}),this._modalEdit.modal("hide"),this.map.closePopup()},_drawModal:function(){var e=this,t=$('<div id="smap-editor-content" />'),o='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+'</button><button id="smap-editor-editmodal-btnsave" type="button" class="btn btn-primary">'+this.lang.save+"</button>";this._modalEdit=utils.drawDialog(this.lang.dTitle,t,o,{}),this._modalEdit.find("#smap-editor-editmodal-btnsave").on("click",function(){return e._saveAttributes(),!1}),this._modalEdit.on("shown.bs.modal",function(){var t=e._marker.feature.properties;e._fillModal(t),e.options.saveOnPressEnter&&e._modalEdit.on("keypress",function(t){13===t.which&&($("#smap-editor-editmodal-btnsave").focus(),e._saveAttributes(),e._modalEdit.modal("hide"),t.preventDefault())})}),e._modalEdit.on("hidden.bs.modal",function(){t.empty(),e._modalEdit.off("keypress")})}})}]);
!function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){"use strict";L.Control.FullScreen=L.Control.extend({options:{position:"topright",url_root:location.origin+location.pathname+"?",fs_button:function(){var e=location.search;return e.substring(e.indexOf("fs")+3)}(),controlToAdd:!1,mode:"full"},_properties:function(){var e=this,t=this.lang;switch(this.options.mode){case"replace":return{expand:"fa fa-expand",compress:"fa fa-compress",expTitle:t.viewLarge,compTitle:t.back,action:function(){window.parent.location.href=smap.cmd.createParams(e.options.url_root)+"&fs=back"}};case"newTab":return{expand:"fa fa-external-link",compress:"fa fa-times",expTitle:t.newTab,compTitle:t.close,action:function(){window.open(smap.cmd.createParams(e.options.url_root)+"&fs=close")}};case"full":return{expand:"fa fa-expand",compress:"fa fa-compress",expTitle:t.fullExp,compTitle:t.reset,action:function(){if(screenfull.enabled&&(screenfull.toggle(),navigator.userAgent.indexOf("Trident/7.")>-1)){var e=$("body")[0];e.style.width=screen.width+"px",e.style.height=screen.height+"px"}}}}},_lang:{sv:{viewLarge:"Visa större karta",newTab:"Öppna kartan i ny flik",fullExp:"Visa kartan i fullskärm",reset:"Återställ",back:"Tillbaka",close:"Stäng kartan",notAllowed:"Helskärmsläge stöds eller tillåts inte av din webläsare. Funktionen kommer inte vara tillgänglig"},en:{viewLarge:"Show larger map",newTab:"Open map in new tab",fullExp:"Show in fullscreen",reset:"Reset",back:"Go back",close:"Close the map",notAllowed:"Fullscreen mode not supported/allowed by your browser. Feature will not be available."}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(e.langCode),("close"===this.options.fs_button||"back"===this.options.fs_button)&&smap.core.pluginHandlerInst.addPlugins([this.options.controlToAdd])},onAdd:function(e){this.map=e;var t=this;return this._container=L.DomUtil.create("div","leaflet-control-fullScreen"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),"full"===this.options.mode?this._enableIframeFullscreen()&&screenfull.enabled?(this._createBtn(),document.addEventListener(screenfull.raw.fullscreenchange,function(){t._updateButton()})):void 0:this._createBtn(),this._container},activate:function(){this._properties().action()},_enableIframeFullscreen:function(){if(self===top)return!0;try{var e=window.parent.document.getElementsByTagName("iframe")[0];return e.setAttribute("allowfullscreen",""),!0}catch(t){return!1}},_updateButton:function(){var e=$("#smap-fullscreen-btn"),t=this._properties();screenfull.isFullscreen?(e.find("span").removeClass(t.expand).addClass(t.compress),e.attr("data-original-title",t.compTitle)):(e.find("span").removeClass(t.compress).addClass(t.expand),e.attr("data-original-title",t.expTitle)),e.blur()},onRemove:function(e){},_createBtn:function(){var e=this,t={title:e._properties().expTitle,icon:e._properties().expand,action:e._properties().action};"back"===e.options.fs_button?t={title:e._properties().compTitle,icon:e._properties().compress,action:function(){history.back()}}:"close"===e.options.fs_button&&(t={title:e._properties().compTitle,icon:e._properties().compress,action:function(){window.close()}}),this.$btn=$('<button id="smap-fullscreen-btn" title="'+t.title+'" class="btn btn-default"><span class="'+t.icon+'"></span></button>'),this.$btn.on("click",function(){return t.action(),this.blur(),!1}),this.$container.append(this.$btn)}}),L.control.fullScreen=function(e){return new L.Control.FullScreen(e)}}]);
!function(t){function o(i){if(n[i])return n[i].exports;var a=n[i]={exports:{},id:i,loaded:!1};return t[i].call(a.exports,a,a.exports,o),a.loaded=!0,a.exports}var n={};return o.m=t,o.c=n,o.p="",o(0)}([function(t,o){"use strict";L.Control.Geolocate=L.Control.extend({options:{position:"bottomright",hoverTooltip:!0,locateOptions:{maxZoom:17,enableHighAccuracy:!0}},_lang:{sv:{errorGeolocate:"Kunde inte hitta din position",notSupported:"Din webbläsare stödjer inte geolokalisering",hoverTooltip:"Hitta din position"},en:{errorGeolocate:"The browser could not detect your position",notSupported:"Your browser does not support geolocation",hoverTooltip:"Find your current location"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-Geolocate"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawButton(),this._container},onRemove:function(t){},_drawButton:function(){var t=$('<button id="smap-glocate-btn" class="btn btn-default"><span class="fa fa-location-arrow"></span></button>');this.$container.append(t),this.btn=t,t.on("touchstart click",$.proxy(function(){return this.active?this.deactivate():this.activate(),!1},this)),this.options.hoverTooltip&&(t.parent().data("bs.tooltip")||t.parent().tooltip({title:this.lang.hoverTooltip,trigger:"hover",placement:"left"}))},activate:function(){return this.active?!1:navigator.geolocation?(this.active=!0,this.btn.addClass("btn-primary"),smap.cmd.loading(!0),this.__onLocationFound=this.__onLocationFound||$.proxy(this._onLocationFound,this),this.__onLocationError=this.__onLocationError||$.proxy(this._onLocationError,this),this.__onDragStart=this.__onDragStart||$.proxy(this._onDragStart,this),this.map.on("locationfound",this.__onLocationFound),this.map.on("locationerror",this.__onLocationError),this.map.on("dragstart",this.__onDragStart),this.map.on("zoomstart",this.__onDragStart),void this._startLocate(this.options.locateOptions)):(smap.cmd.notify(this.lang.notSupported,"error"),!1)},deactivate:function(){return this.active?(this.active=!1,smap.cmd.loading(!1),this.btn.removeClass("btn-primary"),this.map.off("locationfound",this.__onLocationFound),this.map.off("locationerror",this.__onLocationError),this.map.off("dragstart",this.__onDragStart),this.map.off("zoomstart",this.__onDragStart),this._stopLocate(),void(this.marker&&(this.map.removeLayer(this.marker),this.marker=null))):!1},_startLocate:function(t){t=t||{};var o={watch:!0,setView:!0,enableHighAccuracy:!1};t=$.extend(o,t),this.map.locate(t)},_stopLocate:function(){this.map.stopLocate()},_onLocationFound:function(t){smap.cmd.loading(!1),this.marker=this.marker||L.userMarker(t.latlng,{pulsing:!0}).addTo(this.map),this.marker.setLatLng(t.latlng),this.marker.setAccuracy(t.accuracy)},_onLocationError:function(t){smap.cmd.loading(!1);var o=smap.cmd.notify(this.lang.errorGeolocate+": "+t.message,"error",{parent:$("body")});o.on("touchstart",function(){$("body").find(".alert").remove()}),this.deactivate()},_onDragStart:function(){this._stopLocate(),this._startLocate({setView:!1})}}),L.control.geolocate=function(t){return new L.Control.Geolocate(t)}}]);
!function(i){function e(o){if(t[o])return t[o].exports;var n=t[o]={exports:{},id:o,loaded:!1};return i[o].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var t={};return e.m=i,e.c=t,e.p="",e(0)}([function(i,e){"use strict";L.Control.GuidePopup=L.Control.extend({options:{},initialize:function(i){L.setOptions(this,i),this._setLang()},_lang:{sv:{introHeader:"Info",mediaHeader:"Media",accessHeader:"Tillgänglighet",close:"Stäng",showMore:"Visa mer",clickToSee:"Klicka för mer info",loadingPic:"Hämtar bild",tipClickForFullScreen:"Klicka för fullskärmsbild"},en:{introHeader:"About",mediaHeader:"Media",accessHeader:"Accessibility",close:"Close",showMore:"Read more",loadingPic:"Loading photo",clickToSee:"Click for more info",picFullScreenTitle:"Slideshow",tipClickForFullScreen:"Click for full-screen photo"}},_setLang:function(i){i=i||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[i]:null)},onAdd:function(i){this.map=i,this._container=L.DomUtil.create("div","leaflet-control-guidepopup"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.__onPopupClick=this.__onPopupClick||$.proxy(this._onPopupClick,this);var e=this;return e._activate(),this._container},onRemove:function(i){this._deactivate(),windowWidth<950?this.hideTheTag():this.showTheTag()},_onPopupClick:function(i){var e=$("#gp-btn-show").data("props"),t=this._getFeatureData(e[this.options.attrId]),o=t.tabMedia,n=t.tabIntro;if(n)this.createPopup(e);else if(o&&o instanceof Object){var a,s=this._makeMediaContent(o.mediaType,utils.extractToHtml(o.sources,e).split(","));"image"!==t.mediaType&&(a=utils.extractToHtml(t.fullScreenIntroPic,e)),this.showFullScreen(s,utils.extractToHtml(o.label,e),a)}return($(i.target).hasClass("gp-mediaicons")||$(i.target).parent().hasClass("gp-mediaicons"))&&$('[href="#gp-moreinfo"]').click(),!1},_onPopupOpen:function(i){if(i.popup._source&&i.popup._source.feature){var e=(i.popup._source.feature.layerId,i.popup._source.feature.properties);i.popup.options.autoPanPaddingTopLeft=[0,60],$(".leaflet-popup-content").find(".gp-mediaicons").on("touchstart click",this.__onPopupClick);var t=this._getFeatureData(e[this.options.attrId]);if(t&&t instanceof Object){var o=$('<button style="margin-top:10px;" id="gp-btn-show" class="btn btn-default">'+this.lang.showMore+"</button>");$(".leaflet-popup-content").append(o),o.data("props",e),o.on("touchstart click",this.__onPopupClick),$(".leaflet-popup-content img").on("touchstart click",this.__onPopupClick).css("cursor","pointer").tooltip({title:this.lang.clickToSee})}}},_onPopupClose:function(i){$(i.popup._wrapper).off("touchstart",this.onPopupClick)},_activate:function(){for(var i,e=this,t={audio:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/120-headphones.png",iconSize:[22,21],iconAnchor:[11,10],popupAnchor:[0,-8]})},video:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/46-movie-2.png",iconSize:[20,25],iconAnchor:[10,12],popupAnchor:[0,-9]})},image:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/121-landscape.png",iconSize:[22,21],iconAnchor:[11,10],popupAnchor:[0,-8]})}},t={audio:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/120-headphones.png",iconSize:[22,21],iconAnchor:[11,10],popupAnchor:[0,-8]})},video:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/46-movie-2.png",iconSize:[20,25],iconAnchor:[10,12],popupAnchor:[0,-9]})},image:{icon:L.icon({iconUrl:"img/glyphish-icons/PNG-icons/121-landscape.png",iconSize:[22,21],iconAnchor:[11,10],popupAnchor:[0,-8]})}},o=smap.config.ol||[],n=0,a=o.length;a>n;n++)i=o[n].options,i.params&&i.params.q&&(i.pointToLayer=function(i,o){var n=i.properties||{},a=e.options.modalContentOverrides[n[e.options.attrId]]||{};return a.tabMedia,a.iconType&&t[a.iconType]?L.marker(o,t[a.iconType]):L.marker(o)});this.map.on("popupopen",this._onPopupOpen,this),this.map.on("popupclose",this._onPopupClose,this)},_deactivate:function(){this.map.off("popupopen",this.__onPopupOpen),this.map.off("popupclose",this.__onPopupClose)},_makeCarousel:function(i){i=i||[];for(var e,t=$('<div id="guide-carousel" class="carousel slide">'),o=$('<ol class="carousel-indicators" />'),n=$('<div class="carousel-inner" />'),a=$('<a class="left carousel-control" href="#guide-carousel" data-slide="prev"><span class="icon-prev"></span></a><a class="right carousel-control" href="#guide-carousel" data-slide="next"><span class="icon-next"></span></a>'),s=0,r=i.length;r>s;s++)e=i[s],o.append('<li data-target="#guide-carousel" data-slide-to="'+s+'"></li>'),n.append('<div class="item"><img src="'+e+'"></img></div>');return n.find(".item:first").add(o.find("li:first")).addClass("active"),t.append(n),i.length>1&&(t.prepend(o),t.append(a),t.swiperight(function(){$(this).carousel("prev")}).swipeleft(function(){$(this).carousel("next")})),$(document).on("orientationchange",function(){var i=window.innerHeight;$(".gp-fullscreen").height(i)}),t},_makeAudioTag:function(i){i=i||[];for(var e,t,o,n,a=$('<audio controls="controls" />'),s=0,r=i.length;r>s;s++){switch(e=i[s],t=e.substring(e.length-3).toUpperCase()){case"OGG":o="audio/ogg";break;case"MP3":o="audio/mpeg"}n='<source src="'+e+'" type="'+o+'" />',a.append(n)}return a},_makeVideoTag:function(i){i=i||[];var e=$(window).width()-2,t=$(window).height()-65;if(t>e){var o=e;e=t,t=o}t/=2,e/=2;var n,a=i[0];return a.search(/youtu.be|youtube/i)>-1?n=$('<iframe src="'+a+'?rel=0" width="100%" height="80%" frameborder="0" allowfullscreen></iframe>'):a.search(/vimeo.com/i)&&(n=$('<iframe src="'+a+'" width="100%" height="80%" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>')),n},_makeAccessContent:function(i){var e=this._getFeatureData(i[this.options.attrId]);return utils.extractToHtml(e.tabAccess,i)},_makeMediaList:function(i,e){if(i=i||[],!i.length)return null;var t,o,n,a={image:"fa fa-picture-o fa-lg",audio:"fa fa-volume-up fa-lg",video:"fa fa-film fa-lg"},s=$('<div id="gp-listmoreinfo" class="list-group" />');for(o=0,len=i.length;o<len;o++)t=i[o],(!t.condition||t.condition&&t.condition(e)===!0)&&(n=$('<a href="#" class="list-group-item"><span class="'+a[t.mediaType]+'"></span>&nbsp;&nbsp;&nbsp;'+utils.extractToHtml(t.label,e)+"</a>"),n.data("mediaType",o),s.append(n));return s.children().length?s:null},showFullScreen:function(i,e,t){function o(i){27===i.which&&n()}function n(){return $("body").off("keydown",o),$(".gp-fullscreen").removeClass("gp-fs-visible"),$(".gp-fullscreen").find("audio").each(function(){this.pause&&this.pause()}),setTimeout(function(){$(".gp-fullscreen").empty().remove()},500),!1}var a=$('<div class="gp-fullscreen"></div>');$("body").on("keydown",o);var s=$('<button type="button" class="btn btn-default">Stäng</button>');s.on("click",function(){return n(),!1});var r="<h1>"+e+"</h1>";if(a.append(r),t){var c=$('<img class="gp-mediapic" src="'+t+'" />');a.append(c)}a.append(i),a.append(s),s.css("z-index",3e3),$("body").append(a),setTimeout(function(){a.addClass("gp-fs-visible")},50)},_makeMediaContent:function(i,e){switch(i.toLowerCase()){case"image":content=this._makeCarousel(e);break;case"audio":content=this._makeAudioTag(e);break;case"video":content=this._makeVideoTag(e)}return content},_getFeatureData:function(i){var e=this.options.modalContentOverrides[i]||{};return $.extend(!0,{},this.options.modalContent||{},e)},createPopup:function(i){function e(e){var o,a=$(this).data("mediaType"),s=n.tabMedia[a],r=utils.extractToHtml(s.sources,i),c=t._makeMediaContent(s.mediaType,r.split(","));return"audio"===s.mediaType&&(o=utils.extractToHtml(n.fullScreenIntroPic,i)),t.showFullScreen(c,$(this).text(),o),!1}i=i||{};var t=this,o='<ul class="nav nav-tabs"><li class="active"><a href="#gp-intro" data-toggle="tab">'+this.lang.introHeader+'</a></li><li><a href="#gp-moreinfo" data-toggle="tab">'+this.lang.mediaHeader+'</a></li><li><a href="#gp-access" data-toggle="tab">'+this.lang.accessHeader+'</a></li></ul><div class="tab-content gp-popup"><div class="tab-pane active" id="gp-intro"></div><div class="tab-pane" id="gp-moreinfo"></div><div class="tab-pane" id="gp-access"></div></div>';o=$(o);var n=this._getFeatureData(i[this.options.attrId]),a=this._makeMediaList(n.tabMedia,i);a?o.find("#gp-moreinfo").append(a):o.find('[href="#gp-moreinfo"], #gp-moreinfo').remove();var s=this._makeAccessContent(i);s?o.find("#gp-access").append(s):o.find('[href="#gp-access"], #gp-access').remove();var r=utils.extractToHtml(n.dialogTitle||i[this.options.dialogTitle],i),c='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>";if(this.dialog=utils.drawDialog(r,o,c),this.dialog.on("hidden.bs.modal",function(){$(this).empty().remove(),t.dialog=null,delete t.dialog}),this.dialog.attr("id","gp-popup"),this.dialog.find("#gp-listmoreinfo").find(".list-group-item").on("tap click",e),$("body").append(this.dialog),this.dialog.modal(),n.tabIntro){var p=utils.extractToHtml(n.tabIntro,i);if("HTTP"===p.substring(0,4).toUpperCase())this._getData(p,function(){$("#gp-intro").append(utils.extractToHtml($(this).html(),i)),smap.cmd.loading(!1)});else{var l=$("<div />").append(p);l.find("img").each(function(){utils.addImageLoadIndicator($(this),{height:"150px"})}),l.find("img").on("click tap",function(){var i=t._makeCarousel([$(this).prop("src")]);t.showFullScreen(i,r)}).prop("title",this.lang.tipClickForFullScreen).tooltip(),$("#gp-intro").append(l)}}},_getData:function(i,e){var t=$("<div />");smap.cmd.loading(!0),i=this.options.useProxy?smap.config.ws.proxy+encodeURIComponent(i):i,t.load(i,e)}}),L.control.guidePopup=function(i){return new L.Control.GuidePopup(i)}}]);
!function(t){function e(s){if(i[s])return i[s].exports;var o=i[s]={exports:{},id:s,loaded:!1};return t[s].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e){"use strict";L.Control.Helper=L.Control.extend({options:{autoActivate:!1,position:"topright",steps:[{title:"Welcome to Malmö Stadsatlas!",description:'<p>Would you like to take a little tour?</p><div class="smap-helper-button-group smap-helper-tour-or-not" style="text-align: left; font-size:1.5em;"><div class="smap-helper-button"><i class="fa fa-close"></i><span> No</span></div><div class="smap-helper-button" style="margin-left: 10px;"><span>Yes </span><i class="fa fa-check"></i></div></div>',noNav:!0,func:function(){var t=this._$stepContainer.find(".smap-helper-tour-or-not"),e=t.find(".smap-helper-button:eq(0)"),i=t.find(".smap-helper-button:eq(1)"),s=this;e.on("click",function(){return s.deactivate(),!1}),i.on("click",function(){return s.goToNextStep(),!1}),t.addClass("smap-helper-fadein")}},{title:"Toggle button",description:"To hide the switcher you can press this button.",breakPoint:991,bbox:{selector:".lswitch-btnhide",mobileSelector:!1},css:{side:"right"}},{title:"Layer switcher",description:"The layer switcher is not visible from start on mobile devices. Try making the window smaller and notice that the switcher hides. You can then show it by clicking the expand button in the lower left section of the map.",breakPoint:991,bbox:{selector:".lswitch-panel .panel",mobileSelector:"#lswitch-btn"},css:{side:"right",mobileSide:"bottom"},func:function(){}},{title:"Search functionality",description:"The search functionality is vast. You can search for Malmö addresses or a place like Turning Torso, or Zlatans home.",bbox:{selector:"#smap-search-div"},css:{side:"bottom"}},{title:"Tools",description:"These are the basic tools for map navigation",bbox:{selector:".leaflet-bottom.leaflet-right"},css:{side:"top"}},{title:"Masthead",description:"Left",bbox:{selector:"#malmo-masthead"},css:{side:"bottom"}},{title:"Search again",description:"The search functionality is vast. You can search for Malmö addresses or a place like Turning Torso, or Zlatans home.",bbox:{selector:"#smap-search-div"},css:{side:"bottom"}},{title:"That's it",description:'<p>If you have questions, please contact stadsatlas@malmo.se</p><div id="smap-helper-done" class="smap-helper-button" style="font-size:1.5em;"><span>Done </span><i class="fa fa-check"></i></div>',noNav:!0,func:function(){var t=this;$("#smap-helper-done").on("click",function(){return t.deactivate(),!1})}}]},_lang:{sv:{btnLabel:"Hjälp"},en:{btnLabel:"Help"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){this.map=t,this._container=L.DomUtil.create("div","leaflet-control-helper"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn();var e=this;return this._refresh=function(){setTimeout(function(){e.refresh()},500)},this._container},onRemove:function(t){},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-helper-btn" title="'+t.lang.btnLabel+'" class="btn btn-default"><span class="fa fa-question"></span></button>'),this.$btn.on("touchend click",function(){return t.activate(),!1}),this.$container.append(this.$btn)},activate:function(){return this._active&&this._active===!0?this.deactivate():(this._active=!0,this._nbr=0,this._prevNbr=0,this._drawBasic(),this._bindEvents(),this.goToStep(1),$(this._bgCanvas).addClass("smap-helper-fadein"),void $(window).on("resize",this._refresh))},deactivate:function(){if(this._active===!1)return!1;this._active=!1;var t=this;this._$btnClose.remove(),this._$btnClose=null,this._$clickTip.popover("destroy"),this._$clickTip.empty().remove(),this._$clickTip=null,t._$stepContainer.empty().remove(),t._$stepContainer=null,$(this._bgCanvas).removeClass("smap-helper-fadein"),setTimeout(function(){$(t._bgCanvas).remove(),t._bgCanvas=null},300),$(window).off("resize",this._refresh),this._unbindEvents()},_unbindEvents:function(){$("body").off("keydown",this.onKeyDown)},_bindEvents:function(){var t=this;this._$clickTip.find(".smap-helper-button").on("tap click",function(){var e=$(this).index();switch(e){case 0:t.goToPrevStep();break;case 1:t.goToNextStep()}return!1}),this.onKeyDown=function(e){switch(e.which){case 27:t.deactivate();break;case 37:t.goToPrevStep();break;case 38:t.goToPrevStep();break;case 39:t.goToNextStep();break;case 40:t.goToNextStep()}return!1},$("body").on("keydown",this.onKeyDown)},_drawBasic:function(){if(this._$stepContainer)return!1;var t=this;this._$btnClose=$('<div class="smap-helper-btnclose"><i class="fa fa-close"></i></div>'),$("#maindiv").append(this._$btnClose),this._$btnClose.on("tap click",function(){return t.deactivate(),!1}),this._$stepContainer=$('<div class="smap-helper-stepcont"><div class="smap-helper-steptitle"><span>The title</span></div><div class="smap-helper-stepdescription">The description</div></div>'),this._$clickTip=$('<div class="smap-helper-button-group smap-helper-clicktip"><div class="smap-helper-button smap-helper-button-icon-effect"><i class="fa fa-chevron-left"></i><span> Back</span></div><div class="smap-helper-button smap-helper-button-icon-effect"><span>Next </span><i class="fa fa-chevron-right"></i></div></div>'),$("#mapdiv").append(this._$clickTip);var e='<canvas class="smap-helper-bgcanvas" />';$("#mapdiv").append(this._$stepContainer),$("body").append(e),this._bgCanvas=$(".smap-helper-bgcanvas")[0]},_drawCanvasHole:function(t){var e=this._bgCanvas,i=e.getContext("2d");i.clearRect(0,0,e.width,e.height);var s=$(window).width(),o=$(window).height();if(t){var n=[];if(t instanceof Array)n=t;else if(t.selector){var a=15,r=t.selector,l=$(r),c=l.offset(),p=0,h=0,d=0,f=0;n.push(c.left+p-a-d),n.push(c.top+h-a-f),n.push(c.left+l.width()+p+a-d),n.push(c.top+l.height()+h+a-d)}var u=n[0],b=n[1],v=n[2],m=n[3]}e.width=s,e.height=o,i.moveTo(0,0),i.lineTo(s,0),i.lineTo(s,o),i.lineTo(0,o),i.lineTo(0,0),i.closePath(),t&&(i.moveTo(u,b),i.lineTo(u,m),i.lineTo(v,m),i.lineTo(v,b),i.lineTo(u,b),i.closePath()),i.fillStyle="rgba(0,0,0,0.5)",i.shadowColor="rgba(0,0,0,1)",i.shadowBlur=20,i.fill()},refresh:function(){this.goToStep(this._nbr)},goToStep:function(t){var e=this;if(0>=t)return!1;if(this._prevNbr=this._nbr,this._nbr=t,this._$clickTip.removeClass("smap-helper-fadein"),t>this.options.steps.length)return this.deactivate();var i=this.options.steps[t-1],s=this._$stepContainer.find(".smap-helper-steptitle"),o=this._$stepContainer.find(".smap-helper-stepdescription");s.find("span").empty().html(i.title),o.empty().html(i.description);var n;if(i.bbox&&i.bbox.selector){if(n=i.bbox.selector,i.breakPoint&&$(window).width()<=i.breakPoint&&(n=i.bbox.mobileSelector),n===!1)return this._prevNbr<this._nbr?this.goToNextStep():this.goToPrevStep();this._$stepContainer.css(i.css.standard?i.css.standard:i.css),i.css.side&&$(document).ready(function(){var t,e,s=i.css.side;i.bbox.breakPoint&&i.css.mobileSide&&$(window).width()<=i.bbox.breakPoint&&(s=i.css.mobileSide),"top"===s?(t="bottom",e=s+"-20px"):"bottom"===s?(t="top",e=s+"+20px"):"left"===s?(t="right",e=s+"-20px"):"right"===s&&(t="left",e=s+"+20px"),$(".smap-helper-stepcont").position({my:t,at:e,of:n,collision:"fit flip"})})}else $(".smap-helper-stepcont").position({my:"center",at:"center",of:"#mapdiv",collision:"fit flip"});i.css&&i.css.standard&&this._$stepContainer.css(i.css.standard),this._drawCanvasHole({selector:n}),this._showHelperTimeout&&clearTimeout(this._showHelperTimeout),i.noNav||($(".smap-helper-clicktip").popover("destroy"),this._$clickTip.show(),this._nbr>=this.options.steps.length?this._$clickTip.find(".smap-helper-button:eq(1)").hide():this._$clickTip.find(".smap-helper-button").show(),this._showHelperTimeout=setTimeout(function(){e._$clickTip.addClass("smap-helper-fadein"),utils.isTouchOnly()||e._helperPopoverShownOnce||(e._helperPopoverShownOnce=!0,$(".smap-helper-clicktip").popover({content:'Tip! Use your keyboards\' arrow keys to navigate through the help section <i class="fa fa-caret-square-o-left"><i class="fa fa-caret-square-o-up"></i><i class="fa fa-caret-square-o-right"><i class="fa fa-caret-square-o-down"></i>',html:!0,placement:"top",trigger:"manual",container:".maindiv"}).popover("show"),$(".smap-helper-clicktip").data("bs.popover").$tip.addClass("smap-helper-popover"))},950)),i.func&&i.func.call(this)},goToPrevStep:function(){this.goToStep(this._nbr-1)},goToNextStep:function(){this.goToStep(this._nbr+1)}})}]);
!function(t){function n(i){if(o[i])return o[i].exports;var a=o[i]={exports:{},id:i,loaded:!1};return t[i].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}var o={};return n.m=t,n.c=o,n.p="",n(0)}([function(t,n){"use strict";L.Control.Info=L.Control.extend({options:{addToMenu:!0,autoActivate:!0,dontShowAgainBox:!0,dateLastUpdated:"2016-03-31",daysExpired:90,position:"topright",_lang:{sv:{titleInfo:"<h4>Välkommen till smap-responsive!</h4>",bodyContent:"<p>Jag är dialogen kropp.</p>",tooltipText:"Visa info"},en:{titleInfo:"<h4>Welcome to smap-responsive!</h4>",bodyContent:"<p>I am the body of the dialog.</p>",tooltipText:"Show info"}}},_lang:{sv:{close:"Stäng",tooltipText:"Visa info",dontShowAgain:"Visa inte från start nästa gång"},en:{close:"Close",tooltipText:"Show info",dontShowAgain:"Don't show from start next time"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this.options.dateLastUpdated&&(-1===this.options.dateLastUpdated.search("T")&&(this.options.dateLastUpdated+="T00:00:00.000Z"),this._updateExpirationStatus()),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-info"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawBtn(),this._container},onRemove:function(t){},_getLocalStorage:function(){return window.localStorage?window.localStorage:!1},_updateExpirationStatus:function(){var t=this._getLocalStorage();if(!t||!t.dontShowAgain)return!1;var n=new Date(t.dontShowAgain),o=new Date(this.options.dateLastUpdated),i=new Date,a=o>n,e=this.options.daysExpired;if(!a&&"number"==typeof e){var s=(i-n)/1e3/3600/24;a=s>=e}a&&delete t.dontShowAgain},activate:function(t){t=t||!1;var n=(this.options,this._getLocalStorage());if(!t&&n&&n.dontShowAgain)return!1;if(!this._$dialog){var o=$('<div class="smap-info-footer"><button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button></div>"),i=this._drawBody(this.lang.bodyContent);o.prepend(this._createCheckbox()),this._$dialog=utils.drawDialog(this.lang.titleInfo,i,o)}this._$dialog.modal("show")},_drawBody:function(t){var n=$("<div />");return n.append(t),n},_createCheckbox:function(){var t=this.options.autoActivate&&this.options.dontShowAgainBox,n=this._getLocalStorage();if(!n)return null;if(t===!0){var o=n.dontShowAgain?!0:!1,i=$('<div class="checkbox">					<label>						<input type="checkbox"> '+this.lang.dontShowAgain+" 					</label>				</div>");i.find("input").on("change",function(){var t=$(this).is(":checked");t?n.dontShowAgain=(new Date).toISOString():delete n.dontShowAgain}).prop("checked",o)}return i},_drawBtn:function(){var t=this;if(this.options.addToMenu){var n=$('<button id="smap-info-btn" title="'+this.lang.tooltipText+'" class="btn btn-default"><span class="fa fa-info"></span></button>');n.on("touchstart click",function(){return t.activate(!0),!1}),this.$container.append(n)}}}),L.control.info=function(t){return new L.Control.Info(t)}}]);
!function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return t[i].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e){"use strict";L.Control.IntroHelp=L.Control.extend({options:{position:"topright",autoActivate:!0,_lang:{sv:{steps:[{selector:null,title:"Välkommen!",description:"Vill du ha en kort introduktion till webbkartan?",btnLeftLabel:"Nej",btnRightLabel:"Ja",btnLeftIcon:!1,btnRightIcon:!1},{selector:".thandler-btn",title:"Visa verktyg",description:"Klicka här för att visa verktygen"},{selector:".thandler-popover",title:"Verktyg",description:"Verktygen visas",beforeShow:function(t,e){var n=null;e.tagIsVisible(document.querySelector(".thandler-btn"))===!0&&e.tagIsVisible(document.querySelector(".thandler-popover"))===!1&&(document.querySelector(".thandler-btn").click(),n=300),t(n)}},{selector:".leaflet-control-RedirectClick button",title:"Starta turen",description:'Click here and then in the map to see a "Snedbild"'},{selector:".leaflet-top.leaflet-right .leaflet-control-RedirectClick",title:"Snedbild",description:'Click here and then in the map to see a "Snedbild" as we call it in Swedish'},{selector:".leaflet-control-ShareLink",title:"Share link",description:"Click here to share the current map as a link, preserving zoom, center point etc."},{selector:"#smap-search-div",title:"Search",description:"You can search for anything… limited to addresses."},{selector:".lswitch-btnhide",title:"Minimera lagermenyn",description:"Klicka här för att minimera/expandera lagermenyn"},{selector:".leaflet-control-introhelp",title:"Hjälp",description:"Du kan vid ett senare tillfälle starta guiden igen genom att klicka här"},{selector:null,title:"Klart!",description:"För frågor om webbkartan, kontakta stadsatlas@malmo.se",btnRightLabel:"Avsluta guiden",btnRightIcon:"fa fa-check"}]},en:{steps:[{selector:null,title:"Vill du ha en kort introduktion?",description:"Följ med på en tur i funktionerna i kartan"},{selector:".leaflet-control-RedirectClick",title:"Start tour",description:'Click here and then in the map to see a "Snedbild" as we call it in Swedish'},{selector:".leaflet-control-RedirectClick",title:"Snedbild",description:'Click here and then in the map to see a "Snedbild" as we call it in Swedish'},{selector:".leaflet-control-ShareLink",title:"Share link",description:"Click here to share the current map as a link, preserving zoom, center point etc."},{selector:"#smap-search-div",title:"Search",description:"You can search for anything… limited to addresses."},{selector:".lswitch-btnhide",title:"Minimera lagermenyn",description:"Klicka här för att minimera/expandera lagermenyn"}]}}},_lang:{sv:{btnLabel:"Hjälp/Introduktion"},en:{btnLabel:"Help/Introduction"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(t.langCode)},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-introhelp"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this._container},onRemove:function(t){},activate:function(t,e){var n=this;if(e=e||!1,this.active)return!1;this.active=!0;var i=$('<div class="smap-introhelp-container" />').appendTo($("#maindiv")),r=i[0];return this._myIntroGuide=initIntroGuide.introGuide(r,{steps:this.lang.steps,stepIndex:0,onStop:function(){n.deactivate()}}),this._myIntroGuide.start(),!0},deactivate:function(){return this.active?(this.active=!1,this._myIntroGuide.stop(),!0):!1},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-introhelp-btn" title="'+t.lang.btnLabel+'" class="btn btn-default"><span class="fa fa-question-circle-o"></span></button>');var t=this;this.$btn.on("click",function(){return this.activate(this.lang.steps,!0),!1}.bind(this)),this.$container.append(this.$btn)}})}]);
!function(t){function i(e){if(n[e])return n[e].exports;var s=n[e]={exports:{},id:e,loaded:!1};return t[e].call(s.exports,s,s.exports,i),s.loaded=!0,s.exports}var n={};return i.m=t,i.c=n,i.p="",i(0)}([function(t,i){"use strict";L.Control.LayerSwitcher=L.Control.extend({options:{pxDesktop:992,toggleSubLayersOnClick:!1,unfoldOnClick:!0,olFirst:!1,unfoldAll:!1,btnHide:!0,zoomToExtent:!1,showTooltip:!1,hoverTooltip:!0,showTooltipOnCollapse:!1,catIconClass:"fa fa-chevron-right",getFitBoundsOptions:function(){var t={paddingTopLeft:[0,0]};return $(".lswitch-panel:visible").length&&(t.paddingTopLeft[0]=330),t}},_lang:{sv:{baselayers:"Bakgrundslager",overlays:"Kartskikt",close:"Stäng",hide:"Göm",btnHideTooltip:"Göm lagerväljaren",btnShowTooltip:"Visa lagerväljaren",layerSwitcher:"Lagerväljare",btnToggleTooltip:"Lagerväljare"},en:{baselayers:"Baselayers",overlays:"Overlays",close:"Close",hide:"Hide",btnHideTooltip:"Hide layer switcher",btnShowTooltip:"Show layer switcher",layerSwitcher:"Layer switcher",btnToggleTooltip:"Layer switcher"}},showLayer:function(t){return smap.core.layerInst.showLayer(t)},hideLayer:function(t){smap.core.layerInst.hideLayer(t)},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"sv",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.lang)},onAdd:function(t){this.map=t,this._container=L.DomUtil.create("div","leaflet-control-LayerSwitcher"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.__onRowTap=this.__onRowTap||$.proxy(this._onRowTap,this),this.__onHeaderClick=this.__onHeaderClick||$.proxy(this._onHeaderClick,this),this.__onHeaderIconClick=this.__onHeaderIconClick||$.proxy(this._onHeaderIconClick,this),this.__onBtnDialogClick=this.__onBtnDialogClick||$.proxy(this._onBtnDialogClick,this),this.__onLegendEnter=this.__onLegendEnter||$.proxy(this._onLegendEnter,this),this.__onLegendLeave=this.__onLegendLeave||$.proxy(this._onLegendLeave,this);var i=this;if(this._moveWithCursor=function(t){$("body").find(".lswitch-legend-big").length||$("body").append(i._hoverImg),$(".lswitch-legend-big").css({left:t.pageX+10+"px",top:t.pageY-30+"px"})},this._addPanel(),this._addLayers(smap.config.bl,smap.config.ol),this.options.startOpened=!1,this.options.startOpened){var n=$("#lswitch-olcont, #lswitch-blcont");1===this.options.startOpened?n.children(".lswitch-cat").click():2===this.options.startOpened?n.children(".lswitch-cat").next().find(".lswitch-cat").click():this.options.startOpened===!0&&n.find(".lswitch-cat").click()}if(this._addBtn(),this._bindEvents(),$("#mapdiv").addClass("lswitch-panelslide"),L.Browser.android){var e=function(t){var i=0;$(t).on("touchstart",function(t){i=this.scrollTop+t.originalEvent.touches[0].pageY}),$(t).on("touchmove",function(t){this.scrollTop=i-t.originalEvent.touches[0].pageY})};e($(".lswitch-panel"))}return this._container},onRemove:function(t){},_addLayers:function(t,i){t=t||[],i=i||[];var n;if(t.length>1)for(var e=0,s=t.length;s>e;e++)n=t[e],n.options.isBaseLayer=!0,this._addRow(n);else $(".lswitch-panel-bl").hide();if(i.length>0)for(var e=0,s=i.length;s>e;e++)n=i[e],n.options.isBaseLayer=!1,n.options.showInLayerSwitcher!==!1&&this._addRow(n);else $(".lswitch-panel-ol").hide();t.length<=1&&0===i.length&&$(".lswitch-panel span").css("color","#fff"),this._setSwitcherPosition(),this.__setSwitcherPosition=this.__setSwitcherPosition||$.proxy(this._setSwitcherPosition,this),$(window).on("resize",this.__setSwitcherPosition)},_setSwitcherPosition:function(){var t=0,i=$(".lswitch-panel");i.children().each(function(){t+=$(this).outerHeight()}),t>$("#mapdiv").innerHeight()-utils.rmPx(i.css("padding-top")+20)?i.css("position","absolute"):i.css("position","relative");var n=utils.getBrowser();n.ie&&i.css("position","absolute"),utils.isTouchOnly()||n.ie&&n.ieVersion<=8||this.hidePanel(),$("#lswitch-btn:visible").length&&this.options.showTooltipOnCollapse&&!this._btnToggleTooltipShown&&this._showBtnTooltip(this.lang.btnToggleTooltip,this.options.optionShowTooltip)},_bindEvents:function(){var t=this;$("#mapdiv").on("touchstart click",$.proxy(function(){return $(window).width()<this.options.pxDesktop?(this.hidePanel(),!1):void 0},this));var i=($.proxy(this.showPanel,this),$.proxy(this.hidePanel,this));utils.isTouchOnly()&&$(window).on("orientationchange",function(){t.$panel.is(":visible")&&i()}),this.map.on("layeradd layerremove",function(i){var n=i.layer||{};if(n.options&&!n.options._silent&&n.options.layerId&&!n.feature){var e=n.options.layerId,s=t._makeId(e),o=$("#"+s),a=o.hasClass("active");o.length&&("layeradd"===i.type&&a===!1?t.onRowTap(o):"layerremove"===i.type&&a===!0&&t.onRowTap(o))}}),smap.event.on("smap.core.createparams",function(t,i){var n=smap.core.paramInst.getParams();n.LSW&&(i.lsw=n.LSW)});var n=function(){if($(window).width()>t.options.pxDesktop)return!1;var i=smap.core.paramInst.getParams();i.LSW&&1===parseInt(i.LSW)&&setTimeout(function(){$("#lswitch-btn").trigger("mousedown")},310)};smap.event.on("smap.core.pluginsadded",n)},_addBtn:function(){var t=$('<div id="lswitch-btn" class="lswitch-btn-outslided"><span class="fa fa-angle-right"></span></div>');$("#mapdiv").prepend(t),t.on("mousedown "+L.DomEvent._touchstart,$.proxy(function(){if(!this._panelIsSliding){var t=$(".lswitch-panel").hasClass("panel-visible");t?this.hidePanel():this.showPanel()}return!1},this)),t.on("dblclick",function(){return!1}),this.options.hoverTooltip&&!utils.isTouchOnly()&&(t.on("mouseenter",function(){this._isHoveringToggleBtn=!0,this._bindToggleBtnPopover(this.lang.btnToggleTooltip),$("#lswitch-btn").tooltip("show")}.bind(this)),t.on("mouseleave",function(){$("#lswitch-btn").tooltip("hide"),this._isHoveringToggleBtn=!1}.bind(this)));var i=this,n=this.options.showTooltip||!1,e=this.lang.btnToggleTooltip;setTimeout(function(){$("#lswitch-btn").removeClass("lswitch-btn-outslided"),n&&i._showBtnTooltip(e,n)},800)},_bindToggleBtnPopover:function(t){$("#lswitch-btn").data("bs.tooltip")||$("#lswitch-btn").tooltip({title:t,trigger:"manual",placement:"right"})},_showBtnTooltip:function(t,i){if($("#lswitch-btn:visible").length){this._btnToggleTooltipShown=!0;var n=this;setTimeout(function(){n._isHoveringToggleBtn||(n._bindToggleBtnPopover(t),$("#lswitch-btn").tooltip("show"),setTimeout(function(){n._isHoveringToggleBtn||$("#lswitch-btn").tooltip("destroy")},"number"==typeof i?i:3e3))},1e3)}},_addPanel:function(){var t=this,i=this;if(this.$panel=$('<div class="lswitch-panel unselectable" />'),this.$panel.on("swipeleft",$.proxy(function(){this.hidePanel()},this)),this.$panel.on("touchstart",function(){$(this).css("overflow-y","auto")}),this.$list=$('<div class="panel panel-default lswitch-panel-bl"><div class="panel-heading"><span>'+this.lang.baselayers+'</span></div><div id="lswitch-blcont" class="list-group"></div></div><div class="panel panel-default lswitch-panel-ol"><div class="panel-heading"><span>'+this.lang.overlays+'</span></div><div id="lswitch-olcont" class="list-group"></div></div>'),this.$panel.append(this.$list),this.options.olFirst&&this.options.olFirst===!0&&this.$panel.prepend(this.$panel.find(".lswitch-panel-ol")),this.options.btnHide){var n,e,s;!function(){var o=function(t,i){t.tooltip("destroy"),$(".tooltip").remove(),t.prop("title",i),t.tooltip({placement:"right",text:i,container:"#maindiv"})};n=$('<button title="'+t.lang.btnHideTooltip+'" type="button" class="lswitch-btnhide btn btn-default"><i class="fa fa-chevron-down"></i></button>'),t.$panel.find(".panel-heading:first").append(n),o(n,t.lang.btnHideTooltip),e=n.parent().text(),s=!1,n.on("tap click",function(){var t=$(this);if(s)return!1;var n="rotate-90",a=t.find("i");return a.hasClass(n)?(a.removeClass(n),$(".lswitch-panel").removeClass("lswitch-displaynone"),t.prev().text(e),setTimeout(function(){$(".lswitch-panel").removeClass("lswitch-hidden")},1),o(t,i.lang.btnHideTooltip)):(s=!0,a.addClass(n),$(".lswitch-panel").addClass("lswitch-hidden"),o(t,i.lang.btnShowTooltip),t.prev().text(i.lang.layerSwitcher),setTimeout(function(){$(".lswitch-panel").addClass("lswitch-displaynone"),s=!1},200)),!1})}()}$("#maindiv").append(this.$panel)},showPanel:function(){var t=this;if(this.$panel.show(),this._panelIsSliding)return!1;this._panelIsSliding=!0,$("#lswitch-btn span").addClass("lsw-angle-turned"),setTimeout(function(){$(".lswitch-panel").addClass("panel-visible")},1),setTimeout(function(){t._panelIsSliding=!1},300),$("#mapdiv").addClass("mapdiv-slidetransition"),$("#maindiv").addClass("lswitcher-slidetransition");var i=this.$panel.outerWidth();$("#mapdiv").css({"margin-left":i+"px",width:$("#mapdiv").outerWidth()-i+"px"})},hidePanel:function(){return this._panelIsSliding?!1:(this._panelIsSliding=!0,$("#lswitch-btn span").removeClass("lsw-angle-turned"),$("#mapdiv").css({"margin-left":"0",width:"100%"}),$(".lswitch-panel").removeClass("panel-visible"),$("#maindiv").addClass("lswitch-overflow-hidden"),$("#maindiv").removeClass("lswitcher-slidetransition"),void setTimeout($.proxy(function(){$("#mapdiv").removeClass("mapdiv-slidetransition"),this._panelIsSliding=!1,this.$panel.hide(),$("#maindiv").removeClass("lswitch-overflow-hidden")},this),300))},_setBaseLayer:function(t){var i,n=this.map._layers;for(var e in n)i=n[e],i&&i.options&&i.options.isBaseLayer&&i.options.layerId!==t&&this.hideLayer(i.options.layerId);this.showLayer(t)},_onLegendClick:function(t){return $(this).parent().trigger("tap"),!1},_onRowTap:function(t){var i=$(t.target);return i.hasClass("list-group-item")?(this.onRowTap(i),!1):void 0},onRowTap:function(t){var i=t.attr("id"),n=this._unMakeId(i),e=$("#"+i).parents("#lswitch-blcont").length>0;if(e)return $("#lswitch-blcont").find("a.active").removeClass("active"),t.addClass("active"),this._setBaseLayer(n),!1;t.toggleClass("active");var s=t.hasClass("active"),o=t.parents(".lswitch-catcont");o.each(function(){if(s)$(this).prev().addClass("active");else{if($(this).find("a.list-group-item.active").length>0)return!1;$(this).prev().removeClass("active")}});var a,s=t.hasClass("active");if(s){var l=t.data("t")||null;a=this.showLayer(l||n);var r=this.options.getFitBoundsOptions?this.options.getFitBoundsOptions():null;(this.options.zoomToExtent||l&&l.options&&l.options.zoomToExtent)&&!this._sumBounds&&a.getBounds&&($.isEmptyObject(a._layers)?a.once("load",function(t){t.layer._map.fitBounds(a.getBounds(),r)}):this.map.fitBounds(a.getBounds(),r))}else this.map.closePopup(),a=this.hideLayer(n);return a},_makeId:function(t){return"lswitchrow-"+encodeURIComponent(t).replace(/%/g,"--pr--")},_unMakeId:function(t){return decodeURIComponent(t.replace("lswitchrow-","").replace(/--pr--/g,"%"))},_toggleHeader:function(t){t.next().toggleClass("lswitch-catcont-visible"),t.toggleClass("open")},_onHeaderClick:function(t,i){i=i||{};var n=this,e=t.target;e="A"===e.tagName||"SPAN"===e.tagName?$(e).parent():$(e);var s=e.next();if(!this.options.unfoldOnClick||!this.options.unfoldAll&&i.isSubHeader||this._toggleHeader(e),!this.options.toggleSubLayersOnClick&&this.options.unfoldOnClick&&this.options.unfoldAll&&s.find("div.list-group-item").each(function(){h=$(this);var t=e.hasClass("open"),i=h.hasClass("open");t!==i&&n._toggleHeader(h)}),this.options.toggleSubLayersOnClick&&0===e.parents("#lswitch-blcont").length){var o,a,l=e.hasClass("active"),r=e.hasClass("open");this.options.unfoldOnClick&&r===l&&!i.isSubHeader?l=!l:e.toggleClass("active");var d,c;this._sumBounds=null,!this.options.zoomToExtent||l||this._sumBounds||(d=$.Deferred(),d.done(function(){n._sumBounds.isValid()&&n.map.fitBounds(n._sumBounds,n.options.getFitBoundsOptions?n.options.getFitBoundsOptions():null),n._rowCount=null,n._sumBounds=null}),this._rowCount=this._rowCount||s.find("a.list-group-item").length,this._sumBounds=L.latLngBounds([]),c=function(t,i){this._rowCount-=1,this._sumBounds.extend(t.getBounds()),0===this._rowCount&&i.resolve()}),s.children(".list-group-item").each(function(){if(a=$(this),o=a.hasClass("active"),"A"===a[0].tagName&&l===o){var t=n.onRowTap(a);n._sumBounds&&t.getBounds&&($.isEmptyObject(t._layers)===!0?t.once("load",function(){c.call(n,t,d)}):c.call(n,t,d))}else"DIV"===a[0].tagName&&l===o&&n._onHeaderClick({target:a},{isSubHeader:!0})})}return $(window).width()>this.options.pxDesktop?this._setSwitcherPosition():$(".lswitch-panel").css("position","absolute"),!1},_onHeaderIconClick:function(t){var i=$(t.target);return this._toggleHeader(i.parent()),!1},_onBtnDialogClick:function(t){var i=$(t.target).parents(".list-group-item:first").data("t").options,n="",e=i.dialog;("http"===e.substring(0,4)||"//"===e.substring(0,2))&&(n='<div class="modal-body-container"><iframe frameborder="0" scrolling="auto" src="'+e+'" width="100%" height="100%" style="position:absolute;left:0;top:0;margin:0;padding:0;" frameborder="0"></iframe></div>');var s='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>",o=utils.drawDialog(i.displayName,n,s,{});o.addClass("lswitch-dialog"),o.modal("show");var a=$("#mapdiv").height();return a=a>500?500:a,o.find(".modal-body").css({"min-height":a+"px"}),o.on("hidden.bs.modal",function(){$(this).empty().remove()}),!1},_addBtnDialog:function(t,i){var n=$('<span class="fa fa-info-circle lswitch-btndialog" aria-hidden="true"></span>');n.on("click touchstart",this.__onBtnDialogClick),t.prepend(n)},_addLegend:function(t,i){var n=$('<img class="lswitch-legend" src="'+i+'" />');n.on("tap",this._onLegendClick).on("mouseenter",this.__onLegendEnter).on("mouseleave",this.__onLegendLeave),t.prepend(n)},_onLegendLeave:function(){$(".lswitch-legend-big").remove(),$(document).off("mousemove",this._moveWithCursor)},_onLegendEnter:function(t){var i=$(t.target),n=i.parent().data("t"),e=n.options.legendBig||n.options.legend;$(".lswitch-legend-big").remove(),delete this._hoverImg;var s=$('<img class="lswitch-legend-big" src="'+e+'" />');this._hoverImg=s,$(document).on("mousemove",this._moveWithCursor)},_addRow:function(t){var i=this.options.catIconClass,n=this,e=t.options,s=$('<a class="list-group-item">'+e.displayName+"</a>");s.attr("id",this._makeId(e.layerId)),s.on("tap",this.__onRowTap),s.data("t",t),!e.legend||utils.isTouchOnly()&&$(window).width()<this.options.pxDesktop||this._addLegend(s,e.legend),e.dialog&&this._addBtnDialog(s,t);var o;if(e.isBaseLayer?(o=$("#lswitch-blcont"),o.is(":visible")||$(".lswitch-panel-bl").show()):(o=$("#lswitch-olcont"),o.is(":visible")||$(".lswitch-panel-ol").show()),e.category){var a,l,r,h;!function(){var t=function d(t,e,o){return h=t[e],l=o.find('.lswitch-cat:has(span:contains("'+h+'"))'),l.length?r=l.next():(l=$('<div class="list-group-item lswitch-cat"><i class="'+i+'"></i><span>'+h+"</span></div>").appendTo(o),r=$('<div class="lswitch-catcont"></div>'),l.after(r),l.on("tap",n.__onHeaderClick),l.find("i").on("tap",n.__onHeaderIconClick)),t.length>e+1?d(t,e+1,r):(r.append(s),!0)};a=e.category,t(a,0,o)}()}else o.append(s);return s}}),L.control.layerSwitcher=function(t){return new L.Control.LayerSwitcher(t)}}]);
!function(t){function e(n){if(a[n])return a[n].exports;var r=a[n]={exports:{},id:n,loaded:!1};return t[n].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var a={};return e.m=t,e.c=a,e.p="",e(0)}([function(t,e){"use strict";L.Control.MMP=L.Control.extend({options:{statusColors:{ej_registrerat:"darkred",registrerat:"orange",pagaende:"cadetblue",avslutat:"black",avvisat:"black",vidarebefordrat:"darkpurple",atgardat:"green",senare_behandling:"black"},userMarker:{color:"black",icon:"arrows"},geolocateMoveUserMarker:!0,geoJsonUniqueKey:"ID",position:"bottomright",minZoom:13,externalDataLayerOptions:null,disableClusteringAtZoom:13,wsSave:{dev:location.protocol+"//gkkundservice.test.malmo.se/KartService.svc/saveGeometry",prod:location.protocol+"//gkkundservice.malmo.se/KartService.svc/saveGeometry"}},_lang:{sv:{btnLabel:"Spara",clickHereToSave:"Klicka här för att spara positionen",dragInfo:'<div style="font-size:1.2em;"><strong style="font-size:1.3em;">Instruktioner</strong><ol style="margin:0;padding-left:1.65em;margin-top:0.5em;"><li>Zooma in i kartan så mycket som möjligt</li><li>Klicka i kartan för att markera platsen för ärendet<br />(pekskärm: peka och håll kvar fingret på en plats)</li></ol></div>',youCanDragMeOrClick:"<strong>Klicka i kartan</strong> igen eller <strong>dra i markören</strong> för att ändra positionen",btnSave:"Spara aktuell position",btnSaved:"Position sparad",zoomInMore:"Du måste zooma in mer i kartan för att kunna lägga till markör"},en:{btnLabel:"Save",clickHereToSave:"Click here to save new position",dragInfo:"<h1>Instructions</h1><ol><li>Zoom the map as much as possible</li><li>Then click once in the map to set the location of the incident</li></ol>",youCanDragMeOrClick:"Click on the map again or drag the marker to adjust the location",btnSave:"Save current position",btnSaved:"Position saved",zoomInMore:"You must zoom the map more before you can add a marker"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-mmp"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._bindEvents(),this._mmpExternalLayers=[],this._cluster=L.markerClusterGroup({disableClusteringAtZoom:this.options.disableClusteringAtZoom||this.map.options.maxZoom+1}),this._bindClusterEvents(this._cluster),this.map.addLayer(this._cluster),this._container},onRemove:function(t){this._unbindEvents(),this.$btn.empty().remove(),this._mmpExternalLayers=null,this.map.removeLayer(this._cluster),this.map.off("zoomend dragend",this._refreshCluster),this._cluster=null},_bindClusterEvents:function(t){this.map.on("zoomend dragend",this._refreshCluster,this)},_refreshCluster:function(){var t=this;this._cluster,this._mmpExternalLayers.forEach(function(e){e._refresh&&(e._map=t.map,e._refresh(),delete e._map)})},activateAddMarker:function(){this._editingIsActive=!0,this._createBtn();var t;t=utils.isTouchOnly()?"contextmenu":"click",this.map.on(t,this.onMapClick,this)},deactivateAddMarker:function(){this._editingIsActive=!1;var t;t=utils.isTouchOnly()?"contextmenu":"click",this.map.off(t,this.onMapClick),$("#smap-mmp-btn").empty().remove(),this.$btn=null},onMapClick:function(t){return this.map.getZoom()<this.options.minZoom?void smap.cmd.notify(this.lang.zoomInMore,"error",{fadeOut:5e3}):(this._marker&&(this.map.removeLayer(this._marker),this._marker=null),this._toggleBtn(!1),void this._addMarker(t.latlng))},onHashChange:function(t,e){var a=location.hash.substring(1),n=utils.paramsStringToObject(a,!0);if(n&&n.MMP_DATA){var r=n.MMP_DATA;r=this._adaptUrl(r),r=decodeURIComponent(r),this._counterLayerId=this._counterLayerId||0,this._clearExternalData(),this._counterLayerId+=1;var o=$.extend({layerId:"mmp-extlayer-"+this._counterLayerId},this.options.externalDataLayerOptions);this._addExternalData(r,o)}},_bindEvents:function(){var t=this;smap.event.on("smap.core.beforeapplyparams",function(t,e){var a=e.OL||"";a=a.split(","),a.push(e.CATEGORY),a=a.join(","),e.OL=a}),smap.event.on("smap.core.applyparams",function(e,a){if(t.options.wsSave instanceof Object){var n=a.ISPROD&&a.ISPROD.length?a.ISPROD.toUpperCase():"FALSE",r={FALSE:t.options.wsSave.dev,TRUE:t.options.wsSave.prod};t.options.wsSave=r[n]}a.MMP_EDIT&&"TRUE"===a.MMP_EDIT.toUpperCase()&&t.activateAddMarker();var o=null,s=null;if(a.MMP_XY){var o=a.MMP_XY instanceof Array?a.MMP_XY:a.MMP_XY.split(",");o=$.map(o,function(t){return parseFloat(t)}),s=utils.projectLatLng(L.latLng(o),"EPSG:3008","EPSG:4326",!0,!1)}else this._editingIsActive&&smap.cmd.notify(t.lang.dragInfo,"info");a.MMP_ID&&(t._tempId=a.MMP_ID),s&&t._addMarker(s),t.onHashChange()}),smap.event.on("hashchange",this.onHashChange.bind(this))},_clearExternalData:function(){for(var t=this._mmpExternalLayers,e=0;e<t.length;e++)smap.cmd.hideLayer(t[e]);this._mmpExternalLayers=[]},_addExternalData:function(t,e){function a(t){return t.toLowerCase().replace(/ /g,"_").replace(/å/g,"a").replace(/ä/g,"a").replace(/ö/g,"o")}e=e||{};var n,r={url:t,init:"L.GeoJSON.WFS",options:$.extend(!0,{layerId:L.stamp(this),displayName:"Incidenter",xhrType:this.options.xhrType?this.options.xhrType:"GET",attribution:"Malmö stad",inputCrs:"EPSG:3008",uniqueKey:this.options.geoJsonUniqueKey,selectable:!0,reverseAxis:!1,showInLayerSwitcher:!0,reverseAxisBbox:!0,geomType:"POINT",includeParams:["bbox"],separator:"&",noParams:e.noParams||!1,popup:"*",pointToLayer:function(t,e){var n=L.AwesomeMarkers.icon({icon:"warning",prefix:"fa",markerColor:o.options.statusColors[a(t.properties.Status)]||"white"}),r=L.marker(e,{icon:n});return r.options.icon.options.className+=" easyincident-smallmarker",r}},e)};smap.cmd.getControl("LayerSwitcher"),n=smap.core.layerInst._createLayer(r),this._mmpExternalLayers.push(n);var o=this;n.on("load",function(t){t.target.eachLayer(function(t){o._cluster.addLayer(t)})}),this.map.fire("layeradd",{layer:n,target:n}),this._refreshCluster()},_unbindEvents:function(){this.map.off("click",this.onMapClick)},_adaptUrl:function(t){return t&&t.length&&"string"==typeof t?("localhost"===document.domain?t=t.replace("gkkundservice.malmo.se","localhost/gkkundservicedev").replace("gkkundservice.test.malmo.se","localhost/gkkundservicedev").replace("kartor.malmo.se","localhost"):"kartor.malmo.se"===document.domain&&(t=t.replace("gkkundservice.test.malmo.se/","kartor.malmo.se/gkkundservicedev/").replace("gkkundservice.malmo.se/","kartor.malmo.se/gkkundservice/")),t):t},_save:function(t,e){var a=this.options.wsSave;a=this._adaptUrl(a),smap.cmd.loading(!0),$.ajax($.extend({url:a,type:"GET",data:t,context:this,cache:!1,dataType:"json",success:function(t){t.success&&JSON.parse(t.success)?this._toggleBtn(!0):void 0},error:function(t,e,a){},complete:function(){smap.cmd.loading(!1)}},e))},save:function(){var t=utils.projectPoint(this._latLng.lng,this._latLng.lat,"EPSG:4326","EPSG:3008"),e=t[0],a=t[1],n={x:Math.round(e),y:Math.round(a),tempId:this._tempId||null};this._save(n)},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-mmp-btn" class="btn btn-primary btn-lg hidden"> '+this.lang.btnSave+"</button>"),this.$btn.on("click",function(e){return e.stopPropagation(),t.save(),!1}),$("#mapdiv").append(this.$btn)},_toggleBtn:function(t){t?this.$btn.removeClass("btn-primary").addClass("btn-success").html('<span class="fa fa-check"></span> '+this.lang.btnSaved):this.$btn.removeClass("btn-success").addClass("btn-primary").html(this.lang.btnSave)},_addMarker:function(t){var e=this;t&&(this._latLng=t);var a=L.AwesomeMarkers.icon({icon:this._editingIsActive?e.options.userMarker.icon:"lock",markerColor:e.options.userMarker.color,prefix:"fa",extraClasses:"mmpmarker"}),n=L.marker(t,{draggable:this._editingIsActive||!1,icon:a,zIndexOffset:999});n.on("dragstart",function(t){t.target.closePopup()}),n.on("dragend",function(t){e._toggleBtn(!1),e._latLng=t.target.getLatLng()}),e.options.geolocateMoveUserMarker&&e.map.on("locationfound",function(t){locationLatLng=L.latLng(t.latlng.lat,t.latlng.lng),e._toggleBtn(!1),e._marker.setLatLng(locationLatLng)}),this.map.addLayer(n),n.openPopup(),this._marker=n,this.$btn&&(this.$btn.removeClass("hidden"),$(".alert").remove())}})}]);
!function(t){function e(o){if(i[o])return i[o].exports;var a=i[o]={exports:{},id:o,loaded:!1};return t[o].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e){"use strict";L.Control.MMPGreta=L.Control.extend({options:{wsSave:location.protocol+"//kartor.malmo.se/gkgreta/KartService.svc/saveGeometry",xhrType:"GET",inputCrs:"EPSG:3008",saveCrs:"EPSG:3008",uniqueKey:!1,reverseAxis:!1,reverseAxisBbox:!0,colorSaved:"#71A500",colorUnSaved:"#FF0000",statusKey:"Attribut",statusColors:{passed:"blue",now:"darkred",future:"orange"},popup:'<div><div>${TooltipTitle}</div><div>${Tooltip}</div><div style="margin-top: 0.7em;">${TooltipUrl}</div></div>'},_lang:{sv:{addPoint:"Rita punkt",addPolyline:"Rita linje",addPolygon:"Rita yta",remove:"Ta bort",edit:"Redigera",save:"Spara",instructEditing:"Klicka här igen när du redigerat klart",saveSuccess:"<b>Ändringarna har sparats!</b>",saveError:"<b>Ändringarna kunde inte sparas!</b><p>Felet har loggats till utvecklingskonsolen.</p>"},en:{addPoint:"Draw point",addPolyline:"Draw line",addPolygon:"Draw polygon",remove:"Remove",edit:"Edit",save:"Save",instructEditing:"Click here when you are done editing",saveSuccess:"Edits saved!",saveError:"Could not save edits!"}},initialize:function(t){L.setOptions(this,t),t._lang&&$.extend(!0,this._lang,t._lang),this._setLang(t.langCode),L.Edit.Poly.addInitHook(function(){this._poly&&!this._poly.options.editing&&(this._poly.options.editing={}),this._fireEdit=function(){this._poly.edited=!0,this._poly.fire("edit"),smap.map.fire("draw:editedpoly",this._poly)}}),L.Edit.Marker.addInitHook(function(){this._onDragEnd=function(t){var e=t.target;e.edited=!0,smap.map.fire("draw:editedmarker",e)}}),L.EditToolbar.Delete.addInitHook(function(){this._removeLayer=function(t){var e=t.layer||t.target||t,i=e.editing._marker;i&&i.options.hasOwnProperty("editable")&&i.options.editable===!1?smap.cmd.notify("Ärendepunkter kan inte redigeras/tas bort","warning",{fade:!0}):(this._deletableLayers.removeLayer(e),this._deletedLayers.addLayer(e),this._map.fire("mmpgreta:edited"))}})},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-MMPGreta"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._bindEvents(),this._tools={},this._container},_bindEvents:function(){smap.event.on("smap.core.createjsonlayer",function(t,e){function i(t){var e=t.target.feature.properties;if(e.TooltipTitle&&e.Tooltip){var i="<b>"+e.TooltipTitle+"</b><p>"+e.Tooltip+"</p>";$(".leaflet-top.leaflet-right").find("button.active").length||(this._tooltip=utils.createLabel(t.latlng,i,"mmpgreta-tooltip"),this._map.addLayer(this._tooltip))}}function o(t){this._tooltip&&this._map.removeLayer(this._tooltip)}$.extend(e,{inputCrs:this.options.inputCrs,uniqueKey:this.options.uniqueKey,reverseAxis:this.options.reverseAxis,reverseAxisBbox:this.options.reverseAxisBbox,noBindZoom:!0,noBindDrag:!0,style:{fillColor:this.options.colorSaved,color:this.options.colorSaved,opacity:1},pointToLayer:function(t,e){var a=t.properties,n=this.options.statusColors[a[this.options.statusKey]],s=n?!1:!0,r=a.Icon&&a.Icon.length?a.Icon:"warning";r=r.replace("fa fa-","").replace(/fa/g,"");var d=L.AwesomeMarkers.icon({icon:r,prefix:"fa",markerColor:s?"green":n}),l=L.marker(e,{icon:d});return l.on("mouseover",i.bind(this)),l.on("mouseout",o.bind(this)),t.id&&t.id.toUpperCase().indexOf("POI_ARENDE_")>-1&&(l.options.editable=!1,l.options.draggable=!1,delete l.editing,l.editing={enable:function(){},disable:function(){},_marker:l}),l}.bind(this)})}.bind(this));var t=this;smap.event.on("smap.core.beforeapplyparams",function(e,i){i.GRETA_EDITID?(this._editId=parseInt(i.GRETA_EDITID),smap.event.on("smap.core.addedjsonlayer",function(e,i){if(this._hasInitiated)return!1;this._hasInitiated=!0,i.options.popup=t.options.popup;var o=function(){var e=L.featureGroup([],{selectable:!0});e.options={},this.map.removeLayer(i),i.eachLayer(function(t){e.addLayer(t)}),this._editLayer=e,this.map.addLayer(e),this.addEditPanel(e),this.map.on("unselected",function(){e.eachLayer(function(e){if(e.editing&&e.editing._poly&&(e.options||e.editing._poly.options)){var i=e.editing._poly,o=e.editing._poly.options||e.options,a="#FF0000"===o.color?!1:!0;a===!1?setTimeout(function(){t._updateLayerStyle(a,i)},0):t._updateLayerStyle(a,i)}})}),i.off("load",o)}.bind(this);i.on("load",o)}.bind(this))):smap.event.on("smap.core.addedjsonlayer",function(e,i){i.options.popup=t.options.popup,delete i.pointToLayer}.bind(this)),this._map.on("selected",function(){this._tooltip&&this.map.removeLayer(this._tooltip)}.bind(this))}.bind(this))},onRemove:function(t){},_adaptUrl:function(t){if(!t||!t.length||"string"!=typeof t)return t;switch(document.domain){case"localhost":return t.replace("kartor.malmo.se","localhost");case"kartor.malmo.se":return t;default:return t}},onStartEdit:function(){},_getTool:function(t){if(t=utils.capitalize(t.toLowerCase()),!this._tools[t]){var e,i;switch(t){case"Delete":e=L.EditToolbar.Delete;var o={featureGroup:this._editLayer};i=new e(this.map,o);break;case"Edit":i={enable:this.startEditing.bind(this),disable:this.stopEditing.bind(this)};break;default:e=L.Draw[t]||L.Edit[t]||L.EditToolbar[t],i=new e(this.map,o);var o=this._drawControl.options.draw[t],a=this.options.colorUnSaved;i.options.shapeOptions={color:a,fillColor:a}}this._tools[t]=i}return this._tools[t]},_deactivateAllTools:function(t){for(var e in this._tools)t&&e.toUpperCase()===t.toUpperCase()||this._deactivateTool(e)},_activateTool:function(t){this._deactivateAllTools(t);var e=this._getTool(t);switch(t){case"DELETE":}e.enable()},_deactivateTool:function(t){var e=this._getTool(t),i=$(".mmpgreta-type-"+t.toLowerCase());e.disable(),i.removeClass("active btn-danger")},startEditing:function(){this._editLayer.options.editable=!0,smap.cmd.loading(!0),setTimeout(function(){this._editLayer.eachLayer(function(t){switch(t.editing){case void 0:break;default:t.editing.enable()}}),smap.cmd.loading(!1)}.bind(this),1)},stopEditing:function(){this._editLayer.options.editable=!1,smap.cmd.loading(!0),setTimeout(function(){this._editLayer.eachLayer(function(t){t.editing&&t.editing.disable()}),smap.cmd.loading(!1)}.bind(this),1)},addEditPanel:function(t){function e(e){var i=(e.layerType,e.layer);t.addLayer(i),this._deactivateAllTools(),this._map.fire("mmpgreta:edited",i)}function i(t){var e=$(this),i=e.prop("data-geomtype");return e.toggleClass("active btn-danger").hasClass("active")?a._activateTool(i):a._deactivateTool(i),!1}var o=new L.Control.Draw({draw:!1,edit:{featureGroup:t,remove:!1}});this.map.addControl(o),this._drawControl=o,$(".leaflet-draw").remove(),this.map.on("draw:created",e.bind(this));var a=this,n=this._addBtn("fa fa-save",this.lang.save,function(){this._deactivateAllTools(),this.save()}.bind(this));n.prop("id","btn-save"),this._allowSaving(!1),this._map.on("draw:editedpoly",function(t){a._updateLayerStyle(!1,t.editing._poly),a._allowSaving(!0),t.editing._poly.options._save=!1,t.editing._poly.options._saved=t.options._saved=!1}),this._map.on("draw:editedmarker",function(t){a._updateLayerStyle(!1,t.editing._marker),a._allowSaving(!0),t.editing._marker.options._save=t.options._saved=!1}),this._map.on("mmpgreta:edited",function(t){if(this._allowSaving(!0),t&&t.options&&t.options.icon){var e=t.editing._marker||t;e.setIcon(L.AwesomeMarkers.icon({icon:"warning",prefix:"fa",markerColor:"red"})),t.options._saved=!1}}.bind(this)),this._addToolBtn("fa fa-eraser",this.lang.remove,"DELETE",i),this._addToolBtn("fa fa-edit",this.lang.edit,"EDIT",i),this._addToolBtn("fa fa-object-ungroup",this.lang.addPolygon,"POLYGON",i),this._addToolBtn("fa fa-code-fork",this.lang.addPolyline,"POLYLINE",i),this._addToolBtn("fa fa-map-marker",this.lang.addPoint,"MARKER",i);var s=smap.cmd.getControl("ToolHandler");s&&s.update()},_allowSaving:function(t){var e=$("#btn-save .btn");t?e.prop("disabled",!1):e.prop("disabled",!0)},removeEditPanel:function(){},_addBtn:function(t,e,i){var o=$('<div class="leaflet-control"><button title="'+e+'" class="btn btn-default"><span class="'+t+'"></span></button></div>');return o.find(".btn").on("click",i),$(".leaflet-top.leaflet-right").append(o),o.prop("title",e).tooltip({placement:"bottom"}),o},_addToolBtn:function(t,e,i,o){var a=this._addBtn(t,e,o);return a.find(".btn").prop("data-geomtype",i).addClass("mmpgreta-type-"+i.toLowerCase()),a},filterBeforeSave:function(t){var e=this;return t.features.forEach(function(t,i){utils.projectFeature(t,"EPSG:4326",e.options.saveCrs,{reverseAxisOutput:!1,decimals:0}),t.properties.ArendeId=e._editId}),t.features=t.features.filter(function(t){return!t.id||t.id&&-1===t.id.toUpperCase().indexOf("POI_ARENDE_")}),t},_updateLayerStyle:function(t,e){e=e||this._editLayer;var i;if(e.setStyle){i=t?this.options.colorSaved:this.options.colorUnSaved;var o={fillColor:i,color:i,opacity:1};e.setStyle(o),e.options.style=o}else{i=t?"green":"red";var a=t?"red":"green",n="awesome-marker-icon-";e.options.icon.options.markerColor=i,$(e._icon).removeClass(n+a).addClass(n+i)}},_addPreventCacheParam:function(t){var e=t.charAt(t.length-1),i=t.indexOf("?")>0;return i?"&"!==e&&"?"!==e&&(t+="&"):t+="?",t+"_="+(new Date).getTime()},save:function(){var t=this._editLayer.toGeoJSON();t=this.filterBeforeSave(t);var e=this;$.ajax({type:"POST",contentType:"text/plain; charset=utf-8",url:this._adaptUrl(this.options.wsSave),data:JSON.stringify(t),dataType:"json",context:this,success:function(i,o){"true"===i.success?(smap.cmd.notify(this.lang.saveSuccess,"success",{fade:!0}),this._allowSaving(!1),this._updateLayerStyle(!0),this._editLayer.eachLayer(function(t){t.options._saved===!1&&(t.options._saved=!0,e._updateLayerStyle(!0,t))}),this._prevJson=t):smap.cmd.notify(this.lang.saveError,"error",{fade:!0})},error:function(t,e,i){smap.cmd.notify(this.lang.saveError,"error",{fade:!0})}})}})}]);
!function(e){function t(n){if(s[n])return s[n].exports;var a=s[n]={exports:{},id:n,loaded:!1};return e[n].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t){"use strict";L.Control.MalmoHeader=L.Control.extend({options:{position:"bottomright"},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode)},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-MalmoHeader"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container);var t='<!--[if IE]><meta content="IE=edge" http-equiv="X-UA-Compatible" /><![endif]--><!--[if lte IE 8]><script src="//assets.malmo.se/external/v4/html5shiv-printshiv.js" type="text/javascript"></script><![endif]--><link href="//assets.malmo.se/external/v4/masthead_standalone.css" media="all" rel="stylesheet" type="text/css"/><!--[if lte IE 8]><link href="//assets.malmo.se/external/v4/legacy/ie8.css" media="all" rel="stylesheet" type="text/css"/><![endif]--><noscript><link href="//assets.malmo.se/external/v4/icons.fallback.css" rel="stylesheet"></noscript><link rel="icon" type="image/x-icon" href="//assets.malmo.se/external/v4/favicon.ico" />';return $("head").prepend(t),$("body").addClass("mf-v4 no-footer"),$("body").append('<script src="//assets.malmo.se/external/v4/masthead_standalone_without_jquery.js"></script>'),this._container},onRemove:function(e){$("#malmo-masthead").remove()}}),L.control.malmoHeader=function(e){return new L.Control.MalmoHeader(e)}}]);
!function(e){function t(r){if(a[r])return a[r].exports;var o=a[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var a={};return t.m=e,t.c=a,t.p="",t(0)}([function(e,t){"use strict";var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};L.Control.MeasureDraw=L.Control.extend({options:{position:"topright",saveMode:"url",saveWfsUrl:"",saveWfsTypeName:"",layerName:"measurelayer",moreCoordsAsModal:!0,touchShowButtonAsDisabled:!0,stylePolygon:{color:"#0077e2",weight:3},stylePolyline:{color:"#0077e2",weight:9}},_lang:{sv:{btnDisabledBecauseTouch:"Rita & Mät stödjer inte pekskärmar",close:"Stäng",drawTools:"Ritverktyg",draggableMarker:"Markören är dragbar",btnTitle:"Rita & Mät",drawPoint:"Punkt/Koordinater",drawLine:"Linje",drawPolygon:"Yta",drawCircle:"Cirkel",drawRectangle:"Rektangel",circumference:"Omkrets",radius:"Radie",area:"Area",len:"Längd",lenPart:"Sidlängd",easting:"Easting (x/longitud)",northing:"Northing (y/latitud)",clickToAddText:"Klicka för att lägga till text (stäng pratbubblan för att spara)",showMeasures:"Visa mätresultat",remove:"Ta bort",moreCoords:"Fler koordinatsystem",helpTextSavePopup:"Stäng pratbubblan för att spara",handlers:{circle:{tooltip:{start:"Klicka och dra för att rita cirkel."}},marker:{tooltip:{start:"Klicka i kartan för att placera markör."}},polygon:{tooltip:{start:"Klicka för att påbörja yta",cont:"Klicka igen för att fortsätta rita ytan.",end:"Dubbelklicka eller klicka första punkten för att avsluta ytan."}},polyline:{error:"<strong>Error:</strong> linjers kanter kan inte korsa varandra!",tooltip:{start:"Klicka för att påbörja linje.",cont:"Klicka för att fortsätta linje.",end:"Dubbelklicka för att avsluta linje."}},rectangle:{tooltip:{start:"Klicka och dra för att rita rektangel."}},simpleshape:{tooltip:{end:"Släpp musknappen för att avsluta."}}}},en:{btnDisabledBecauseTouch:"Draw & Measure does not work on touch screens",close:"Close",drawTools:"Draw tools",draggableMarker:"The marker is draggable",btnTitle:"Draw & Measure",drawPoint:"Point/Coordinates",drawLine:"Line",drawPolygon:"Area",drawCircle:"Circle",drawRectangle:"Rectangle",circumference:"Circumference",radius:"Radius",area:"Area",len:"Length",easting:"Easting (x/longitude)",northing:"Northing (y/latitude)",clickToAddText:"Click to add text",showMeasures:"Show measure results",remove:"Remove",moreCoords:"More projections",helpTextSavePopup:"Close the popup to save"}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.Draw.Polyline.addInitHook(function(){this._vertexChanged=function(e,t){this._updateFinishHandler(),this._updateRunningMeasure(e,t),this._clearGuides(),this._updateTooltip(),this._map.fire("draw:vertexchanged",{latlng:e,context:this})}}),L.setOptions(this,e),this._setLang(e.langCode),this._tools={},this._setLabels()},_jsonCompressDict:{'"FeatureCollection":':":fc:",'"Feature"':":F:",'"Point"':":P:",'"features":':":fs:",'"type":':":t:",'"geometry":':":g:",'"coordinates":':":c:",'"properties":':":p",'"measure_form"':":m:",'"measure_text"':":mt:"},_compressJson:function(e){var t,a=this._jsonCompressDict;for(var r in a)t=new RegExp(r,"g"),e=e.replace(t,a[r]);return e},_uncompressJson:function(e){var t,a=this._jsonCompressDict;for(var r in a)t=new RegExp(a[r],"g"),e=e.replace(t,r);return e},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-measuredraw"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._proxyListeners(),this._initDraw(),this._isTouchOnly=utils.isTouchOnly();var t=this._isTouchOnly&&this.options.touchShowButtonAsDisabled;if(!this._isTouchOnly||t){var a=this._createBtn();t?(a.prop("disabled",!0),a.prop("title",this.lang.btnDisabledBecauseTouch),a.tooltip({placement:"bottom"})):smap.event.on("smap.core.pluginsadded",function(){$(".leaflet-control-measuredraw .dropdown-toggle").dropdown()})}var r=this;return this.map.on("layeradd",function(e){r._layer.bringToFront(),r._layer.setZIndex(1e4),r._layer.eachLayer(function(e){e.options.selectable=!0,e.options.clickable=!1,e.bringToFront&&e.bringToFront(),e.setZIndex&&e.setZIndex(1e4)})}),smap.event.on("smap.core.createparams",$.proxy(this._onCreateParams,this)),smap.event.on("smap.core.applyparams",$.proxy(this._onApplyParams,this)),this._container},_onCreateParams:function(e,t){for(var r=this,o=t.ol,n=0,s=o.length,i=this.options.layerName;s>n;n++)if(o[n]===i){o.splice(n,1);break}if("url"===this.options.saveMode){var l,p,c,d,u,h,g,n,s,m,f,b=function(){var e=function a(e){for(var t,r=0,o=e.length;o>r;r++)t=e[r],t instanceof Array?a(t):e[r]=L.Util.formatNum(t,5)};if(l=[],p=0,r._layer.eachLayer(function(e){e._radius&&(e.properties.radius=e.getRadius()),e._popup&&e._popup._isOpen&&(delete t.sel,e.properties.popupIsOpen=!0),l.push(e.properties),e.properties&&(p+=1)}),0===p)return{v:!1};for(c=r._layer.toGeoJSON(),d=c.features,g=[],n=0,s=d.length;s>n;n++)h=d[n],u=$.extend(!0,{},h),e(u.geometry.coordinates),l[n]&&(u.properties=$.extend({},l[n]),delete u.properties.measure_form,g.push(u));c.features=g,m=JSON.stringify(c),m=r._compressJson(m),f=encodeURIComponent(r.options.saveMode+","+m),f=f.replace(/%3A/g,":"),f=f.replace(/%3A/g,":"),t.md=f}();if("object"===("undefined"==typeof b?"undefined":a(b)))return b.v}},_onApplyParams:function(e,t){if(t.MD){var a=decodeURIComponent(t.MD),r=a.search(","),o=a.substring(0,r),n=a.substring(r+1);if("url"===o){n=this._uncompressJson(n);var s,i=JSON.parse(n),l=L.geoJson(i),p=this;l.eachLayer(function(e){var t={Point:"marker",LineString:"polyline",Polygon:"polygon"};if("Point"===e.feature.geometry.type){var a=e.feature.geometry.coordinates;s=L.marker([a[1],a[0]]),s.properties=$.extend(!0,{},e.feature.properties)}else s=e;p.onCreated({_silent:!0,layerType:t[e.feature.geometry.type],layer:s})})}}},_proxyListeners:function(){this.__onRowClick=$.proxy(this._onRowClick,this)},onRemove:function(e){},readableDistance:function(e,t){t=t||1;var a="m",r=0;if(1===t&&e>=1e3||2===t&&e>=1e5){var o=Math.pow(1e3,t-1);e/=o,e/=1e3,r=3,a="km"}return a=1===t?a:a+t,utils.round(e,r)+" "+a},_renderLabel:function(e,t){this._labels=this._labels||[];var a=utils.createLabel(e,this.readableDistance(t,1),"leaflet-maplabel leaflet-maplabel-small");this._layer.addLayer(a),this._labels.push(a);var r=$(".leaflet-maplabel.leaflet-maplabel-small:last");r.css({"margin-left":-r.width()/2+"px"})},onNodeClick:function(e){this._nodes=this._nodes||[];var t=e.latlng||null,a=this._nodes;if(t&&a.push(t),a.length>1){var r=a.slice(a.length-2),o=utils.getLength(r);if(0>=o)return!1;var n=L.latLng((r[0].lat+r[1].lat)/2,(r[0].lng+r[1].lng)/2);this._renderLabel(n,o)}},_createCoordsHtml:function(e,t){t=t||!1;var a=utils.projectLatLng(e,"EPSG:4326","EPSG:3006"),r=utils.projectLatLng(e,"EPSG:4326","EPSG:3008"),o=utils.projectLatLng(e,"EPSG:4326","EPSG:3021"),n="",s="",i="";t||(n=" hidden",s='<div style="margin-bottom:1em;">['+this.lang.draggableMarker+"]</div>",i='<br><button ondrag="return false;" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i>&nbsp;&nbsp;'+this.lang.moreCoords+"</button></div></div>");var l=s+"<div><strong>WGS 84 (EPSG:4326)</strong><br>Lat: &nbsp;"+utils.round(e.lng,5)+"<br>Lon: &nbsp;"+utils.round(e.lat,5)+"<div>"+i;return l+="<br><div class='measuredraw-morecoords"+n+"'><strong>Sweref99 TM (EPSG:3006)</strong><br>East: &nbsp;"+utils.round(a.lng)+"<br>North: &nbsp;"+utils.round(a.lat)+"<br><br><strong>Sweref99 13 30 (EPSG:3008)</strong><br>East: &nbsp;"+utils.round(r.lng)+"<br>North: &nbsp;"+utils.round(r.lat)+"<br><br><strong>RT90 2.5 gon V (EPSG:3021)</strong><br>East: &nbsp;"+utils.round(o.lng)+"<br>North: &nbsp;"+utils.round(o.lat)+"</div>"},_getLabel:function(e){var t;return this._layer.eachLayer(function(a){a._parentFeature&&a._parentFeature===e&&(t=a)}),t},onCreated:function(e){var t=this;this._deactivateAll();var a=e.layerType,r=e.layer;if(r.properties&&r.properties.radius){var o=r.properties;a="circle",r=L.circle(r._latlng,r.properties.radius),r.properties=o}if(r.setStyle)switch(a){case"polyline":r.setStyle(this.options.stylePolyline);break;default:r.setStyle(this.options.stylePolygon)}"marker"===a&&(r.options.draggable=!0,r.on("dragstart",function(e){var t=e.target;t.closePopup()}),r.on("drag",function(e){var a=e.target,r=t._getLabel(a);r.setLatLng(a.getLatLng());var o=t._createCoordsHtml(a.getLatLng());$(r._icon).html(o);var n=$(".alert");if(n.length){var s=smap.cmd.notify(t._createCoordsHtml(a.getLatLng(),!0),"blank");s.addClass("notify-transition notify-visible")}})),this._layer.addLayer(r),r.options.layerId=r._leaflet_id,r.feature&&(r.properties=r.feature.properties||r.properties,delete r.feature),r.properties&&(r.properties.measure_form||r.properties.measure_text)||(r.properties={id:r._leaflet_id,measure_form:'<div class="measuredraw-popup-div-save"><textarea class="form-control" placeholder="'+this.lang.clickToAddText+'" rows="3"></textarea></div>',measure_text:""}),r.properties.id=r._leaflet_id,r._measureDrawFeature=!0,this._layer.fire("load"),r.unbindPopup();var n,s,i,l="";switch(a){case"marker":var p=n=r.getLatLng();l=this._createCoordsHtml(p);break;case"polyline":var c=r.getLatLngs();n=c[parseInt(c.length/2)],s=utils.getLength(c),l=this.lang.len+": &nbsp;"+this.readableDistance(s,1)+"<br>";break;case"polygon":n=r.getBounds().getCenter();var c=r.getLatLngs();c.push(c[0]);var i=L.GeometryUtil.geodesicArea(c);s=utils.getLength(c),l=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(i,2);break;case"circle":n=r.getBounds().getCenter();var d=r.getRadius();i=d*d*Math.PI,s=2*d*Math.PI,l=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.radius+": &nbsp;"+this.readableDistance(d,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(i,2);break;case"rectangle":n=r.getBounds().getCenter();var c=r.getLatLngs();c.push(c[0]);var i=L.GeometryUtil.geodesicArea(c);s=utils.getLength(c),l=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(i,2)}var u=r._leaflet_id,h="measuredrawlabel_"+u+"_",g="leaflet-maplabel "+h;if(this._isTouchOnly);else{(e._silent||"rectangle"===a)&&r.getLatLngs&&(this._nodes=[],$.each(r.getLatLngs(),function(e,a){t.onNodeClick({latlng:a})}));var m=utils.createLabel(n,l,g);if(this._layer.addLayer(m),r.on("mouseover",this.onMouseOver),r.on("mouseout",this.onMouseOut),m.options.clickable=!0,"marker"===a){var f=function(e){if(t.options.moreCoordsAsModal){var a=t._createCoordsHtml(r.getLatLng(),!0);smap.cmd.notify(a,"blank",{fade:!0})}else{var o=$(this),n=o.parent().parent().parent();n.find(".measuredraw-morecoords").toggleClass("hidden"),o.parent().remove()}return!1},b=function(e){var t=$(this);t.find("button").off("click",f).on("click",f)};$(m._icon).on("mouseenter",b),$(m._icon).on("click",function(){return!1})}this._labels=this._labels||[],this._labels.push(m);for(var _=this._labels||[],v=0,y=_.length;y>v;v++)_[v]._parentFeature=r;this._labels=[];var w=$(".leaflet-maplabel:last");"marker"===a&&w.css("transition","none"),w.css({"margin-left":-w.width()/2-15+"px"})}e._silent?r.properties&&r.properties.popupIsOpen&&(delete r.properties.popupIsOpen,this.map.fire("selected",{feature:r,selectedFeatures:[],layer:this._layer})):w&&(w.addClass("leaflet-maplabel-hover"),setTimeout(function(){w.removeClass("leaflet-maplabel-hover")},2e3))},onMouseOver:function(e){var t=$(".measuredrawlabel_"+e.target._leaflet_id+"_");t.addClass("leaflet-maplabel-hover")},onMouseOut:function(e){$(".measuredrawlabel_"+e.target._leaflet_id+"_").removeClass("leaflet-maplabel-hover")},_setLabels:function(){var e=L.drawLocal.draw;$.extend(!0,e.handlers,this.lang.handlers||{})},_selection:function(e){var t,a,r=[smap.cmd.getControl("L.Control.SelectWMS"),smap.cmd.getControl("L.Control.SelectVector")];for(a=0;a<r.length;a++)t=r[a],t&&(e===!0?t.activate():t.deactivate())},_initDraw:function(){this._layer=L.featureGroup(),this._layer.options={layerId:this.options.layerName,popup:"${measure_text}${measure_form}",uniqueKey:"id"},this.map.addLayer(this._layer),this._drawControl=new L.Control.Draw({draw:{marker:!1,polyline:!1,polygon:!1,rectangle:!1,circle:!1},edit:null}),this._onCreated=this._onCreated||$.proxy(this.onCreated,this),this._onNodeClick=this._onNodeClick||$.proxy(this.onNodeClick,this),this._onPopupOpen=this._onPopupOpen||$.proxy(this.onPopupOpen,this),this.map.on("draw:created",this._onCreated);var e=this;e.map.on("click",function(){this._removeAlerts()},this);var t=function(e){this.onNodeClick(e)}.bind(this);this.map.on("draw:drawstart",function(){e._nodes=[],e._selection(!1),e._map.on("draw:vertexchanged",t)}),this.map.on("draw:drawstop",function(a){e._map.off("draw:vertexchanged",t),e._nodes&&_.indexOf(["polygon","rectangle"],a.layerType)>-1&&e._onNodeClick({latlng:e._nodes[0]}),e._selection(!0)}),this.map.on("popupopen",this._onPopupOpen)},_removeFeature:function(e){var t=this;this.map.fire("unselected",{}),this.map._popup&&this.map.closePopup(),this._labels,e.off(),this._layer.eachLayer(function(a){a._parentFeature&&a._parentFeature===e&&(a.off(),t.map.removeLayer(a))}),this._layer.removeLayer(e)},onPopupOpen:function(e){var t=this;this._removeAlerts();var a=e.popup&&e.popup._source?e.popup._source:null;if(a&&a._measureDrawFeature){var r=smap.cmd.getControl("L.Control.SelectWMS");r._dblclickWasRegistered=!0,r&&setTimeout(function(){r._dblclickWasRegistered=!1},400);var o=$(".measuredraw-popup-div-save textarea"),n='<br><br><button class="btn btn-default btn-sm measuredraw-btn-popupremove">'+this.lang.remove+"</button>",s=e.popup,i=s.getContent();if(-1===i.search("measuredraw-btn-popupremove")&&(i+=n,s.setContent(i),s.update(),o=$(".measuredraw-popup-div-save textarea")),$(".leaflet-popup-content").find(".measuredraw-btn-popupremove").on("click",function(){return t._removeFeature(a),!1}),o.length){o.placeholder(),o.tooltip({placement:"top",title:this.lang.helpTextSavePopup,container:".leaflet-popup",trigger:"manual"}),o.on("keypress",function(){$(".tooltip:visible").length||$(this).tooltip("show")});var l=utils.getBrowser();o.on("focus",function(){$(".measuredraw-btn-popupremove").prop("disabled",!0),(l.ie10||l.ie11)&&$(this).val("")}),this.lang.clickToAddText,o.on("blur",function(){$(".measuredraw-btn-popupremove").prop("disabled",!1),$(this).tooltip("hide");var t=e.popup._source,a=$(this).val();""===a||(t.properties.measure_text=a,t.properties.measure_form="",t.closePopup())})}}},_getDrawToolbar:function(e){var t;for(var a in this._drawControl._toolbars)if(t=this._drawControl._toolbars[a],t&&t._modes&&t._modes[e])return t._modes[e];return null},_deactivateAll:function(){var e=this._tools;for(var t in e)e[t].disable(),this.$container.find(".dropdown-menu li.active").removeClass("active");this._removeAlerts()},_removeAlerts:function(){var e=$(".alert");e.length&&(e.removeClass("notify-visible"),setTimeout(function(){e.remove()},500))},_onRowClick:function(e){var t="li"===e.target.tagName?$(e.target):$(e.target).parents("li"),a=t.data("geomType");return t.hasClass("active")?(t.removeClass("active"),this._tools[a].disable()):(this._deactivateAll(),t.toggleClass("active"),this._tools[a].enable(),setTimeout(function(){$(".leaflet-control-measuredraw .dropdown-menu").dropdown("toggle")},200)),!1},_createRow:function(e){var t=$('<li><a><div><span class="drawicons '+e.cl+'"></span><span>'+e.label+"</span></div></a></li>");t.data("geomType",e.geomType),t.on("click",this.__onRowClick);var a=L.Draw[utils.capitalize(e.geomType)],r=new a(this.map,this._drawControl.options.draw[e.geomType]);r.options.shapeOptions=r.options.shapeOptions||{};var o={};switch(e.geomType){case"polyline":o=this.options.stylePolyline;break;default:o=this.options.stylePolygon}return $.extend(r.options.shapeOptions,o),this._tools[e.geomType]=r,t},_createBtn:function(){var e=[{label:this.lang.drawPoint,cl:"leaflet-draw-draw-marker",geomType:"marker"},{label:this.lang.drawLine,cl:"leaflet-draw-draw-polyline",geomType:"polyline"},{label:this.lang.drawPolygon,cl:"leaflet-draw-draw-polygon",geomType:"polygon"},{label:this.lang.drawCircle,cl:"leaflet-draw-draw-circle",geomType:"circle"},{label:this.lang.drawRectangle,cl:"leaflet-draw-draw-rectangle",geomType:"rectangle"}],t=$('<div class="btn-group"><button type="button" title="'+this.lang.btnTitle+'" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="fa fa-map-marker"></span></button><ul class="dropdown-menu" role="menu"></ul></div>');utils.getBrowser().ie&&t.find(".measuredraw-btntoggle-image").css({"background-position":"-120px 0"});for(var a,r,o=t.find(".dropdown-menu"),n=0,s=e.length;s>n;n++)r=e[n],a=this._createRow(r),o.append(a);return this.$container.append(t),t}}),L.control.measureDraw=function(e){return new L.Control.MeasureDraw(e)}}]);
!function(t){function e(n){if(i[n])return i[n].exports;var a=i[n]={exports:{},id:n,loaded:!1};return t[n].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e){"use strict";L.Control.Opacity=L.Control.extend({options:{position:"topright",showTitle:!1,btnReset:!0},_lang:{sv:{caption:"Ändra genomskinlighet på lager",close:"Stäng",btnTitle:"Justera genomskinlighet",popoverTitle:"Genomskinlighet",transparency:"Genomskinlighet",transparent:"Genomskinlig",opaque:"Synlig",visibility:"Synlighet",layerName:"Kartskikt",resetAll:"Återställ alla",hideAll:"Göm alla"},en:{caption:"Transparency tool",close:"Close",btnTitle:"Adjust transparency",popoverTitle:"Transparency",transparency:"Transparency",transparent:"Transparent",opaque:"Visible",visibility:"Opacity",layerName:"Layer",resetAll:"Reset all",hideAll:"Hide all"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),t._lang&&$.extend(!0,this._lang,t._lang),this._setLang(t.langCode)},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-opacity"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this.$popContainer.append('<div class="smap-opacity-headerrow"><label>'+this.lang.layerName+"</label><label>"+this.lang.visibility+"</label></div>"),this.$sliderRowContainer=$('<div class="smap-opacity-sliderrow-container" />'),this.$popContainer.append(this.$sliderRowContainer),this._bindEvents(),this._container},hide:function(){this.$btn.popover("hide"),this.$btn.parent().find(".opacity-popover").hide()},_bindEvents:function(){var t=this,e=function(e){if(e.layer.options&&e.layer.options.layerId&&!e.layer.feature){var i=e.layer;if(!(i&&i.options&&i.options.hasOwnProperty("showInOpacityTool")&&i.options.showInOpacityTool===!1))switch(e.type){case"layeradd":t._addRow(i);break;case"layerremove":t._removeRow(i)}}}.bind(this),i=this.hide.bind(this);this._map.on("layeradd layerremove",e),this._map.on("mousedown dragstart",i),$(window).on("resize orientationchange",i),smap.event.on("smap.toolhandler.hide",function(){this.$btn.parent().find(".opacity-popover").hide(),i()}.bind(this)),smap.event.on("smap.core.aftercreateparams",this.onAfterCreateParams.bind(this)),smap.event.on("smap.core.applyparams",this.onApplyParams.bind(this))},_addBtnReset:function(){var t=$('<div class="smap-opacity-btnresetrow" />'),e=$('<button class="btn btn-default btn-xs smap-opacity-btnreset">'+this.lang.resetAll+"</button>"),i=$('<button class="btn btn-default btn-xs smap-opacity-btnhideall">'+this.lang.hideAll+"</button>");t.append(e),t.append(i),e.on("click touchstart",this.reset.bind(this)),i.on("click touchstart",this.hideAll.bind(this)),this.$popContainer.parent().parent().append(t)},onAfterCreateParams:function(t,e){var i=this._getDefaults(!0),n=this._unCreateId,a={};if(this.$sliderRowContainer.find("input").each(function(t){var e=Number($(this).val()),o=n($(this).prop("id"));e!==100*i[o]&&(a[o]=e)}),$.isEmptyObject(a)===!1){var o=[];e.ol.forEach(function(t){o.push(void 0!==a[t]?a[t]:"")});var s=(this._getDefaults(),this.$sliderRowContainer.find("input").length);e.ol.length<s&&void 0!==a[e.bl]&&a[e.bl]!==100*i[e.bl]&&o.push(a[e.bl]),void(e.opacity=o.join(",").replace(/,+$/,""))}},onApplyParams:function(t,e){if(e.OPACITY){var i=e.OPACITY instanceof Array?e.OPACITY:e.OPACITY.split(","),n=e.OL,a=(this._setLayerOpacity,this);i.forEach(function(t,i){if(0!==t.length){t=Number(t);var o=n.length>i?n[i]:o=e.BL;a._setSliderOpacity(a._createId(o),t)}})}},_createId:function(t){return"opacity-"+t},_unCreateId:function(t){return t.replace("opacity-","")},_setLabelValue:function(t,e){t.text(e+" %")},_setLayerOpacity:function(t,e){t.setOpacity&&t.setOpacity(e)},_setSliderOpacity:function(t,e){this.$sliderRowContainer.find("#"+t).val(e).trigger("change").trigger("slideStop").slider("setValue",e)},reset:function(){var t=this._getDefaults(),e=this;this.$sliderRowContainer.find("input").each(function(i,n){var a=100*t[i];e._setSliderOpacity($(this).prop("id"),a)})},hideAll:function(){var t=this;this.$sliderRowContainer.find("input").each(function(e,i){t._setSliderOpacity($(this).prop("id"),0)})},_getDefaults:function(t){t=t||!1;var e=[];t&&(e={});var i=this._unCreateId;return this.$sliderRowContainer.find("input").each(function(){var n=i($(this).prop("id")),a=smap.cmd.getLayerConfig(n),o=a&&a.options?a.options.opacity||1:1;t?e[n]=o:e.push(o)}),e},onSlideStop:function(t){var e=$(t.target),i=(Number(e.val()),this._unCreateId(e.prop("id"))),n=smap.cmd.getLayer(i);L.NonTiledLayer&&n instanceof L.NonTiledLayer.WMS&&n.redraw()},_resetNonTiledLayer:function(t){t._currentImage&&t._resetImage(t._currentImage),t._bufferImage&&t._resetImage(t._bufferImage)},onSlide:function(t){var e=$(t.target),i=Number(e.val()),n=this._unCreateId(e.prop("id")),a=smap.cmd.getLayer(n),o=i/100;L.NonTiledLayer&&a instanceof L.NonTiledLayer.WMS?(this._setLayerOpacity(a,o),this._resetNonTiledLayer(a)):this._setLayerOpacity(a,o);var s=e.parent().find(".smap-opacity-value");this._setLabelValue(s,i)},_adjustSize:function(){var t=$(".opacity-popover");if(t.length){var e=t.find(".smap-opacity-popcontainer"),i=$("#mapdiv").innerHeight(),n=e.offset()||{},a=t.offset()||{},o=e.outerHeight(),s=i-n.top-(o+100);0>s?(e.addClass("smap-opacity-scrollable"),e.css("max-height",i-a.top-70+"px")):e.css("max-height","none").removeClass("smap-opacity-scrollable"),!this._popoverRepositioned&&$(".thandler-popover:visible").length&&(this._popoverRepositioned=!0,this.$btn.popover("show"),setTimeout(function(){this._popoverRepositioned=!1}.bind(this),0))}},_addRow:function(t){var e=this.$sliderRowContainer,i=this._createId(t.options.layerId);if(e.find("#"+i).length)return!1;var n=t.hasOwnProperty("_layers");if(t&&!n){var a;if(t.setOpacity){a=a||("number"==typeof t.options.opacity?t.options.opacity:1);var o=100*a,s=$('<div class="smap-opacity-row"><div class="smap-opacity-valuerow"><span class="smap-opacity-label">'+(t.options.displayName||t.options.layerId||"no name")+'</span><span class="smap-opacity-value">'+o+'</span></div><input type="text" id="'+i+'" data-provide="slider" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="'+o+'" data-slider-tooltip="hide"></div>');e.prepend(s);var r=s.find("#"+i);this.lang.transparency,r.slider({tooltip_position:"bottom"}),r.on("change",this.onSlide.bind(this)),r.on("slideStop",this.onSlideStop.bind(this)),this._setLabelValue(s.find(".smap-opacity-value"),o),this._adjustSize()}}},_removeRow:function(t){var e=this._getDefaults(!0),i=t.hasOwnProperty("_layers");if(e[t.options.layerId]&&!i){this._setLayerOpacity(t,e[t.options.layerId]);var n=this.$sliderRowContainer,a=this._createId(t.options.layerId);n.find("#"+a).parent().remove(),this._adjustSize()}},_createBtn:function(){function t(t){t.stopPropagation()}function e(e){e.on("click",t).on("dblclick",t).on("mousewheel DOMMouseScroll MozMousePixelScroll",t).on("mousedown",t)}var i=this,n=$('<button id="smap-opacity-btn" title="'+this.lang.btnTitle+'" class="btn btn-default"><span class="fa fa-sliders"></span></button>');this.$btn=n,n.on("click touchstart",function(){return i.activate(),!1}),this.$container.append(n),this.$popContainer=$('<div class="smap-opacity-popcontainer" />'),n.popover({content:function(){var t=$(this).data("bs.popover").$tip.find(".popover-content");0===t.find(".smap-opacity-popcontainer").length&&t.append(i.$popContainer),i.options.btnReset&&0===t.parent().find(".smap-opacity-btnresetrow").length&&i._addBtnReset()},placement:"bottom",trigger:"manual"}),n.on("click touchstart",function(){$(this).popover("toggle")}),n.on("shown.bs.popover",function(t){if(!i._popoverInititated){var n=$(this).next();e(n),n.addClass("opacity-popover"),i.options.showTitle||n.find("h3").remove(),i._popoverInititated=!0}$(".smap-opacity-popcontainer").show(),i._adjustSize()}),n.on("hidden.bs.popover",function(t){$(".smap-opacity-popcontainer").hide()}.bind(this))},activate:function(){return this._active?!1:(this._active=!0,this.$btn,!0)},deactivate:function(){var t=this.$btn;this.$popContainer.detach(),t.popover("destroy")},onRemove:function(t){this.$btn.remove(),delete this.$btn,delete this.$popContainer}}),L.control.opacity=function(t){return new L.Control.Opacity(t)}}]);
!function(t){function i(o){if(n[o])return n[o].exports;var e=n[o]={exports:{},id:o,loaded:!1};return t[o].call(e.exports,e,e.exports,i),e.loaded=!0,e.exports}var n={};return i.m=t,i.c=n,i.p="",i(0)}([function(t,i){"use strict";L.Control.Print=L.Control.extend({options:{position:"topleft",printUrl:"//localhost/print-servlet/print",compactConditions:!0},_lang:{sv:{caption:"Skriv ut",mTitle:"Skriv ut/Exportera",header:"Rubrik",tip_header:"Rubrik (valfritt)",descript:"Beskrivning",tip_descript:"Beskrivning (valfritt)",layout:"Pappersformat",resolution:"Upplösning",orientation:"Orientering",portrait:"Stående",landscape:"Liggande",create:"Skapa bild",close:"Stäng",loading:"Laddar…",processingPrint:"Skapar bild…",northarrow:"Nordpil",scale:"Skala",misc:"Övrigt",legend:"Teckenförklaring",couldNotLoadCapabilities:"Kan inte skriva ut/exportera. Fick inget/felaktigt svar från servern.",conditionsHeader:"Jag godkänner <span>användarvillkoren</span>",conditions:'För utdrag från kartan/flygfotot till tryck eller annan publicering, krävs tillstånd från Malmö Stadsbyggnadskontor. Vid frågor om tillstånd, användningsområden eller kartprodukter kontakta Stadsbyggnadskontorets kartförsäljning:<br>040-34 24 35 eller <a href="mailto:sbk.sma@malmo.se?subject=Best%E4lla karta">sbk.sma@malmo.se</a>.',conditionsTip:"För att kunna skriva ut måste du godkänna användarvillkoren.",confirm:"Kom ihåg mitt val"},en:{caption:"Print",mTitle:"Print/Export",header:"Rubrik",tip_header:"Header (optional)",descript:"Description",tip_descript:"Description (optional)",layout:"Layout",resolution:"Resolution",orientation:"Orientation",portrait:"Portrait",landscape:"landscape",create:"Create image",close:"Close",loading:"Loading…",processingPrint:"Creating image…",northarrow:"North arrow",scale:"Scale",misc:"Miscellaneous",legend:"Legend",couldNotLoadCapabilities:"Cannot print/export. Bad response from the server.",conditionsHeader:"I agree to these <span>terms</span>",conditions:'For excerpts from the map or aerial photo for commercial printing or other types of publication, permission is required from the City Planning Office. For questions about these terms or map products, please contact our sales office: <br> +46 40 34 24 35 or <a href="mailto:sbk.sma@malmo.se?subject=Best%E4lla karta">sbk.sma@malmo.se</a>.',conditionsTip:"To print you must agree to the user terms.",confirm:"Remember my choice"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-Print"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this._initPrint(),this._drawModal(),this._container},onRemove:function(t){this._removeBtn(),this._destroyPrint()},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-print-btn" title="'+t.lang.caption+'" class="btn btn-default"><span class="fa fa-print"></span></button>'),this.$btn.on("click touchstart",function(){return t.show(),!1}),this.$container.append(this.$btn)},_removeBtn:function(){this.$btn.remove()},_initPrint:function(){function t(){smap.cmd.notify(i.lang.couldNotLoadCapabilities,"error",{parent:$(".modal-body")}),i._modal.off("shown.bs.modal",t)}var i=this;L.mapbox=L.mapbox||{TileLayer:L.Class.extend({})},this.printProvider=L.print.provider({method:"POST",url:this.options.printUrl,autoLoad:!0,copy:"© Stadsbyggnadskontoret, Malmö stad",layout:"A4_Portrait_NoArrow_NoBar",outputFormat:"pdf",map:this.map}),this.printProvider.on("printexception printsuccess",function(){var t=i._modal.find("button[type='submit']");t.button("reset"),smap.cmd.loading(!1)}),this.printProvider.on("oncapabilitiesloaderror",function(n){i._modal&&($(".modal-body").length?t():i._modal.on("shown.bs.modal",t))}),this.printOptions={paperFormat:"A4",orientation:"Portrait",arrow:!1,scalebar:!1,dpi:96,legends:[]},this.printProvider.on("capabilitiesload",function(t){t.capabilities.printURL=t.capabilities.printURL.replace(/localhost:8080/g,"localhost").replace(document.domain,"localhost"),t.capabilities.createURL=t.capabilities.createURL.replace(/localhost:8080/g,"localhost").replace(document.domain,"localhost")})},_destroyPrint:function(){this.printProvider.destroy(),this.printProvider=null,this._modal.remove()},_getMercatorScaleForLat:function(){var t=this.map.getCenter().lat,i=this.printProvider._getScale(),n=1/Math.cos(t*Math.PI/180);return i=parseInt(Math.round(i/n))},_makeLegends:function(){var t,i,n,o,e,a=[],r=this.map._layers;for(e in r)t=r[e],o=t.options,!o||void 0!==o.legend&&o.legend===!1||(o.isBaseLayer?delete o.legend:o&&(o.legend||t instanceof L.TileLayer.WMS||t instanceof L.GeoJSON.WFS)&&(i=o.legend,i&&i.length||(i=-1===t._url.search(/\?/)?t._url+"?":t._url,i=i+"request=GetLegendGraphic&format=image/png&width=20&height=20&layer="+o.layers),i&&(n=o.displayName||"Unnamed layer"),a.push({name:n,icon:i})));var s=[{name:"Teckenförklaring",classes:a}];return s},_preprocessPrintOptions:function(t){var i={mapTitle:t.mapTitle,comment:t.comment,dpi:t.dpi,legends:this._makeLegends(),displayscale:this.lang.scale+" 1:",layout:[t.paperFormat,t.orientation,t.legend?"Legend":"NoLegend"].join("_")};return i},_preprocessLayers:function(){var t,i,n=this.map;for(t in n._layers){var o=n._layers[t];if(o.options&&o.options.layerId){if(i=smap.cmd.getLayerConfig(o.options.layerId),!i)continue;if(o instanceof L.NonTiledLayer.WMS&&!i.options.printLayer){var e=$.extend(!0,{},i.options);e.layerId+="1",i.options.printLayer={url:i.url,init:"L.TileLayer.WMS",options:e},o.options.printLayer=$.extend(!0,{},i.options.printLayer)}}}},print:function(t){if(!this.printProvider._capabilities)return!1;var i=this._modal.find("button[type='submit']");i.attr("data-loading-text",this.lang.processingPrint),i.button("loading"),smap.cmd.loading(!0),this._preprocessLayers(),this.printProvider.print(t)},_drawModal:function(){var t=this,i="resources/PrintModal.html";document.URL.search(/\/dev.html/)>-1&&(i="plugins/Print/"+i);var n=utils.isTouchOnly()?"tap":"click";$.get(i,function(i){i=utils.extractToHtml(i,t.lang),t._modal=utils.drawDialog(t.lang.mTitle,i);var o=t._modal.find(".print-conditions");t.conditionsCheckbox=t._modal.find('[name="conditions"]'),t.submitDiv=t._modal.find("#submitDiv");var e=t._modal.find("button[type=submit]"),a=t._modal.find("#conditionsLink span"),r=t._modal.find('[name="storeAnswer"]');t.options.compactConditions?("yes"===localStorage.getItem("smapConditionsAgreed")?(t.conditionsCheckbox.prop("checked",!0),r.prop({checked:!0,disabled:!1}),e.prop("disabled",!1)):t.conditionsCheckbox.prop("checked",!1),a.addClass("link"),r.change(function(){t._storeConditions(r.prop("checked"))}),r.next().on(n,function(){var t=$(this).prev();return t.prop("checked",!t.prop("checked")),!1}),o.hide(),a.on(n,function(){o.slideToggle(250)})):(a.append(":"),t._modal.find("#store").hide()),t.conditionsCheckbox.change(function(){t._setButtonState(t.conditionsCheckbox.prop("checked"))}),t.submitDiv.on(n,function(i){t.conditionsCheckbox.prop("checked")||(t.conditionsCheckbox=$("#printmodal").find('[name="conditions"]'),t.conditionsCheckbox.popover({content:t.lang.conditionsTip,trigger:"manual",placement:"right",animation:"false"}),t.conditionsCheckbox.popover("show"),i.stopPropagation(),t._modal.one(n,function(){t.conditionsCheckbox.popover("destroy")}))}),t._modal.attr("id","printmodal"),t._modal.addClass("printmodal"),t._modal.find("form").submit(function(){var i=utils.paramsStringToObject($(this).serialize(),!1);return i=t._preprocessPrintOptions(i),t.printProvider.setDpi(i.dpi),t.print(i),!1}),smap.event.trigger("smap:print:modaldrawn"),t._modal.find("[placeholder]").placeholder()})},_setButtonState:function(t){var i=$("#printmodal").find("button[type=submit]"),n=$("#printmodal").find('[name="storeAnswer"]');i.prop("disabled",t?!1:!0),n.prop({disabled:t?!1:!0})},_storeConditions:function(t){if("undefined"!=typeof Storage){var i=localStorage.getItem("smapConditionsAgreed");if("yes"===i&&t)return!1;i&&!t?localStorage.removeItem("smapConditionsAgreed"):t&&localStorage.setItem("smapConditionsAgreed","yes")}},_loadCapabilities:function(){},show:function(){var t=this;this.printProvider._capabilities||this._loadCapabilities(),this._modal?this._modal.modal("show"):smap.event.off("smap:print:modaldrawn").on("smap:print:modaldrawn",function(){t._modal.modal("show")})},hide:function(){this._modal.modal("hide")}}),L.control.Print=function(t){return new L.Control.Print(t)}}]);
!function(t){function n(e){if(i[e])return i[e].exports;var o=i[e]={exports:{},id:e,loaded:!1};return t[e].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var i={};return n.m=t,n.c=i,n.p="",n(0)}([function(t,n){"use strict";L.Control.Redirect=L.Control.extend({options:{position:"topright",url:"//malmo.se/kartor",target:"newTab",btnClass:"fa fa-external-link"},_lang:{sv:{name:"Länk"},en:{name:"Link"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-Redirect"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createButton(),this._container},_createButton:function(){var t=this,n=$('<button title="'+this.lang.name+'" class="btn btn-default"><span class="'+this.options.btnClass+'"></span></button>');n.on("click touchstart",function(){t._activate(),this.blur()}),this.$btn=n,t.$container.append(n)},_activate:function(){return this.active?!1:void(this.options.url?this.redirect():utils.log("Redirect error: Redirect URL missing. Check config-file."))},onRemove:function(t){this.$container.empty()},redirect:function(){var t,n=this.options.url;"sameWindow"===this.options.target&&(t="_self"),window.open(n,t)}}),L.control.redirectclick=function(t){return new L.Control.Redirect(t)}}]);
!function(t){function i(s){if(o[s])return o[s].exports;var e=o[s]={exports:{},id:s,loaded:!1};return t[s].call(e.exports,e,e.exports,i),e.loaded=!0,e.exports}var o={};return i.m=t,i.c=o,i.p="",i(0)}([function(t,i){"use strict";L.Control.RedirectClick=L.Control.extend({options:{position:"topright",url:"http://kartor.malmo.se/urbex/index.htm?p=true&xy=${x};${y}",btnClass:"fa fa-plane",cursor:"crosshair",destProj:"EPSG:4326",reverseAxisDest:!1,srcProj:"EPSG:4326",reverseAxisSrc:!1},_lang:{en:{name:"Click map -> redirect",hoverText:"Click the map"},sv:{name:"Klicka i kartan -> länkas vidare",hoverText:"Klicka i kartan"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(t.langCode)},_setURL:function(t){var i=this;i.options.url=t?t||i.options.url:null},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-RedirectClick"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createButton(),this._container},addHooks:function(){this.map.on("click",this.onMapClick,this),utils.isTouchOnly()?(this.staticTooltip=$('<div class="rclick-static-tooltip">'+this.lang.hoverText+"</div>"),$("#mapdiv").append(this.staticTooltip)):(this._tooltip={},this._tooltip.text=this.lang.hoverText,this.tooltip=new L.Tooltip(this.map).updateContent(this._tooltip),this.map.on("mousemove mouseup",this._onMouseMove,this))},removeHooks:function(){this.map.off("click",this.onMapClick,this),this.tooltip&&(this.map.off("mousemove mouseup",this._onMouseMove,this),this.tooltip.dispose())},_projectEPSG:function(t){var i=new Proj4js.Proj("EPSG:4326"),o=new Proj4js.Proj("EPSG:3008"),s=(L.Proj,new Proj4js.Point(t.latlng.lng,t.latlng.lat));return Proj4js.transform(i,o,s),t.latlng.lat=s.x,t.latlng.lng=s.y,t},_onMouseMove:function(t){this.tooltip.updatePosition(t.latlng)},onMapClick:function(t){this.onDone(t),this._deactivate()},_createButton:function(){var t=this,i=$('<button title="'+this.lang.name+'" class="btn btn-default"><span class="'+this.options.btnClass+'"></span></button>');i.on("click touchstart",function(){return t.active&&t.active!==!1?(t._deactivate(),$("#mapdiv").focus(),t.active=!1):(t._deactivate(),t._activate(),t.active=!0),!1}),this.$btn=i,t.$container.append(i)},_selection:function(t){var i,o,s=[smap.cmd.getControl("L.Control.SelectWMS"),smap.cmd.getControl("L.Control.SelectVector")];for(o=0;o<s.length;o++)i=s[o],i&&(t===!0?i.activate():i.deactivate())},_activate:function(){return this.active?!1:(this._deactivateAll(),this.$btn.addClass("active"),this.$btn.blur(),void(this.options.url?(this.removeHooks(),this.addHooks(),$("#mapdiv").css({cursor:this.options.cursor}),this._selection(!1)):(this._deactivate(),$("#mapdiv").focus(),utils.log("RedirectClick error: Redirect URL missing. Check config-file."))))},_deactivate:function(){this.active=!1,this.$btn.removeClass("active"),this.removeHooks(),this.staticTooltip&&this.staticTooltip.remove(),$("#mapdiv").css({cursor:""}),this._selection(!0)},_deactivateAll:function(){for(var t=smap.cmd.getControls("RedirectClick"),i=0;i<t.length;i++)t[i]._deactivate()},onRemove:function(t){this.$container.empty(),this.staticTooltip&&this.staticTooltip.remove()},onDone:function(t){var i=this,o=i.options.url,s=t.latlng;this.options.destProj&&this.options.destProj!==this.options.srcProj&&(s=utils.projectLatLng(s,this.options.srcProj,this.options.destProj,this.options.reverseAxisSrc||!1,this.options.reverseAxisDest||!1)),this.staticTooltip&&this.staticTooltip.remove(),o=o.replace(/\${x}/g,utils.round(s.lng,5)).replace(/\${y}/g,utils.round(s.lat,5)),window.open(o,this.lang.name)}}),L.control.redirectclick=function(t){return new L.Control.RedirectClick(t)}}]);
!function(e){function t(o){if(s[o])return s[o].exports;var a=s[o]={exports:{},id:o,loaded:!1};return e[o].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t){"use strict";L.Control.Search=L.Control.extend({options:{whitespace:"%20",wsOrgProj:"EPSG:3006",pxDesktop:992,clearEntryAfterSearch:!1,funcSetPosition:function(){var e=smap.cmd.getControl("L.Control.LayerSwitcher");e||$("#smap-search-div").css("left","10px")},gui:!1,addToMenu:!1,popupContent:null,zoom:15,iconOptions:$.extend({},(new L.Icon.Default).options,{iconUrl:L.Icon.Default.imagePath+"/marker-icon.png"}),source:null,acHeight:null,autoScrollAcOnRowNbr:2,acOptions:{items:100}},_lang:{sv:{search:"Sök adress",addressNotFound:"Den sökta adressen hittades inte",remove:"Ta bort"},en:{search:"Search address",addressNotFound:"The searched address was not found",remove:"Remove"}},_setLang:function(e){e=e||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(e.langCode);var t=this.options.funcSetPosition;t&&smap.event.on("smap.core.pluginsadded",function(){t()})},onAdd:function(e){var t=this,s=this;if(this.map=e,this._container=L.DomUtil.create("div","leaflet-control-search"),L.DomEvent.disableClickPropagation(this._container),this._searchLayer=L.layerGroup(),this.map.addLayer(this._searchLayer),(void 0===this.options.gui||this.options.gui===!0)&&(this.$container=$(this._container),this.$container.css("display","none"),this._makeSearchField(),this.map.on("click",this._blurSearch)),this.options.vectorSearch&&(this._cachedFeatures=this._cachedFeatures||{},this.map.on("layeradd",this._onLayerAdd,this),this.map.on("layerremove",this._onLayerRemove,this)),this.options.wfsSearch){this._cachedFeatures=this._cachedFeatures||{};var o=this.options.wfsSearch;this._setACOptions(o);var a,n;this._wfsLayerGroup=L.layerGroup();for(var r=0,i=o.layerIds.length;i>r;r++)if(a=smap.cmd.getLayerConfig(o.layerIds[r])){var p;!function(){var o=function r(){this._cacheLayer(p,!1,this.options.wfsSearch),p.off("load",r)};n=$.extend(!0,{},a),n.options.layerId+=1,p=smap.core.layerInst._createLayer(n),t._initVectorSearch(p),t._wfsLayerGroup.addLayer(p),s.map.whenReady(function(){p._map=e,p.on("load",o,s),p._refresh({force:!0,bounds:!1}),p._map=null},1e3)}()}}return this.__onApplyParams=this.__onApplyParams||$.proxy(this._onApplyParams,this),smap.event.on("smap.core.applyparams",this.__onApplyParams),this.__onCreateParams=this.__onCreateParams||$.proxy(this._onCreateParams,this),smap.event.on("smap.core.createparams",this.__onCreateParams),$(".leaflet-top.leaflet-left").addClass("with-search-bar"),s._container},_blurSearch:function(){$(".smap-search-div input").blur()},onRemove:function(e){smap.event.off("smap.core.applyparams",this.__onApplyParams),smap.event.off("smap.core.createparams",this.__onCreateParams),this.map.off("click",this._blurSearch),$(".leaflet-top.leaflet-left").removeClass("with-search-bar")},_onLayerAdd:function(e){var t=e.layer||{};t.options&&!t.options._silent&&t.options.layerId&&!t.feature&&this.options.vectorSearch&&$.inArray(t.options.layerId,this.options.vectorSearch.layerIds)>-1&&(this._setACOptions(this.options.vectorSearch),this._initVectorSearch(t))},_onLayerRemove:function(e){var t=e.layer||{};t.options&&!t.options._silent&&t.options.layerId&&!t.feature&&this.options.vectorSearch&&$.inArray(t.options.layerId,this.options.vectorSearch.layerIds)>-1&&this._cacheLayer(t,!0)},_cacheProperties:function(e,t,s){var o,a,n=[];a=$.extend(!0,{},{name:e[t[0]]}),n=[];for(var r=0,i=t.length;i>r;r++)o=e[t[r]],o&&o.length&&n.push(s[r]+"=="+o);return a.searchWords=n.join("&&"),a},_cacheLayer:function(e,t,s){t=t||!1,s=s||{},this._acVector=this._acVector||[];var o,a,n=[],r=this._cacheProperties,i=s.keyVals,p=this._acVector,c=[],h=[];for(var l in i)c.push(l),h.push(i[l]);e.eachLayer(function(e){o=e.feature.properties,a=r(o,c,h),p.splice(a),t||n.push(a)}),this._acVector=this._acVector.concat(n),$("#smap-search-div input").prop("disabled",!1)},_initVectorSearch:function(e){var t=this,s=e.options;return s?($("#smap-search-div input").prop("disabled",!0),void($.isEmptyObject(e._layers)?!function(){var s=function o(t){this._cacheLayer(e,!1,this.options.vectorSearch),e.off("load",o)};e.on("load",s,t)}():this._cacheLayer(e,!1,this.options.vectorSearch))):!1},_setACOptions:function(e){var t=this;for(var s in e.keyVals)break;var o=e.keyVals[s],a=e.suffix,n=this.options.suffix;this.options.typeaheadOptions=$.extend(!0,{},this.options.typeaheadOptions,{source:$.proxy(function(e,t){e=encodeURIComponent(e);var s=this.options.wsAcUrl;s?(this.options.whitespace&&(e=e.replace(/%20/g,this.options.whitespace)),this._proxyInst&&this._proxyInst.abort(),smap.cmd.loading(!0),this._proxyInst=$.ajax({type:"GET",url:this.options.useProxy?smap.config.ws.proxy+encodeURIComponent(s+"?q=")+e:s+"?q="+e,dataType:"text",context:this,success:function(e){for(var s,o=e.split("\n"),a=[],n=0,r=o.length;r>n;n++)s=$.trim(o[n]),s.length&&a.push({name:s,searchWords:"Adress=="+s});a=this._acVector.concat(a),t(a)},error:function(){},complete:function(){smap.cmd.loading(!1)}})):t(this._acVector)},this),displayText:function(e){return e.searchWords},highlighter:function(e){for(var t,s={},o=e.split("&&"),a=0,n=o.length;n>a;a++)t=o[a].split("=="),s[t[0]]=t[1];var r="",a=0;for(var i in s)r+=0===a?'<div style="font-size:1.2em;">'+s[i]+"</div>":"<div><span>"+i+"</span>:&nbsp;<span>"+s[i]+"</span></div>",a++;return r},updater:function(e){for(var t,s={},r=e.searchWords.split("&&"),i=0,p=r.length;p>i;i++)t=r[i].split("=="),s[t[0]]=t[1];return s[o]?e.name+" "+a:e.name+" "+n},afterSelect:function(s){if(t._searchLayer.clearLayers(),t.options.clearEntryAfterSearch&&$(".smap-search-div input").val(null),encodeURIComponent(s).search(encodeURIComponent(n))>-1)s=$.trim(s.replace(n,"")),t._geoLocate(s,"");else if(encodeURIComponent(s).search(encodeURIComponent(a))>-1){s=$.trim(s.replace(a,""));for(var o in e.keyVals)break;var r,i,p,c,h=t.map;for(c in h._layers)if(r=h._layers[c],r._layers)for(p in r._layers)if(i=r._layers[p],i.feature&&i.feature.properties[o]===s){var l;return l=i.getLatLng?i.getLatLng():i.getBounds().getCenter(),h.setView(l,17),void h.fire("selected",{feature:i.feature,selectedFeatures:[i],layer:r,latLng:l,shiftKeyWasPressed:!1})}t._wfsLayerGroup.eachLayer(function(e){e.eachLayer(function(a){if(a.feature&&a.feature.properties[o]===s){t._searchLayer.addLayer(a),this.marker=a;var n;return n=a.getLatLng?a.getLatLng():a.getBounds().getCenter(),h.setView(n,17),void h.fire("selected",{feature:a.feature,selectedFeatures:[a],layer:e,latLng:n,shiftKeyWasPressed:!1})}})})}}});var r=$("#smap-search-div input");r.typeahead("destroy"),this._initAutoComplete(r)},_onApplyParams:function(e,t){if(t.POI){var s=t.POI instanceof Array?t.POI[0]:t.POI;s=s.replace(/--c--/g,",");var o=t.POI instanceof Array&&t.POI.length>1?t.POI[1]:!1,a=!1,n=smap.core.paramInst.getWebParamsAsObject(),r=config.params,i=n.ZOOM||this.options.zoom;n.CENTER||(a=!0,!n.POI&&r.CENTER&&(a=!1,i=t.ZOOM)),this._geoLocate(decodeURIComponent(s),{setView:a,zoom:i,showPopup:o})}},_onCreateParams:function(e,t){if(this.marker&&this.marker.options.q){var s=this.marker.getPopup()._isOpen?!0:!1;t.poi=[encodeURIComponent(this.marker.options.q.replace(/,/g,"--c--"))],s&&t.poi.push(1)}},_rmAdressMarker:function(e){null!=e&&(this._searchLayer.removeLayer(e),this.addressMarker=null)},_makeSearchField:function(){function e(){var e=$(window).width();if(!(e>=o.options.pxDesktop)&&utils.isTouchOnly()){var t=$("#smap-search-bg");t.length||(t=$('<div id="smap-search-bg" />'),a.addClass("search-active"),$("#mapdiv").append(t),setTimeout(function(){t.addClass("search-bg-visible")},1))}}function t(){var e=$(window).width();e>=o.options.pxDesktop||!utils.isTouchOnly()||(a.removeClass("search-active"),$("#smap-search-bg").removeClass("search-bg-visible"),setTimeout(function(){$("#smap-search-bg").remove()},300))}function s(e){e.stopPropagation()}var o=this,a=$('<div id="smap-search-div" class="smap-search-div input-group input-group-lg"><span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span><input autocorrect="off" autocomplete="off" data-provide="typeahead" type="text" class="form-control" placeholder="'+this.lang.search+'"></input></div>'),n=a.find("input");n.placeholder(),L.Browser.msTouch&&n.attr("pattern","[0-9]"),n.on("dblclick",s).on("mousedown",s).on("focus",function(){$(this).parent().addClass("smap-search-div-focused"),$("#mapdiv").trigger("touchstart"),o.map.fire("mousedown"),e()}).on("blur",function(){$(this).parent().removeClass("smap-search-div-focused")}).on("touchstart",function(){$(this).focus()}),a.on("click touchstart",function(e){$(this).find("input").focus(),e.stopImmediatePropagation()}),n.on("blur",t),$("#maindiv").append(a),smap.event.on("smap.core.pluginsadded",function(){var e=$("#smap-menu-div nav");e.length&&a.addClass("smap-search-div-in-toolbar")});var r=this.options.whitespace,i=this.options._geoLocate||this._geoLocate,p={items:5,minLength:2,highlight:!0,hint:!0,afterSelect:function(e){return smap.cmd.loading(!0),i.call(o,e),t(),e}};$.extend(p,this.options.acOptions||{}),this.options.source?p.source=$.proxy(this.options.source,this):this.options.wsAcUrl?p.source=function(e,t){e=encodeURIComponent(e);var s=o.options.wsAcUrl;r&&(e=e.replace(/%20/g,r)),o._proxyInst&&o._proxyInst.abort(),o._proxyInst=$.ajax({type:"GET",url:o.options.useProxy?smap.config.ws.proxy+encodeURIComponent(s+"?q=")+e:s+"?q="+e,dataType:"text",success:function(e){var s=e.split("\n");t(s)},error:function(){}})}:this.options.wsAcLocal&&this.options.wsAcLocal instanceof Array&&(p.source=this.options.wsAcLocal),this._initAutoComplete(n,p)},_initAutoComplete:function(e,t){t=t||this.options.typeaheadOptions;var s=this.options.autoScrollAcOnRowNbr;if(this._onKeyPress=this._onKeyPress||function(e){var t=38===e.which,o=40===e.which;if(t||o){var a=$(".typeahead.dropdown-menu li.active"),n=a.parent().find("li").length;if(t&&1===a.index()||o&&a.index()===n-1)a.parent().scrollTo($(".typeahead.dropdown-menu li:first"),0);else if(t&&0===a.index())a.parent().scrollTo($(".typeahead.dropdown-menu li:last"),0);else if(a.index()>=s){for(var r=a,i=0;s/2>i;i++)r=r.prev();r&&r.length&&a.parent().scrollTo(r,0)}}},e.off("keydown",this._onKeyPress).on("keydown",this._onKeyPress),e.typeahead(t),this.options.acHeight){var o=e.data("typeahead").$menu;o.css({"max-height":this.options.acHeight})}},_processLinks:function(e){var t=$("<div />");return t.append(e),t.find("a").each(function(){var e=$("<a onclick=\"window.open('"+$(this).prop("href")+'\')"><i class="fa fa-external-link"></i> '+$(this).text()+"</a>");$(this).after(e),$(this).remove()}),t.html()},_geoLocate:function(e,t){t=t||{};var s={setView:!0,showPopup:!0};t=$.extend({},s,t),this.options.qPattern&&(e=utils.extractToHtml(this.options.qPattern,{q:e})),e=encodeURIComponent(e);var o=this.options.wsLocateUrl;if(this.options.useProxy){o=smap.config.ws.proxy+encodeURIComponent(o+"?q=")+e;var a=this.options.whitespace;a&&(o=o.replace(/%20/g,a))}else o=o+"?q="+e;var n={success:function(s){function o(e){$("#smap-search-popupbtn").off("click").on("click",function(){return a._searchLayer.removeLayer(a.marker),a.marker=null,!1})}var a=this;if(this.marker&&(this._searchLayer.removeLayer(this.marker),this.marker=null),!s.features.length)return void smap.cmd.notify(this.lang.addressNotFound,"error");var n=s.features[0],r=n.geometry.coordinates,i=L.latLng(r[1],r[0]),p="EPSG:4326";if(this.options.wsOrgProj&&this.options.wsOrgProj!==p){var c=window.proj4(this.options.wsOrgProj,p,[i.lng,i.lat]);i=L.latLng(c[1],c[0])}this.map.off("popupopen",o),this.map.on("popupopen",o),this.marker=L.marker(i,{iconOptions:L.icon(this.options.iconOptions)}).addTo(this._searchLayer),this.marker.options.q=e;var h='<div class="smap-search-btnremove"><button id="smap-search-popupbtn" class="btn btn-default btn-sm">'+this.lang.remove+"</button></div>",l='<p class="smap-search-popupcontent lead">'+decodeURIComponent(e)+"</p>",u=l+h,d=u;this.options.popupContent&&(d="",d+=l,d+=this._processLinks(utils.extractToHtml(this.options.popupContent,n.properties)),d+=h),this.marker.bindPopup(d);var m=t.zoom||this.options.zoom;t.setView?this.map.setView(i,m,{animate:!1}):this.marker._popup.options.autoPan=!1,t.showPopup&&this.marker.openPopup(),this.options.clearEntryAfterSearch&&$(".smap-search-div input").val(null),$(".smap-search-div input").blur(),setTimeout(function(){$(".smap-search-div input").blur()},100)},complete:function(){smap.cmd.loading(!1)}};$.ajax({url:o,type:"GET",dataType:"json",context:this,success:this.options.onLocateSuccess||n.success,complete:n.complete})},CLASS_NAME:"L.Control.Search"}),L.control.search=function(e){return new L.Control.Search(e)}}]);
!function(e){function t(a){if(i[a])return i[a].exports;var r=i[a]={exports:{},id:a,loaded:!1};return e[a].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t){"use strict";L.Control.SelectVector=L.Control.extend({options:{position:"bottomright",selectStyle:{weight:5,color:"#00FFFF",fillColor:"#00FFFF",opacity:1,fillOpacity:.5}},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_selectedFeatures:[],_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode);var t=this;this._onFeatureClick=function(e){var i=200;t._clickWasRegistered||(t.onFeatureClick(e),t._clickWasRegistered=!0,setTimeout(function(){t._clickWasRegistered=!1},i))}},activate:function(){this._active=!0},deactivate:function(){this._active=!1},onAdd:function(e){return this.map=e,this._container=L.DomUtil.create("div","leaflet-control-selectvector"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.$container.css("display","none"),this._bindEvents(),this.activate(),this._container},onRemove:function(e){this.map.off("layeradd",this._onLayerAdded),this.map.off("click",this._onMapClick),this.deactivate()},_bindEvents:function(){this._onLayerAdded=$.proxy(this.onLayerAdded,this),this._onLayerRemoved=$.proxy(this.onLayerRemoved,this),this._onMapClick=$.proxy(this.onMapClick,this),this.map.on("layeradd",this._onLayerAdded),this.map.on("layerremove",this._onLayerRemoved),this.map.on("click",this._onMapClick)},onMapClick:function(){this._selectedFeatures=[]},_vectorLayers:[],onLayerAdded:function(e){var t=this,i=e.layer,a=i.hasOwnProperty("_layers");a&&i.on&&(i.on("load",function(){var e=function(e){e.options=e.options||{},e.options.layerId=i.options.layerId,e.off("click",t._onFeatureClick),e.on("click",t._onFeatureClick)};this.eachLayer&&this.eachLayer(e),this.off("dblclick",t._onFeatureClick).on("dblclick",t._onFeatureClick)}),this._vectorLayers.push(i))},onLayerRemoved:function(e){if(e.layer.options&&e.layer.options.layerId){var t=e.layer.options.layerId;if(t&&e.layer._layers){var i=$.inArray(e.layer,this._vectorLayers);i>-1&&this._vectorLayers.splice(i,1)}}},_layerFromFeature:function(e,t){var i,a,r=t._layers;for(var s in r){var n=r[s];if(n.feature&&(i=n.feature.id||n.feature.ID,a=e.id||e.ID,i===a))return n}return null},unselect:function(e){var t=e.layerId,i=smap.cmd.getLayer(t),a=$.inArray(e,this._selectedFeatures);this._selectedFeatures.splice(a,1);var r=utils.getLayerFromFeature(e,i)||i;i.resetStyle.call(i,r),this._map.fire("unselected",{feature:e})},onFeatureClick:function(e){if(!this._active)return!1;var t=e.layer&&e.layer.feature?e.layer.feature:e.target.feature||e.target,i=e.originalEvent?e.originalEvent.shiftKey||!1:!1,a=e.target,r=a.options.layerId||e.layer.options.layerId,s=smap.core.layerInst._getLayer(r);if(i===!1&&(this._selectedFeatures=[],s&&s.resetStyle)){var n=s.resetStyle;s.eachLayer(function(e){n.call(s,e)});for(var o=this._vectorLayers,l=0,c=o.length;c>l;l++)h=o[l],h.resetStyle&&h!==s&&(h._layers?h.eachLayer(function(e){h.resetStyle(e)}):h.resetStyle(h))}var y=$.inArray(t,this._selectedFeatures);if(i===!0&&y>-1){this._selectedFeatures.splice(y,1),this._map.fire("unselected",{feature:t});var h=this._layerFromFeature(t,s);s.resetStyle.call(s,h)}else{if(t.layerId=r,t.uniqueKey=s&&s.options?s.options.uniqueKey:t.layerId,this._selectedFeatures.push(t),s){var u=this._layerFromFeature(t,s);u&&u.setStyle&&u.setStyle(s.options.selectStyle||this.options.selectStyle)}this._map.fire("selected",{feature:t,selectedFeatures:this._selectedFeatures,layer:s||t,latLng:e.latlng,shiftKeyWasPressed:e.originalEvent?e.originalEvent.shiftKey||!1:!1})}}}),L.control.selectVector=function(e){return new L.Control.SelectVector(e)}}]);
!function(e){function t(i){if(s[i])return s[i].exports;var n=s[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t){"use strict";L.Control.SelectWMS=L.Control.extend({options:{wmsVersion:"1.3.0",info_format:"text/plain",maxFeatures:20,buffer:12,useProxy:!1},_layers:[],_selectedFeatures:[],initialize:function(e){L.setOptions(this,e)},onAdd:function(e){return this.map=e,this.activate(),this._container=L.DomUtil.create("div","leaflet-control-selectwms"),$(this._container).css("display","none"),L.DomEvent.disableClickPropagation(this._container),this._container},onRemove:function(e){this.deactivate()},onSuccess:function(e){e=e||[];for(var t,s,i,n,r,a,o,l,c=0,p=e.length;p>c;c++)if(t=e[c],a=t[0],o=t[1],l=o.params,s=a.features,a)if(a.features){var i,n,r,s=a.features;if(!s.length)continue;for(var h=0,u=s.length;u>h;h++){if(i=s[h],n=smap.cmd.getLayerConfigBy("options.layers",l.layers)||smap.cmd.getLayerConfigBy("options.selectOptions.layers",l.layers),!n&&i.id){var f=i.id.split(".")[0];if(l.layers.search(f)>-1)for(var y=l.layers.split(","),m=0,d=y.length;d>m;m++)if(y[m].search(f)>-1){var g=y[m];n=smap.cmd.getLayerConfigBy("options.layers",g)||smap.cmd.getLayerConfigBy("options.selectOptions.layers",g)}}if(!n)break;r=n.options,r.selectOptions&&r.selectOptions.srs&&"EPSG:4326"!==r.selectOptions.srs&&utils.projectFeature(i,r.selectOptions.srs,"EPSG:4326",{});var _=i.geometry.type;if("Point"===_||"MultiPoint"===_){var v=[];switch(_){case"Point":v=i.geometry.coordinates;break;case"MultiPoint":v=i.geometry.coordinates[0]}i.latLng=L.latLng([v[1],v[0]])}else i.latLng=o.latLng;i.options=$.extend({},r),s[h]=i}this._selectedFeatures=this._selectedFeatures.concat(s)}else{var x,S,b=o.latLng;for(var O in a){x=a[O];var C=O.split(":"),P=C[C.length-1],n=smap.cmd.getLayerConfigBy("layerId",P,{inText:!0})||smap.cmd.getLayerConfigBy("layers",P,{inText:!0})||smap.cmd.getLayerConfigBy("options.selectOptions.layers",P,{inText:!0});if(n&&n.options&&n.options.layerId)for(var E=n.options.layerId,h=0,u=x.length;u>h;h++){S=x[h];var i={geometry:{coordinates:[b.lng,b.lat]},latLng:L.latLng([b.lat,b.lng]),properties:S,layerId:E,options:n.options};S&&$.isEmptyObject(S)===!1&&this._selectedFeatures.push(i)}}}this._selectedFeatures.length&&this.map.fire("selected",{layer:this,feature:this._selectedFeatures.length?this._selectedFeatures[0]:null,selectedFeatures:this._selectedFeatures})},_applyParam:function(e){var t,s,i,n,r,a=JSON.parse(decodeURIComponent(e)),o=[];for(s in a)i=a[s],i.xy&&(t=smap.core.layerInst.showLayer(s),o.push(t));n=i.xy&&i.xy.length?i.xy[0]:null,n&&(r=L.latLng(n[1],n[0]),this.onMapClick({latlng:r,_layers:o}))},onApplyParams:function(e,t){t.SEL&&this._applyParam(decodeURIComponent(t.SEL))},activate:function(){return this._active?!1:(this._active=!0,void this._bindEvents())},deactivate:function(){this._active=!1,this._unbindEvents()},_bindEvents:function(){this._onApplyParams=this._onApplyParams||$.proxy(this.onApplyParams,this),smap.event.on("smap.core.applyparams",this._onApplyParams),this.map.on("layeradd",this.onLayerAdd,this).on("layerremove",this.onLayerRemove,this).on("click",this.onMapClick,this).on("dblclick",this.onMapDblClick,this)},_unbindEvents:function(){smap.event.off("smap.core.applyparams",this._onApplyParams),this.map.off("layeradd",this.onLayerAdd,this).off("layerremove",this.onLayerRemove,this).off("click",this.onMapClick,this).off("dblclick",this.onMapDblClick,this)},onLayerAdd:function(e){var t=e.layer;this._layerShouldBeAdded(t)===!0&&this._layers.push(t)},onLayerRemove:function(e){var t=e.layer,s=this._hasLayer(t);s!==!1&&this._layers.splice(s,1)},onMapDblClick:function(e){this._dblclickWasRegistered=!0,this.xhr&&this.xhr.abort(),setTimeout($.proxy(function(){this._dblclickWasRegistered=!1},this),400)},onMapClick:function(e){this._selectedFeatures=[];var t=e.latlng;this.xhr&&this.xhr.abort();var s=e._layers||this._layers;if(s.length){var i,n,r,a,o,l=this,c={},p=0;$.each(s,function(e,t){if(o=t.options||{},n=t._url||t._wmsUrl,r=n.toUpperCase(),c[r]){var s=c[r].selectOptions||{},i=o.selectOptions||{},h=s.info_format||l.options.info_format;a=h&&i.info_format&&h!==i.info_format,a&&(r+="_1")}c[r]||(c[r]={layerNames:[],url:n,wmsVersion:t._wmsVersion,layerId:o.layerId,selectOptions:o.selectOptions||{}},p+=1),o.selectOptions&&o.selectOptions.layers?c[r].layerNames.push(o.selectOptions.layers):c[r].layerNames.push(o.layers)});var h,u;setTimeout($.proxy(function(){if(this._dblclickWasRegistered===!0);else{var e=[];for(var s in c){i=c[s],h=i.selectOptions.parser,u=this._makeParams({layers:i.layerNames.join(","),version:i._wmsVersion||this.options.wmsVersion,info_format:i.selectOptions.info_format||this.options.info_format,latLng:t,srs:i.selectOptions.srs||"EPSG:4326"},i.selectOptions),"text/plain"===u.info_format&&(u.version="1.1.1");var n=this.onSuccess;this.request(i.selectOptions.url||i.url,u,{onSuccess:function(t,s){p-=1,e.push([t,s]),0>=p&&n.call(this,e)},onError:function(){p-=1},layerId:i.layerId,latLng:t},h)}}},this),100)}},_layerShouldBeAdded:function(e){var t=e.wmsParams?!0:!1;return e.options&&e.options.selectable&&e.options.selectable===!0&&this._hasLayer(e)===!1&&t===!0?!0:!1},_hasLayer:function(e){for(var t=this._layers,s=0,i=t.length;i>s;s++)if(e===t[s])return s;return!1},_makeParams:function(e,t){t=t||{};var s=this.map.latLngToContainerPoint(e.latLng),i=this.map.getBounds(),n=i.toBBoxString();if(t.srs&&"EPSG:4326"!==e.srs){var r=i.getSouthWest(),a=i.getNorthEast();r=utils.projectLatLng(r,"EPSG:4326",e.srs,!1,!1),a=utils.projectLatLng(a,"EPSG:4326",e.srs,!1,!1),i=L.latLngBounds(r,a),n=i.toBBoxString()}if(t.reverseAxisBbox){var o=n.split(",");n=[o[1],o[0],o[3],o[2]].join(",")}var l=$.extend({},{service:"WMS",request:"GetFeatureInfo",version:this.options.version,bbox:n,layers:null,styles:"",typename:e.layers,query_layers:e.layers,info_format:e.info_format,feature_count:this.options.maxFeatures,x:utils.round(s.x),y:utils.round(s.y),buffer:this.options.buffer,width:utils.round(this.map.getSize().x),height:utils.round(this.map.getSize().y),srs:"EPSG:4326",exceptions:"application%2Fvnd.ogc.se_xml"},e);return delete l.latLng,l},_parseTextArcGis:function(e,t){out={},dict={},features=[],numcols=0,featurtype="",rows=e.split("\n"),cols=rows[0].split(";"),cols.length%2==1?numcols=(cols.length-1)/2:numcols=cols.length/2;for(var s=0;s<numcols;s++)dict[cols[s]]=cols[s+numcols];return features[0]=dict,featurtype=t,out[featurtype]=features,out},_parseText:function(e){for(var t,s,i,n,r,a,o={},l={},c=e.split("\n"),p=0,h=c.length;h>p;p++)if(t=c[p],0!==$.trim(t).length)if(-1!==t.search("=")){if(s=t.split("="),s.length>2){var u=s.slice(1);n=u.join("=")}else n=s[1];n=$.trim(n),"null"==n.toLowerCase()&&(n="");var f=/^[0-9.]+$/.test(n),y=n.split("."),m=y.length<=2&&y[0].length>0&&(1===y.length||2===y.length&&y[1].length>0);if(f===!0&&m){try{switch(y.length){case 1:r=parseInt(n);break;case 2:r=parseFloat(n)}}catch(d){}r&&isNaN(r)===!1&&(n=r)}i=$.trim(s[0]),l[i]=n}else{var g=t.search(/'/);if(g>-1){t=t.substring(g+1),g=t.search(/'/),a&&o[a]&&$.isEmptyObject(l)===!1&&(o[a].push($.extend({},l)),l={}),a=t.substring(0,g),o[a]||(o[a]=[]);continue}a&&o[a]&&$.isEmptyObject(l)===!1&&t.search(/\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-/gi)>-1?(o[a].push($.extend({},l)),l={}):i&&n&&(l[i]=n+" "+t)}return a&&o[a]&&$.isEmptyObject(l)===!1&&o[a].push($.extend({},l)),o},request:function(e,t,s,i){t=t||{},s=s||{};var n=null;this.options.useProxy?e=smap.config.ws.proxy+encodeURIComponent(e+"?"+$.param(t)):n=t,this.xhr=$.ajax({url:e,data:n,type:"GET",dataType:"text",context:this,success:function(e,n,r){var a,o=t.info_format;if("undefined"!=typeof i)"PLAINTEXT"==i?a=this._parseText(e):"JSON"==i?a=JSON.parse(e):"ARCGIS"==i&&(a=this._parseTextArcGis(e,s.layerId));else if("text/plain"===o)a=this._parseText(e);else{if("application/json"!==o)return!1;a=JSON.parse(e)}s.onSuccess.call(this,a,{latLng:s.latLng,map:this.map,context:this,params:t})},error:s.onError})},CLASS_NAME:"L.Control.SelectWMS"}),L.control.selectWMS=function(e){return new L.Control.SelectWMS(e)}}]);
!function(t){function n(i){if(o[i])return o[i].exports;var a=o[i]={exports:{},id:i,loaded:!1};return t[i].call(a.exports,a,a.exports,n),a.loaded=!0,a.exports}var o={};return n.m=t,n.c=o,n.p="",n(0)}([function(t,n){"use strict";L.Control.ShareLink=L.Control.extend({options:{position:"bottomright",addToMenu:!1,maxLen:2083,root:null},_lang:{sv:{caption:"Länk till kartan",close:"Stäng",tooLong:"För lång länk",tooLongUrl:"Notera! Länken är för lång för att fungera i en del äldre webbläsare. Ta bort ett eller flera ritade objekt för att göra länken kortare."},en:{caption:"Share link",close:"Close",tooLong:"Too long link",tooLongUrl:"Note! The link may not work in some older browsers. Please remove one or more drawn features to make it shorter."}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-ShareLink"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this._container},activate:function(){var t=this,n=this,o=smap.cmd.createParams(this.options.root||!0),i=$('<div class="form-group"><input type="text" class="form-control" placeholder="'+this.lang.caption+'"></div>'),a=i.find("input");a.val(o);var e=function(t){t.setSelectionRange?t.setSelectionRange(0,9999):$(t).select()};if(!this._$dialog){var l='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+"</button>";this._$dialog=utils.drawDialog(this.lang.caption,i,l),this._$dialog.attr("id","slink-modal"),a.on("tap click",function(){e(this)}),this._$dialog.on("shown.bs.modal",function(){e(a[0])}),this._$dialog.on("hide.bs.modal",function(){$(this).find("input[type=text]").blur()}),this._$dialog.on("hidden.bs.modal",function(){n._$dialog.empty().remove(),n._$dialog=null})}if(o.length>this.options.maxLen){var s,r;!function(){var n=function o(){s.find("input[type=text]").prop("disabled",!0),s.off("shown.bs.modal",o)};s=t._$dialog,r=smap.cmd.notify(t.lang.tooLongUrl,"warning",{parent:i.parent()}),r.removeClass("map-alert"),s.find("input[type=text]").val(t.lang.tooLong),s.on("shown.bs.modal",n)}()}this._$dialog.modal("show")},_createBtn:function(){var t=this,n=$('<button id="smap-sharelink-btn" title="'+this.lang.caption+'" class="btn btn-default"><span class="fa fa-link"></span></button>');n.on("click touchstart",function(){return t.activate(),!1}),this.$container.append(n)},onRemove:function(t){}}),L.control.sharePos=function(t){return new L.Control.SharePos(t)}}]);
!function(t){function e(s){if(n[s])return n[s].exports;var o=n[s]={exports:{},id:s,loaded:!1};return t[s].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e){"use strict";L.Control.SharePosition=L.Control.extend({options:{position:"bottomright",autoActivate:!1,wfsSource:"//kartor.malmo.se:8081/geoserver/wfs",wfsFeatureType:"sandbox:sharedpositions",wfsUri:"//www.malmo.se/sandbox/",useProxy:!0,maxAge:15,_refreshIntervalMs:1e4,_storeIntervalMs:1e4},_lang:{sv:{dTitle:"Dela position",dShare:"Dela!",yourName:"Ditt namn",stopSharing:"Sluta dela",btnCancel:"Avbryt"},en:{dTitle:"Share position",dShare:"Share!",yourName:"Your name",stopSharing:"Stop sharing",btnCancel:"Cancel"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},deactivate:function(){this._stopRefresh(),$("#smap-share-btn").removeClass("btn-danger"),this.dialog.find("input").val(null),$("#smap-share-btn").hide(),this.map.removeLayer(this.layer)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-shareposition"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawGui(),this._bindEvents(),this._container},onRemove:function(t){t.stopLocate()},_drawGui:function(){var t=$('<button id="smap-share-btn" class="btn btn-default" type="button"><span class="fa fa-user"></span></button>');t.hide(),this.$container.append(t);var e=this;smap.event.on("smap.core.pluginsadded",function(){$(".leaflet-control-Geolocate").before(e.$container)});var n='<div class="form-group"><label>'+this.lang.yourName+'</label><input type="text" class="form-control" placeholder="'+this.lang.yourName+'"></input></div>',s=$('<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.btnCancel+'</button><button type="button" class="btn btn-primary">'+this.lang.dShare+"</button>");this.dialog=utils.drawDialog(this.lang.dTitle,n,s)},_makeFilter:function(){var t=this.options.maxAge,e=new Date,n=e.getTime(),s=n-60*t*1e3,o=new Date(s),a=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN,property:"datetime_changed",value:o}),i=new OpenLayers.Format.Filter({version:"1.1.0"}),r=new OpenLayers.Format.XML,l=r.write(i.write(a));return l},_addLayer:function(){var t=this;this.layer=smap.core.layerInst._createLayer({init:"L.GeoJSON.WFS",url:this.options.wfsSource,options:{noBindZoom:!0,noBindDrag:!0,layerId:"_shareposition",displayName:"Shared locations",featureType:this.options.wfsFeatureType,attribution:"Malmö stads WFS",inputCrs:"EPSG:4326",selectable:!0,popup:'<span><strong>${text_username}</strong>&nbsp;&nbsp;(<span style="white-space:nowrap;">${function(p) {var d = new Date(p.datetime_changed);var dNow = new Date(); var dDiff = new Date( Math.abs(dNow.getTime() - d.getTime()) ); return dDiff.getMinutes(); }}</span> min ago)</span>',hoverColor:"#FF0",zIndex:350,reverseAxis:!1,reverseAxisBbox:!0,uniqueKey:"id",params:{typeName:"sandbox:sharedpositions",version:"1.1.0",maxFeatures:1e4,format:"text/geojson",outputFormat:"json"}}}),this.layer.options.params.filter=this._makeFilter(),this.layer.off("load"),this.layer.on("load",function(){t.layer.eachLayer(function(e){var n=L.userMarker(e.getLatLng(),{pulsing:!0,smallIcon:!0});if(t.layer.removeLayer(e),e.feature){var s=parseInt(e.feature.id.split(".")[1]),o=t.uid||localStorage.share_uid||null;o=parseInt(o),(!o||o&&o!==s)&&t.layer.addLayer(n);var a=utils.extractToHtml(t.layer.options.popup,e.feature.properties);n.bindLabel(a,{noHide:!0,direction:"right"}).showLabel()}}),smap.cmd.loading(!1)}),this.map.addLayer(this.layer);var t=this},_bindEvents:function(){var t=this;smap.event.on("smap.core.pluginsadded",function(){$("#smap-glocate-btn").on("click",function(){return $(this).hasClass("btn-primary")?($("#smap-share-btn").show(),t._addLayer(),t._startRefresh()):(t._stopShare(),t.deactivate()),!1}),$("#smap-share-btn").on("click",function(){var e=$(this).hasClass("btn-danger");e?($(this).removeClass("btn-danger"),t._stopShare()):t.dialog.modal("show")})}),this.dialog.find("input").on("click",function(){$(this).focus()}),this.dialog.find(".modal-footer .btn-primary").on("click",function(){$("#smap-share-btn").addClass("btn-danger"),t.dialog.modal("hide");var e=$.trim(t.dialog.find("input[type='text']").val());t._startShare(e)})},_onLocationFound:function(t){this._location=t},_onLocationError:function(t){smap.cmd.loading(!1)},_setLocateSettings:function(){var t={watch:!0,timeout:3e4,enableHighAccuracy:!0,frequency:3e3};$.extend(this.map._locateOptions,t)},_startShare:function(t){return this._storeInterval?!1:(utils.log("START sharing"),this.uName=t,this.__onLocationFound=this.__onLocationFound||$.proxy(this._onLocationFound,this),this.__onLocationError=this.__onLocationError||$.proxy(this._onLocationError,this),this.map.on("locationfound",this.__onLocationFound),this.map.on("locationerror",this.__onLocationFound),this.uid=localStorage.share_uid||null,this.__store=this.__store||$.proxy(this._store,this),this._storeInterval=setInterval(this.__store,this.options._storeIntervalMs),this._setLocateSettings(),void this.map.fire("drag"))},_startRefresh:function(){return this._refreshInterval?!1:(utils.log("start refreshing"),this.__refresh=this.__refresh||$.proxy(this._refresh,this),void(this._refreshInterval=setInterval(this.__refresh,this.options._refreshIntervalMs)))},_stopRefresh:function(){utils.log("stop refreshing"),clearInterval(this._refreshInterval),this._refreshInterval=null},_stopShare:function(){smap.cmd.loading(!1),utils.log("stop sharing"),this._stopRefresh(),clearInterval(this._storeInterval),this._storeInterval=null,this.map.off("locationfound",this.__onLocationFound,this),this.map.off("locationerror",this.__onLocationError,this),this._location=null,this.uid=null,this.uName=null},uid:null,_store:function(){return this._working||!this._location?!1:(this._working=!0,void $.ajax({url:this.options.useProxy?smap.config.ws.proxy+encodeURIComponent(this.options.wfsSource):this.options.wfsSource,type:"POST",context:this,data:this._getXml(this._location.latlng,this._location.accuracy,this.uName,this.uid),contentType:"text/xml",dataType:"text",error:function(t,e,n){utils.log("SharePosition: Error storing coordinates because of: "+e)},success:function(t){var e=$.xml2json(t),n=e?e.TransactionResponse||e["wfs:TransactionResponse"]:null;if(n){var s=n?n.TransactionSummary||n["wfs:TransactionSummary"]:null;if(s){var o=parseInt(s.totalInserted||s["wfs:totalInserted"]),a=parseInt(s.totalUpdated||s["wfs:totalUpdated"]);if(!this.uid&&o>0){var i=n.InsertResults||n["wfs:InsertResults"],r=i.Feature||i["wfs:Feature"],l=r.FeatureId||r["ogc:FeatureId"],h=l.fid||l.$.fid;this.uid=parseInt(h.split(".")[1]),localStorage.share_uid=this.uid}else 0===o&&0===a&&(this.uid=null,delete localStorage.share_uid)}}},complete:function(){this._working=!1}}))},_refresh:function(){this.layer.options.params.filter=this._makeFilter(),this.layer._refresh({force:!0})},_getXml:function(t,e,n,s){var o="",a=this.options.wfsFeatureType.split(":")[1];return o=s?'<wfs:Transaction\n  service="WFS"\n  version="1.1.0"\n  xmlns:grp="'+this.options.wfsUri+'"\n  xmlns:wfs="//www.opengis.net/wfs"\n  xmlns:ogc="//www.opengis.net/ogc"\n  xmlns:gml="//www.opengis.net/gml"\n  xmlns:xsi="//www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="//www.opengis.net/wfs\n                      //schemas.opengis.net/wfs/1.1.0/WFS-transaction.xsd">\n  <wfs:Update typeName="grp:'+a+'">\n	 <wfs:Property><wfs:Name>text_username</wfs:Name><wfs:Value>'+n+"</wfs:Value></wfs:Property>	 <wfs:Property><wfs:Name>int_accuracy</wfs:Name><wfs:Value>"+e+'</wfs:Value></wfs:Property>    <wfs:Property>\n      <wfs:Name>the_geom</wfs:Name>\n      <wfs:Value>\n        <gml:Point srsDimension="2" srsName="urn:x-ogc:def:crs:EPSG:4326">\n          <gml:coordinates decimal="." cs="," ts=" ">'+t.lat+","+t.lng+"</gml:coordinates>\n        </gml:Point>\n      </wfs:Value>\n    </wfs:Property>\n    <ogc:Filter>\n      <PropertyIsEqualTo>\n        <PropertyName>id</PropertyName>\n        <Literal>"+s+"</Literal>\n      </PropertyIsEqualTo>\n    </ogc:Filter>\n  </wfs:Update>\n</wfs:Transaction>":'<wfs:Transaction\n  service="WFS"\n  version="1.1.0"\n  xmlns:grp="'+this.options.wfsUri+'"\n  xmlns:wfs="//www.opengis.net/wfs"\n  xmlns:gml="//www.opengis.net/gml"\n  xmlns:xsi="//www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="//www.opengis.net/wfs\n                      //schemas.opengis.net/wfs/1.1.0/WFS-transaction.xsd\n                      '+this.options.wfsSource+"/DescribeFeatureType?typename="+this.options.wfsFeatureType+'">\n  <wfs:Insert>\n    <grp:'+a+'>\n      <grp:the_geom>\n        <gml:Point srsDimension="2" srsName="urn:x-ogc:def:crs:EPSG:4326">\n          <gml:coordinates decimal="." cs="," ts=" ">'+t.lat+","+t.lng+"</gml:coordinates>\n        </gml:Point>\n      </grp:the_geom>\n      <grp:int_accuracy>"+e+"</grp:int_accuracy>\n      <grp:text_username>"+n+"</grp:text_username>\n    </grp:"+a+">\n  </wfs:Insert>\n  </wfs:Transaction>"}}),L.control.sharePosition=function(t){return new L.Control.SharePosition(t)}}]);
!function(t){function n(o){if(e[o])return e[o].exports;var i=e[o]={exports:{},id:o,loaded:!1};return t[o].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var e={};return n.m=t,n.c=e,n.p="",n(0)}([function(t,n){"use strict";L.Control.ToolHandler=L.Control.extend({options:{position:"bottomright",showPopoverTitle:!1,breakpoint:991},_lang:{sv:{popoverTitle:"Verktyg"},en:{popoverTitle:"Tools"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},update:function(){var t=$(".thandler-container .leaflet-control button");t.length?($(".thandler-btn").removeClass("thandler-deactivated"),$(".thandler-container .leaflet-control button").each(function(){$(this).tooltip({placement:"bottom",container:"#maindiv"})})):$(".thandler-btn").addClass("thandler-deactivated")},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-toolhandler"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.$container.css("display","none"),utils.getBrowser().ie8||(this._makeToolHandler(),smap.event.on("smap.core.pluginsadded",this.update)),this._onWinResize=$.proxy(this.onWinResize,this),$(window).on("resize",this._onWinResize),this.checkCollapsePoint(),this._container},onWinResize:function(t){this.checkCollapsePoint()},checkCollapsePoint:function(){var t=$(window).width();t<=this.options.breakpoint?$("#mapdiv").addClass("thandler-collapsed"):$("#mapdiv").removeClass("thandler-collapsed")},activate:function(){},_makeToolHandler:function(){function t(t){var n=$(".thandler-popover").length&&parseInt($(".thandler-popover").css("opacity")||0)>0,e=$(".thandler-popover .popover-content");i.data("bs.popover")&&n&&e.children().length&&(utils.getBrowser().ie9&&a(),i.popover("hide")),$(".thandler-container .leaflet-control button").each(function(){$(this).trigger("blur")}),$(".tooltip:visible").hide()}function n(){var t=$(".thandler-container").children(":has('button')");t.length&&i.popover("show")}var e=this,o=$(".leaflet-top.leaflet-right");this.$thCont=o,o.addClass("thandler-container");var i=$('<div class="thandler-btn popover-dismiss"><button type="button" class="btn btn-default thbtn"><span class="fa fa-th"></span></button></div>');$("#mapdiv").append(i),this._map.on("mousedown dragstart",t),$(window).on("orientationchange",t);var a=function(){$(window).off("resize",t);var n=$(".thandler-popover .popover-content");n.find("button").each(function(){$(this).blur()}),smap.event.trigger("smap.toolhandler.hide"),setTimeout(function(){n.children().each(function(){$(".thandler-container").prepend(this)})},150)};i.on("click",function(){var o=$(this);if(o.data("bs.popover")){var i=$(".thandler-popover").length&&parseInt($(".thandler-popover").css("opacity")||0)>0;if(i)return utils.getBrowser().ie9&&a(),o.popover("hide"),!1}else o.popover({content:null,placement:"bottom",title:e.lang.popoverTitle,trigger:"manual"}),o.on("shown.bs.popover",function(){var n=$(this).next(),o=n.find(".popover-content");e.options.showPopoverTitle||n.find("h3").remove(),n.addClass("thandler-popover"),n.find(".arrow").addClass("thandler-arrow");var i=$(".thandler-container").children(".leaflet-control:has('button')").detach();o.empty(),i.each(function(){o.prepend(this)}),$(window).on("resize",t)}),o.on("hidden.bs.popover",a);return n(),!1}),i.on("tap",function(){return!1}),i.on("dblclick",function(){return!1})},onRemove:function(t){$(window).off("resize",this._onWinResize)}}),L.control.toolhandler=function(t){return new L.Control.ToolHandler(t)}}]);
!function(t){function n(a){if(o[a])return o[a].exports;var i=o[a]={exports:{},id:a,loaded:!1};return t[a].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var o={};return n.m=t,n.c=o,n.p="",n(0)}([function(t,n){"use strict";L.Control.Zoombar=L.Control.extend({options:{position:"bottomright"},_lang:{sv:{exampleLabel:"Ett exempel"},en:{exampleLabel:"An example"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-zoombar"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this.$container.addClass("btn-group-vertical"),this.$container.on("mousedown",function(){return!1}),this._createButtonZoomIn(),this._createButtonZoomUt(),this.__onZoomEnd=this.__onZoomEnd||$.proxy(this._onZoomEnd,this),this.map.on("zoomend",this.__onZoomEnd),this._container},_onZoomEnd:function(){this.map.getZoom()>=this.map.getMaxZoom()?this.$container.find("#zoombar-plus").addClass("disabled"):this.map.getZoom()<=this.map.getMinZoom()?this.$container.find("#zoombar-minus").addClass("disabled"):this.$container.find("button").removeClass("disabled")},_createButtonZoomIn:function(){var t=$('<button id="zoombar-plus" class="btn btn-default"><span class="fa fa-plus"></span></button>');this.$container.append(t),t.on("click touchstart dblclick",function(){return smap.map.zoomIn(),!1})},_createButtonZoomUt:function(){var t=$('<button id="zoombar-minus" class="btn btn-default"><span class="fa fa-minus"></span></button>');this.$container.append(t),t.on("click touchstart dblclick",function(){return smap.map.zoomOut(),!1})},onRemove:function(t){}}),L.control.zoombar=function(t){return new L.Control.Zoombar(t)}}]);