var ws = {
	"localhost": {
		proxy: "http://localhost/cgi-bin/proxy.py?url=",
		url: "http://localhost/cgi-bin/cultMap/getGeoData.py"
	},
	"kartor.malmo.se": {
		proxy: "http://localhost/cgi-bin/proxy.py?url=",
		url: "http://kartor.malmo.se/cgi-bin/cultmap/getGeoData.py"
	}
};

var guideLayerId = "gl";

var config = {

	params:{
		center: [13.38135, 55.89303],
		zoom: 9
	},

	ws: ws,

	ol: [
		{
			init: "L.GeoJSON.WFS",
			url: ws[document.domain].url,
			options: {
				params: {
					q: ";Konst;"
				},
				displayName: "Guide layer",
				layerId: guideLayerId,
				xhrType: "POST",
				attribution: "Malmö stad",
				inputCrs: "EPSG:4326",
				uniqueKey: "id",
				selectable: true,
				reverseAxis: false,
				reverseAxisBbox: false,
				popup:
					'<h4>${id}: ${Namn} </h4>'+
					'<div class="gp-mediaicons">${function(p) {'+
							'var out = "";'+
							'var style="margin-right:.3em;";'+
							'if (p.Video) {'+
								'	out += \'<span style="\'+style+\'" class="fa fa-film fa-lg"></span>\';'+
								'}'+
							'if (p.Ljud) {'+
							'	out += \'<span style="\'+style+\'" class="fa fa-volume-up fa-lg"></span>\';'+
							'}'+
						'if (p.Bild && p.Bild.split(",").length > 1) {'+
						'	out += \'<span style="\'+style+\'" class="fa fa-picture-o fa-lg"></span>\';'+
						'}'+
						'return out;'+
					'}'+
					'}</div>'+
					'${function(p) {'+
						'var out = "";'+
						'var pics = p.Bild || "",'+
							'pic;'+
						'pics = pics ? pics.split(",") : [];'+
						'if (pics.length > 1 && pics[0].length) {'+
							'pic = pics[0];'+
						'}'+
						'else if (pics.length === 1) {'+
							'pic = pics;'+
						'}'+
						'else {return "";}'+
						'pic = $.trim(pic);'+
						'return "<img style=\'width:100%;max-height:200px;margin-top: 1em;\' src=\'//kartor.malmo.se/rest/resources/cultmap/"+pic+"\'></img>";'+
					'}}'
			}
		}
		// ,
		// {
		// 	init: "L.GeoJSON.WFS",
		// 	url: ws[document.domain].url,
		// 	options: {
		// 		params: {
		// 			q: "Kulturen"
		// 		},
		// 		displayName: "Guide layer",
		// 		layerId: guideLayerId,
		// 		xhrType: "GET",
		// 		useProxy: false,
		// 		attribution: "Malmö stad",
		// 		inputCrs: "EPSG:4326",
		// 		uniqueKey: "id",
		// 		selectable: true,
		// 		reverseAxis: false,
		// 		reverseAxisBbox: true,
		// 		popup:
		// 			'<h4>${id}: ${Namn} </h4>'+
		// 			'<div class="gp-mediaicons">${function(p) {'+
		// 					'var out = "";'+
		// 					'var style="margin-right:.3em;";'+
		// 					'if (p.Video) {'+
		// 						'	out += \'<span style="\'+style+\'" class="fa fa-film fa-lg"></span>\';'+
		// 						'}'+
		// 					'if (p.Ljud) {'+
		// 					'	out += \'<span style="\'+style+\'" class="fa fa-volume-up fa-lg"></span>\';'+
		// 					'}'+
		// 				'if (p.Bild && p.Bild.split(",").length > 1) {'+
		// 				'	out += \'<span style="\'+style+\'" class="fa fa-picture-o fa-lg"></span>\';'+
		// 				'}'+
		// 				'return out;'+
		// 			'}'+
		// 			'}</div>'+
		// 			'${function(p) {'+
		// 				'var out = "";'+
		// 				'var pics = p.Bild || "",'+
		// 					'pic;'+
		// 				'pics = pics ? pics.split(",") : [];'+
		// 				'if (pics.length > 1 && pics[0].length) {'+
		// 					'pic = pics[0];'+
		// 				'}'+
		// 				'else if (pics.length === 1) {'+
		// 					'pic = pics;'+
		// 				'}'+
		// 				'else {return "";}'+
		// 				'pic = $.trim(pic);'+
		// 				'return "<img style=\'width:100%;max-height:200px;margin-top: 1em;\' src=\'//kartor.malmo.se/rest/resources/cultmap/"+pic+"\'></img>";'+
		// 			'}}'
					
		// 	}
		// }
		// {
		// 	init: "L.FeatureGroup",
		// 	options: {
		// 		displayName: "Guide layer",
		// 		layerId: guideLayerId,
		// 		attribution: "Guide Layer",
		// 		selectable: true,
		// 		// startVisible: true,
		// 		popup:
		// 			'<h4>${id}: ${Namn} </h4>'+
		// 			'<div class="gp-mediaicons">${function(p) {'+
		// 					'var out = "";'+
		// 					'var style="margin-right:.3em;";'+
		// 					'if (p.Video) {'+
		// 						'	out += \'<span style="\'+style+\'" class="fa fa-film fa-lg"></span>\';'+
		// 						'}'+
		// 					'if (p.Ljud) {'+
		// 					'	out += \'<span style="\'+style+\'" class="fa fa-volume-up fa-lg"></span>\';'+
		// 					'}'+
		// 				'if (p.Bild && p.Bild.split(",").length > 1) {'+
		// 				'	out += \'<span style="\'+style+\'" class="fa fa-picture-o fa-lg"></span>\';'+
		// 				'}'+
		// 			'return out;'+
		// 			'}'+
		// 			'}</div>'+
		// 			'${function(p) {'+
		// 					'var out = "";'+
		// 					'var pics = p.Bild || "",'+
		// 						'pic;'+
		// 					'pics = pics ? pics.split(",") : [];'+
		// 					'if (pics.length > 1 && pics[0].length) {'+
		// 						'pic = pics[0];'+
		// 					'}'+
		// 					'else if (pics.length === 1) {'+
		// 						'pic = pics;'+
		// 					'}'+
		// 					'else {return "";}'+
		// 					'pic = $.trim(pic);'+
		// 					'return "<img style=\'width:100%;max-height:200px;margin-top: 1em;\' src=\'//kartor.malmo.se/rest/resources/cultmap/"+pic+"\'></img>";'+
		// 			'}}'
		// 	}
		// }
	],

	bl: [
		{
			init: "L.TileLayer",
			url: 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
			options: {
				layerId: "osm",
				displayName: "OSM",
				attribution: '<span>© OpenStreetMap contributors</span>&nbsp;|&nbsp;<span>Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"></span>',
				maxZoom: 18
			}
		}
	],

	plugins: [
		{
			init: "L.Control.Scale",
			options: {
				imperial: false
			}
		},
		{
			init: "L.Control.LayerSwitcher",
			options: {
				toggleSubLayersOnClick: false,
				unfoldOnClick: true,
				unfoldAll: false
			}
		},
		{
			init: "L.Control.SelectWMS",
			options: {
				buffer: 5
			}
		},
		{
			init: "L.Control.SelectVector",
			options: {}
		},
		{
			init: "L.Control.Search",
			options: {
				_lang: {
					"sv": {search: "Sök adress eller synliga objekt"}
				},
				acHeight: "21em",
				gui: true,
				wsAcLocal: ["Hembygdsgard", "Kulturen", "Museum"],
				wsLocateUrl: "http://kartor.malmo.se/cgi-bin/cultmap/getGeoData.py",
				wsOrgProj: "EPSG:4326",
				vectorSearch: {
					layerIds: [],
					suffix: "[Plats]",
					keyVals: {
						Namn: "Titel", // This first key will always be used as an identifier for a feature, when highlighting it. Should be unique.
						Kategori: "Kategori",
						Beskrivning: "Beskrivning"
					}
				}
			}
		},
		{
			init: "L.Control.Zoombar",
			options: {}
		},
		{
			init: "L.Control.Geolocate",
			options: {}
		},
		{
			init: "L.Control.ShareLink",
			options: {
				position: 'topright'
			}
		},
		{
			init: "L.Control.Print",
			options: {
				position: 'topright'
			}
		},
		{
			init: "L.Control.Info",
			options: {
				position: 'topright'
			}
		},
		{
			init: "L.Control.ToolHandler",
			options: {}
		},
		{
			init: "L.Control.GuidePopup",
			options: {
				autoActivate: false,
				layerId: guideLayerId,
				dialogTitle: "${Namn}",
				useProxy: true,
				attrId: "id",
				
				// This object specifies how to fill the big popup (the modal window).
				// The modalContent parameters can be overridden by individual parameters for each feature.
				modalContent: {
					iconType: null,
					dialogTitle: "${Namn}",
					fullScreenIntroPic: "${Bild}", // Used only when clicking on a media tag, opening in fullscreen
					tabIntro: '${function(p) {'+
							'var out = "";'+
							'var pics = p.Bild || "",'+
								'pic;'+
							'pics = pics ? pics.split(",") : [];'+
							'if (pics.length > 1 && pics[0].length) {'+
								'pic = pics[0];'+
							'}'+
							'else if (pics.length === 1) {'+
								'pic = pics;'+
							'}'+
							'else {return "";}'+
							'pic = $.trim(pic);'+
							'return "<img style=\'max-width:70%;max-height:300px;margin-bottom: 1em;\' src=\'//kartor.malmo.se/rest/resources/cultmap/"+pic+"\'></img>";'+
						'}}'+
						"<div>${Beskrivning}</div>",
					tabMedia: [{
						condition: function(p) {
							return p.Bild && p.Bild.split(",").length > 1;
						},
						label: 'Fler bilder av "${Namn}"',
						mediaType: "image",
						sources: '${function(p){var pics = p.Bild.split(","); '+
								'var baseUrl = "//kartor.malmo.se/rest/resources/cultmap/";'+
								'var out = [];'+
								'for (var i=0,len=pics.length; i<len; i++) {'+
									'out.push(baseUrl + $.trim(pics[i]));'+
								'}'+
								'return out.join(",");'+
							'}}'
					},
					{
						condition: function(p) {
							return p.Video && p.Video.length > 0;
						},
						label: 'Kort video om "${Namn}"',
						mediaType: "video",
						sources: '${Video}'
					}
					],
					tabAccess: '<div>'+
						'<p>'+
							'<table>'+
								'<tr><td><b>Handikapptoalett:&nbsp;</b></td><td>${function(p) { if (!p.Handikapptoalett) return "–"; else return p.Handikapptoalett;}}</td></tr>'+
								'<tr><td><b>Handikapparkering:&nbsp;</b></td><td>${function(p) { if (!p.Handikapparkering) return "–"; else return p.Handikapparkering;}}</td></tr>'+
								'<tr><td><b>Toalett:&nbsp;</b></td><td>${function(p) { if (!p.Toalett) return "–"; else return p.Toalett;}}</td></tr>'+
								'<tr><td><b>Busshållplats:&nbsp;</b></td><td>${function(p) { if (!p["Avstånd till busshållplats"]) return "–"; else return p["Avstånd till busshållplats"];}}</td></tr>'+
								'<tr><td><b>Busslinje:&nbsp;</b></td><td>${function(p) { if (!p.Busslinje) return "–"; else return p.Busslinje;}}</td></tr>'+
								'<tr><td><b>Parkering:&nbsp;</b></td><td>${function(p) { if (!p.Parkering) return "–"; else return p.Parkering;}}</td></tr>'+
							'</table>'+
						'</p>'+
					'</div>'
				},

				modalContentOverrides: {
					
				}
			}
		}
	]
};


function _getOls(cats) {
	cats = cats || [];

	var o = {
			layerId: null,
			// parentLayerId: guideLayerId,
			displayName: null,
			// proxy: ws[document.domain].proxy,
			category: null,
			attribution: "© Regis",
			inputCrs: "EPSG:4326",
			reverseAxis: false,
			selectable: true,
			reverseAxis: false,
			reverseAxisBbox: false,
			popup:
				'<h4>${id}: ${Namn} </h4>'+
				'<div class="gp-mediaicons">${function(p) {'+
						'var out = "";'+
						'var style="margin-right:.3em;";'+
						'if (p.Video) {'+
							'	out += \'<span style="\'+style+\'" class="fa fa-film fa-lg"></span>\';'+
							'}'+
						'if (p.Ljud) {'+
						'	out += \'<span style="\'+style+\'" class="fa fa-volume-up fa-lg"></span>\';'+
						'}'+
					'if (p.Bild && p.Bild.split(",").length > 1) {'+
					'	out += \'<span style="\'+style+\'" class="fa fa-picture-o fa-lg"></span>\';'+
					'}'+
					'return out;'+
				'}'+
				'}</div>'+
				'${function(p) {'+
					'var out = "";'+
					'var pics = p.Bild || "",'+
						'pic;'+
					'pics = pics ? pics.split(",") : [];'+
					'if (pics.length > 1 && pics[0].length) {'+
						'pic = pics[0];'+
					'}'+
					'else if (pics.length === 1) {'+
						'pic = pics;'+
					'}'+
					'else {return "";}'+
					'pic = $.trim(pic);'+
					'return "<img style=\'width:100%;max-height:200px;margin-top: 1em;\' src=\'//kartor.malmo.se/rest/resources/cultmap/"+pic+"\'></img>";'+
				'}}',
			uniqueKey: "id",
			params: {
				q: null
			}
			// style: {
			// 	radius: 8,
			// 	fillColor: "#F00",
			// 	color: "#00F",
			// 	weight: 2,
			// 	opacity: 1,
			// 	fillOpacity: 0.8
			// },
			// selectStyle: {
			// 	radius: 8,
			// 	fillColor: "#0FF",
			// 	color: "#0FF",
			// 	weight: 1,
			// 	opacity: 1,
			// 	fillOpacity: 0.5
			// }
	};

	var t = {},
		out = [],
		cat,
		layerIds = [],
		opts;
	for (var i=0,len=cats.length; i<len; i++) {
		cat = cats[i];
		opts = $.extend(true, {}, o);
		if (!cat.length) {
			continue;
		}
		opts.category = cat.slice(0, cat.length-1);
		if (!opts.category.length) {
			opts.category = ["Utan kategori"];
		}
		opts.displayName = cat[cat.length-1];
		opts.layerId = "id"+i;
		layerIds.push(opts.layerId);
		opts.params.q = ";"+cat.join(";")+";";

		t = {
			init: "L.GeoJSON.WFS",
			url: ws[document.domain].url,
			options: opts
		};
		out.push(t);
	}

	// Set layerIds property for search function autocomplete so
	// that all "layers" (categories) become searchable.
	for (var i = 0; i < config.plugins.length; i++) {
		t = config.plugins[i];
		if (t.init === "L.Control.Search") {
			t.options.vectorSearch.layerIds = layerIds;
			break;
		}
	};
	return out;

}

config.onLoad = function(conf) {
	return $.ajax({
		url: "http://localhost/cgi-bin/cultMap/getConfig.py",
		type: "POST",
		// context: this,
		dataType: "json",
		success: function(resp) {
			if (resp.success && resp.data) {
				var ol = _getOls(resp.data);
				conf.ol = conf.ol.concat(ol);
			}
		},
		error: function(a, text, c) {
			alert("Kunde inte läsa kategorierna för config-filen p g a: "+text);
		}

	});
};

