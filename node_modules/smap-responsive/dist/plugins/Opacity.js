!function(t){function e(n){if(i[n])return i[n].exports;var a=i[n]={exports:{},id:n,loaded:!1};return t[n].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e){"use strict";L.Control.Opacity=L.Control.extend({options:{position:"topright",showTitle:!1,btnReset:!0},_lang:{sv:{caption:"Ändra genomskinlighet på lager",close:"Stäng",btnTitle:"Justera genomskinlighet",popoverTitle:"Genomskinlighet",transparency:"Genomskinlighet",transparent:"Genomskinlig",opaque:"Synlig",visibility:"Synlighet",layerName:"Kartskikt",resetAll:"Återställ alla",hideAll:"Göm alla"},en:{caption:"Transparency tool",close:"Close",btnTitle:"Adjust transparency",popoverTitle:"Transparency",transparency:"Transparency",transparent:"Transparent",opaque:"Visible",visibility:"Opacity",layerName:"Layer",resetAll:"Reset all",hideAll:"Hide all"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),t._lang&&$.extend(!0,this._lang,t._lang),this._setLang(t.langCode)},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-opacity"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this.$popContainer.append('<div class="smap-opacity-headerrow"><label>'+this.lang.layerName+"</label><label>"+this.lang.visibility+"</label></div>"),this.$sliderRowContainer=$('<div class="smap-opacity-sliderrow-container" />'),this.$popContainer.append(this.$sliderRowContainer),this._bindEvents(),this._container},hide:function(){this.$btn.popover("hide"),this.$btn.parent().find(".opacity-popover").hide()},_bindEvents:function(){var t=this,e=function(e){if(e.layer.options&&e.layer.options.layerId&&!e.layer.feature){var i=e.layer;if(!(i&&i.options&&i.options.hasOwnProperty("showInOpacityTool")&&i.options.showInOpacityTool===!1))switch(e.type){case"layeradd":t._addRow(i);break;case"layerremove":t._removeRow(i)}}}.bind(this),i=this.hide.bind(this);this._map.on("layeradd layerremove",e),this._map.on("mousedown dragstart",i),$(window).on("resize orientationchange",i),smap.event.on("smap.toolhandler.hide",function(){this.$btn.parent().find(".opacity-popover").hide(),i()}.bind(this)),smap.event.on("smap.core.aftercreateparams",this.onAfterCreateParams.bind(this)),smap.event.on("smap.core.applyparams",this.onApplyParams.bind(this))},_addBtnReset:function(){var t=$('<div class="smap-opacity-btnresetrow" />'),e=$('<button class="btn btn-default btn-xs smap-opacity-btnreset">'+this.lang.resetAll+"</button>"),i=$('<button class="btn btn-default btn-xs smap-opacity-btnhideall">'+this.lang.hideAll+"</button>");t.append(e),t.append(i),e.on("click touchstart",this.reset.bind(this)),i.on("click touchstart",this.hideAll.bind(this)),this.$popContainer.parent().parent().append(t)},onAfterCreateParams:function(t,e){var i=this._getDefaults(!0),n=this._unCreateId,a={};if(this.$sliderRowContainer.find("input").each(function(t){var e=Number($(this).val()),o=n($(this).prop("id"));e!==100*i[o]&&(a[o]=e)}),$.isEmptyObject(a)===!1){var o=[];e.ol.forEach(function(t){o.push(void 0!==a[t]?a[t]:"")});var s=(this._getDefaults(),this.$sliderRowContainer.find("input").length);e.ol.length<s&&void 0!==a[e.bl]&&a[e.bl]!==100*i[e.bl]&&o.push(a[e.bl]),e.opacity=o.join(",").replace(/,+$/,""),console.log(e.opacity)}},onApplyParams:function(t,e){if(e.OPACITY){var i=e.OPACITY instanceof Array?e.OPACITY:e.OPACITY.split(","),n=e.OL,a=(this._setLayerOpacity,this);i.forEach(function(t,i){if(0!==t.length){t=Number(t);var o=n.length>i?n[i]:o=e.BL;a._setSliderOpacity(a._createId(o),t)}})}},_createId:function(t){return"opacity-"+t},_unCreateId:function(t){return t.replace("opacity-","")},_setLabelValue:function(t,e){t.text(e+" %")},_setLayerOpacity:function(t,e){t.setOpacity&&t.setOpacity(e)},_setSliderOpacity:function(t,e){this.$sliderRowContainer.find("#"+t).val(e).trigger("change").trigger("slideStop").slider("setValue",e)},reset:function(){var t=this._getDefaults(),e=this;this.$sliderRowContainer.find("input").each(function(i,n){var a=100*t[i];e._setSliderOpacity($(this).prop("id"),a)})},hideAll:function(){var t=this;this.$sliderRowContainer.find("input").each(function(e,i){t._setSliderOpacity($(this).prop("id"),0)})},_getDefaults:function(t){t=t||!1;var e=[];t&&(e={});var i=this._unCreateId;return this.$sliderRowContainer.find("input").each(function(){var n=i($(this).prop("id")),a=smap.cmd.getLayerConfig(n),o=a&&a.options?a.options.opacity||1:1;t?e[n]=o:e.push(o)}),e},onSlideStop:function(t){var e=$(t.target),i=(Number(e.val()),this._unCreateId(e.prop("id"))),n=smap.cmd.getLayer(i);L.NonTiledLayer&&n instanceof L.NonTiledLayer.WMS&&n.redraw()},_resetNonTiledLayer:function(t){t._currentImage&&t._resetImage(t._currentImage),t._bufferImage&&t._resetImage(t._bufferImage)},onSlide:function(t){var e=$(t.target),i=Number(e.val()),n=this._unCreateId(e.prop("id")),a=smap.cmd.getLayer(n),o=i/100;L.NonTiledLayer&&a instanceof L.NonTiledLayer.WMS?(this._setLayerOpacity(a,o),this._resetNonTiledLayer(a)):this._setLayerOpacity(a,o);var s=e.parent().find(".smap-opacity-value");this._setLabelValue(s,i)},_adjustSize:function(){var t=$(".opacity-popover");if(t.length){var e=t.find(".smap-opacity-popcontainer"),i=$("#mapdiv").innerHeight(),n=e.offset()||{},a=t.offset()||{},o=e.outerHeight(),s=i-n.top-(o+100);0>s?(e.addClass("smap-opacity-scrollable"),e.css("max-height",i-a.top-70+"px")):e.css("max-height","none").removeClass("smap-opacity-scrollable"),!this._popoverRepositioned&&$(".thandler-popover:visible").length&&(this._popoverRepositioned=!0,this.$btn.popover("show"),setTimeout(function(){this._popoverRepositioned=!1}.bind(this),0))}},_addRow:function(t){var e=this.$sliderRowContainer,i=this._createId(t.options.layerId);if(e.find("#"+i).length)return!1;var n=t.hasOwnProperty("_layers");if(t&&!n){var a;if(t.setOpacity){a=a||("number"==typeof t.options.opacity?t.options.opacity:1);var o=100*a,s=$('<div class="smap-opacity-row"><div class="smap-opacity-valuerow"><span class="smap-opacity-label">'+(t.options.displayName||t.options.layerId||"no name")+'</span><span class="smap-opacity-value">'+o+'</span></div><input type="text" id="'+i+'" data-provide="slider" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="'+o+'" data-slider-tooltip="hide"></div>');e.prepend(s);var r=s.find("#"+i);this.lang.transparency;r.slider({tooltip_position:"bottom"}),r.on("change",this.onSlide.bind(this)),r.on("slideStop",this.onSlideStop.bind(this)),this._setLabelValue(s.find(".smap-opacity-value"),o),this._adjustSize()}}},_removeRow:function(t){var e=this._getDefaults(!0),i=t.hasOwnProperty("_layers");if(e[t.options.layerId]&&!i){this._setLayerOpacity(t,e[t.options.layerId]);var n=this.$sliderRowContainer,a=this._createId(t.options.layerId);n.find("#"+a).parent().remove(),this._adjustSize()}},_createBtn:function(){function t(t){t.stopPropagation()}function e(e){e.on("click",t).on("dblclick",t).on("mousewheel DOMMouseScroll MozMousePixelScroll",t).on("mousedown",t)}var i=this,n=$('<button id="smap-opacity-btn" title="'+this.lang.btnTitle+'" class="btn btn-default"><span class="fa fa-sliders"></span></button>');this.$btn=n,n.on("click touchstart",function(){return i.activate(),!1}),this.$container.append(n),this.$popContainer=$('<div class="smap-opacity-popcontainer" />'),n.popover({content:function(){var t=$(this).data("bs.popover").$tip.find(".popover-content");0===t.find(".smap-opacity-popcontainer").length&&t.append(i.$popContainer),i.options.btnReset&&0===t.parent().find(".smap-opacity-btnresetrow").length&&i._addBtnReset()},placement:"bottom",trigger:"manual"}),n.on("click touchstart",function(){$(this).popover("toggle")}),n.on("shown.bs.popover",function(t){if(!i._popoverInititated){var n=$(this).next();e(n),n.addClass("opacity-popover"),i.options.showTitle||n.find("h3").remove(),i._popoverInititated=!0}$(".smap-opacity-popcontainer").show(),i._adjustSize()}),n.on("hidden.bs.popover",function(t){$(".smap-opacity-popcontainer").hide()}.bind(this))},activate:function(){if(this._active)return!1;this._active=!0;this.$btn;return!0},deactivate:function(){var t=this.$btn;this.$popContainer.detach(),t.popover("destroy")},onRemove:function(t){this.$btn.remove(),delete this.$btn,delete this.$popContainer}}),L.control.opacity=function(t){return new L.Control.Opacity(t)}}]);