!function(e){function t(r){if(o[r])return o[r].exports;var i=o[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var o={};return t.m=e,t.c=o,t.p="",t(0)}([function(e,t){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};L.Control.Editor=L.Control.extend({options:{position:"bottomright",useProxy:!1,reverseAxis:!1,encodeKeys:null,saveOnPressEnter:!1},_lang:{sv:{dTitle:"Objektets attribut",close:"Avbryt",save:"Spara",remove:"Ta bort",move:"Flytta",editProps:"Ändra",moveLP:"Ändra geometri",editPropsLP:"Ändra attribut",ruSureRemove:"Ta bort objektet? Åtgärden kan inte ångras.",saveNewMarker:"Spara",saveMove:"Spara",undo:"Ångra",cancel:"Avbryt"},en:{dTitle:"Object attributes",close:"Cancel",save:"Save",remove:"Remove",move:"Move",editProps:"Edit",moveLP:"Edit geometry",editPropsLP:"Edit attributes",doYouWantTo:"Do you want to",cannotBeUndoed:"Cannot be undoed",ruSureRemove:"Remove feature? Cannot be undoed.",saveNewMarker:"Save",saveMove:"Save",undo:"Undo",cancel:"Cancel"}},_geomTypes:{POINT:"marker",MULTIPOINT:"marker",LINESTRING:"polyline",MULTILINESTRING:"polyline",POLYGON:"polygon",MULTIPOLYGON:"polygon"},_geomType:"marker",_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this._setLang(e.langCode),this._inserts=[],this._updates=[],this._deletes=[]},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-editor"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawModal();var t=this;return smap.event.on("smap.core.pluginsadded",function(){t._setEditableLayer()}),this._container},onRemove:function(e){},_addBtnAdd:function(){var e=this,t=$(".smap-editor-btnadd");if(!t.length){var t=$('<button class="btn btn-default btn-lg smap-editor-btnadd"><i class="glyphicon glyphicon-plus"></i></button>');$(".leaflet-top.leaflet-left").prepend(t),t.on("click touchend",function(){var t=e._getDrawToolbar();return $(this).toggleClass("btn-danger"),$(this).hasClass("btn-danger")?(t.handler.type&&"marker"===t.handler.type&&(e._onTouchHold=e._onTouchHold||function(o){var r=t.handler;e._tooltip=e._tooltip||{updatePosition:function(){}},r._onMouseMove({latlng:o.latlng}),r._onClick({latlng:o.latlng})},e.map.on("click",e._onTouchHold,e)),t.handler.enable()):(utils.isTouchOnly()&&t.handler.type&&"marker"===t.handler.type&&(e.map.off("click",e._onTouchHold,e),$("#smap-editor-uglyhackconfirm").remove()),t.handler.disable()),!1})}},_setEditableLayer:function(){function e(e){if($(this).parent().hasClass("list-group-item-danger"))n.stopEditing();else{var t=$(this).data("t")||{};t=$.extend(!0,{},t),"L.GeoJSON.WFS"===t.init?n.startEditing(t,$(this).parent()):alert("Kan inte redigera lager av typen "+t.init)}return!1}var t,o,r,i=smap.config.ol||[],a=smap.cmd.getControl("LayerSwitcher");if(!a)return!1;for(var n=this,s=0,l=i.length;l>s;s++)t=i[s],r=$('<i class="fa fa-edit smap-editor-switcher-icon"></i>'),t.options.isEditable&&(o=$("#"+a._makeId(t.options.layerId)),o.append(r),r.data("t",t),r.on("click",e))},_disabledRowClick:function(e){return e.stopPropagation(),e.preventDefault(),$(e.target).hasClass("smap-editor-switcher-icon")?$(".smap-editor-switcher-icon").trigger("click"):($(e.target).tooltip("show"),setTimeout(function(){$(e.target).tooltip("hide")},2e3)),!1},stopEditing:function(){if(this._editLayer){this._editLayer.options.editable=!1;var e=this._editLayer.options.layerId,t=e.substring(0,e.length-"-edit".length),o=smap.cmd.getLayer(t);o&&o.clearLayers&&o.clearLayers(),o&&o._refresh&&o._refresh({force:!0}),this.map.removeLayer(this._editLayer)}return $(".lswitch-panel-ol .list-group-item").off("click",this._disabledRowClick).removeClass("list-group-item-danger"),$(".lswitch-panel-ol .list-group-item").tooltip("destroy"),this.map.off("draw:created"),this.map.off("popupopen",this.__onPopupOpen),$(".smap-editor-btnadd").remove(),!0},_validateConfig:function(e){e=e||{};var t=e.options||{},o=[];for(var r in this._geomTypes)o.push(r);return t.geomType?-1===$.inArray(t.geomType.toUpperCase(),o)?(alert("You must specify one of these geomTypes: "+o.join(", ")),!1):!0:(alert("You must specify one of these geomTypes: "+o.join(", ")),!1)},startEditing:function(e,t){function o(e){var t=e.layer.jsonData.features||[];if(t.length)r.options.geomType=r._geomType=r._geomTypes[e.layer.options.geomType.toUpperCase()],r._geomType||alert("Could not detect geometry type. Please set it explicitly.");else{var o=e.layer.options.geomType;o?r._geomType=r._geomTypes[o.toUpperCase()]:alert("You must define a geomType in the options of this layer! Set of these: (POINT, LINESTRING, POLYGON, MULTIPOINT, MULTILINESTRING, MULTIPOLYGON).")}}var r=this,i=this.map;if(this.stopEditing()!==!0)return!1;if(this._addBtnAdd(),r._tooltip=r._tooltip||{updatePosition:function(){}},$(".lswitch-panel-ol .list-group-item.active").trigger("tap"),$(".lswitch-panel-ol .list-group-item-danger").removeClass("list-group-item-danger"),$(".lswitch-panel-ol .list-group-item").tooltip({title:"Redigering är aktiv. Deaktivera redigering för att tända lagret.",trigger:"manual",placement:"right",container:"#maindiv"}).on("click",this._disabledRowClick),t.addClass("list-group-item-danger"),this._validateConfig(e)===!1)return!1;var a=$.extend({},e.options),n=a.params.typeName;a.url=e.url,a.featureNS=n.split(":")[0],a.featureType=n.split(":")[1],a.layerId=a.layerId+"-edit";var s=a.geomType.toUpperCase(),l="POINT"===s?this.lang.move:this.lang.moveLP,d="POINT"===s?this.lang.editProps:this.lang.editPropsLP,p=this.lang.remove;a.popup='${*}<div class="popup-divider"></div><div style="white-space:nowrap;min-width:25em;" class="btn-group btn-group-sm editor-popup-edit"><button id="editor-popup-edit" type="button" class="btn btn-default">'+d+'</button><button id="editor-popup-move" type="button" class="btn btn-default">'+l+'</button><button id="editor-popup-remove" type="button" class="btn btn-default">'+p+"</button></div>",this._editLayer=L.wfst(e.url,a),this._editLayer.options.editing=this._editLayer.options.editing||{},this._editLayer.on("wfst:savesuccess",function(){smap.cmd.loading(!1)}),this._editLayer.on("wfst:saveerror",function(){smap.cmd.loading(!1)}),this._editLayer.on("wfst:ajaxerror",function(){smap.cmd.loading(!1)}),i.addLayer(this._editLayer),this._drawControl=new L.Control.Draw({edit:{featureGroup:this._editLayer}}),i.addControl(this._drawControl),$(".leaflet-draw").remove(),this._editLayer.on("load",o),i.on("draw:created",function(e){$(".smap-editor-btnadd").removeClass("btn-danger"),r._editLayer.addLayer(e.layer),r._marker=e.layer,r._showSaveToolbar("insert")}),this.__onPopupOpen=this.__onPopupOpen||$.proxy(this._onPopupOpen,this),this.map.on("popupopen",this.__onPopupOpen)},_getLayerById:function(e,t){function o(a){var n=a._layers||{};if(!n)return null;if(n.hasOwnProperty(t))return{marker:n[t],markerGeometry:n[t]};var s,l;for(l in n)if(0===i&&(r=l),i+=1,s=o(n[l]),i-=1,s)return{marker:e._layers[r],markerGeometry:s.marker};return null}var r,i=0;return o(e)},_onPopupOpen:function(e){var t=this;if(this._marker&&this._marker.dragging&&this._marker.dragging._draggable&&this._marker.dragging._draggable._enabled){if(this.map.closePopup(),confirm("Do you to stop editing this feature? Any changes made to the feature will be removed.")!==!0)return;this.cancelEdit()}var o=$(e.popup._container);if(e.popup._source.feature&&"polyline"!=this._geomType)this._marker=e.popup._source,this._markerGeometry=null;else{var r=this._getLayerById(this._editLayer,e.popup._source._leaflet_id);this._marker=r.marker,this._markerGeometry=e.popup._source}o.find("#editor-popup-remove").on("click",function(){return confirm(t.lang.ruSureRemove)===!0&&t._editLayer.wfstRemove(t._marker).done(function(){t._editLayer.clearLayers(),t._editLayer._refresh({force:!0})}),!1}),o.find("#editor-popup-move").on("click",function(){t.map.closePopup();var e=t._getEditToolbar();return e.handler._enableLayerEdit(t._markerGeometry||t._marker),t._showSaveToolbar("update"),t._editLayer.options.editable=!0,!1}),o.find("#editor-popup-edit").on("click",function(){return t._modalEdit.modal("show"),!1})},_getEditToolbar:function(){var e;for(var t in this._drawControl._toolbars)if(e=this._drawControl._toolbars[t],e&&e._modes&&e._modes.edit)return e._modes.edit;return null},_getDrawToolbar:function(){var e;for(var t in this._drawControl._toolbars)if(e=this._drawControl._toolbars[t],e&&e._modes&&e._modes[this._geomType])return e._modes[this._geomType];return null},wfstSave:function(e){e=e?L.Util.isArray(e)?e:[e]:[];var t,r,i=[],a=this._editLayer;for(r=0,len=e.length;r<len;r++)if("object"==o(e[r]._layers))for(t in e[r]._layers)smap.cmd.loading(!0),i.push(a._wfstSave(e[r]._layers[t]));else i.push(a._wfstSave(e[r]));return $.when.apply($,i)},save:function(e){e=e||null;var t,o,r=this._inserts,i=this._updates,a=this._editLayer,n=r.length;for(t=0;n>t;t++)o=r[t],a._wfstAdd(o).done(function(){r.splice(o,1),e&&e()});for(n=i.length,t=0;n>t;t++)o=i[t],this.wfstSave(o).done(function(){i.splice(o,1)})},cancelEdit:function(){var e=this._getEditToolbar();e.handler._disableLayerEdit(this._markerGeometry||this._marker),this._editLayer.clearLayers(),this._editLayer._refresh({force:!0}),this._hideSaveToolbar()},_showSaveToolbar:function(e){if(this._editType=e,!this._saveToolbar){var t=this;this._saveToolbar=$('<div class="smap-editor-savetoolbar btn-group btn-group-lg" />');var o=$('<button class="btn btn-success">Save</button>'),r=$('<button class="btn btn-default">Cancel</button>');this._saveToolbar.append(r).append(o),$(".leaflet-top.leaflet-left").append(this._saveToolbar),o.on("click",function(){if(t._marker.options.geomType=t._editLayer.options.geomType.toUpperCase(),"update"===t._editType){var e=t._marker.options.geomType;"POINT"===e||"POLYGON"===e?t.wfstSave(t._marker):(t._markerGeometry.feature=$.extend({},t._marker.feature),t.wfstSave(t._markerGeometry))}var o=t._getEditToolbar();return o.handler._disableLayerEdit(t._markerGeometry||t._marker),"insert"===t._editType?(t._inserts.push(t._marker),t.save(function(){t._editLayer.clearLayers(),t._editLayer._refresh({force:!0}),t._hideSaveToolbar()})):"update"===t._editType&&(t.save(),t._hideSaveToolbar()),!1}),r.on("click",function(){return t.cancelEdit(),!1})}var i="insert"==this._editType?this.lang.saveNewMarker:this.lang.saveMove,a=this.lang.cancel;this._saveToolbar.find("button:eq(0)").text(a),this._saveToolbar.find("button:eq(1)").text(i),this._saveToolbar.show()},_hideSaveToolbar:function(){this._saveToolbar.hide()},_fillModal:function(e){if(e=e||null,null===e)return!1;var t,o,r,i,a=this._modalEdit.find("#smap-editor-content"),n=$('<form role="form" />'),s=this.options.encodeKeys||[];for(t in e)"fid"!==t&&"id"!==t&&"gid"!==t&&(o=e[t],o=o||"",("*"===s||$.inArray(t,s)>-1)&&(o=decodeURIComponent(o)),i="smap-editor-propentry-"+t,r='<div class="form-group">						<label for="'+i+'">'+t+'</label>						<textarea rows="1" resizable name="'+t+'" class="form-control" id="'+i+'">'+o+"</textarea>					</div>",n.append(r));n.find("textarea").on("change",function(){$(this).addClass("changed")}).on("focus",function(){$(this).prop("rows",5)}).on("blur",function(){$(this).prop("rows",1)}),a.append(n)},_onSaveAttributesSuccess:function(e){this._marker.fire("click")},_saveAttributes:function(){var e=this._marker.feature.properties,t={},o=this._modalEdit.find("form").find("textarea.changed");if(!o.length)return this._modalEdit.modal("hide"),!1;var r,i,a=this.options.encodeKeys||[];o.each(function(){r=$(this).attr("name"),i=$(this).val(),("*"===a||$.inArray(r,a)>-1)&&(i=encodeURIComponent(i)),t[r]=i});var n=$.extend({},e,t);this._marker.feature.properties=n,this._marker.toGML||(this._markerGeometry.feature=$.extend({},this._marker.feature)),this.__onSaveAttributesSuccess=this.__onSaveAttributesSuccess||$.proxy(this._onSaveAttributesSuccess,this),this._editLayer.off("wfst:savesuccess",this.__onSaveAttributesSuccess).on("wfst:savesuccess",this.__onSaveAttributesSuccess),this._editLayer._wfstSave(this._markerGeometry||this._marker,{newProps:t}),this._modalEdit.modal("hide"),this.map.closePopup()},_drawModal:function(){var e=this,t=$('<div id="smap-editor-content" />'),o='<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.close+'</button><button id="smap-editor-editmodal-btnsave" type="button" class="btn btn-primary">'+this.lang.save+"</button>";this._modalEdit=utils.drawDialog(this.lang.dTitle,t,o,{}),this._modalEdit.find("#smap-editor-editmodal-btnsave").on("click",function(){return e._saveAttributes(),!1}),this._modalEdit.on("shown.bs.modal",function(){var t=e._marker.feature.properties;e._fillModal(t),e.options.saveOnPressEnter&&e._modalEdit.on("keypress",function(t){13===t.which&&($("#smap-editor-editmodal-btnsave").focus(),e._saveAttributes(),e._modalEdit.modal("hide"),t.preventDefault())})}),e._modalEdit.on("hidden.bs.modal",function(){t.empty(),e._modalEdit.off("keypress")})}})}]);