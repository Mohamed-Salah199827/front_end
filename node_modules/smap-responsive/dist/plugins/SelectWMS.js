!function(e){function t(i){if(s[i])return s[i].exports;var n=s[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t){"use strict";L.Control.SelectWMS=L.Control.extend({options:{wmsVersion:"1.3.0",info_format:"text/plain",maxFeatures:20,buffer:12,useProxy:!1},_layers:[],_selectedFeatures:[],initialize:function(e){L.setOptions(this,e)},onAdd:function(e){return this.map=e,this.activate(),this._container=L.DomUtil.create("div","leaflet-control-selectwms"),$(this._container).css("display","none"),L.DomEvent.disableClickPropagation(this._container),this._container},onRemove:function(e){this.deactivate()},onSuccess:function(e){e=e||[];for(var t,s,i,n,r,a,o,l,c=0,p=e.length;p>c;c++)if(t=e[c],a=t[0],o=t[1],l=o.params,s=a.features,a)if(a.features){var i,n,r,s=a.features;if(!s.length)continue;for(var h=0,u=s.length;u>h;h++){if(i=s[h],n=smap.cmd.getLayerConfigBy("options.layers",l.layers)||smap.cmd.getLayerConfigBy("options.selectOptions.layers",l.layers),!n&&i.id){var f=i.id.split(".")[0];if(l.layers.search(f)>-1)for(var y=l.layers.split(","),m=0,d=y.length;d>m;m++)if(y[m].search(f)>-1){var g=y[m];n=smap.cmd.getLayerConfigBy("options.layers",g)||smap.cmd.getLayerConfigBy("options.selectOptions.layers",g)}}if(!n)break;r=n.options,r.selectOptions&&r.selectOptions.srs&&"EPSG:4326"!==r.selectOptions.srs&&utils.projectFeature(i,r.selectOptions.srs,"EPSG:4326",{});var _=i.geometry.type;if("Point"===_||"MultiPoint"===_){var v=[];switch(_){case"Point":v=i.geometry.coordinates;break;case"MultiPoint":v=i.geometry.coordinates[0]}i.latLng=L.latLng([v[1],v[0]])}else i.latLng=o.latLng;i.options=$.extend({},r),s[h]=i}this._selectedFeatures=this._selectedFeatures.concat(s)}else{var x,S,b=o.latLng;for(var O in a){x=a[O];var C=O.split(":"),P=C[C.length-1],n=smap.cmd.getLayerConfigBy("layerId",P,{inText:!0})||smap.cmd.getLayerConfigBy("layers",P,{inText:!0})||smap.cmd.getLayerConfigBy("options.selectOptions.layers",P,{inText:!0});if(n&&n.options&&n.options.layerId)for(var E=n.options.layerId,h=0,u=x.length;u>h;h++){S=x[h];var i={geometry:{coordinates:[b.lng,b.lat]},latLng:L.latLng([b.lat,b.lng]),properties:S,layerId:E,options:n.options};S&&$.isEmptyObject(S)===!1&&this._selectedFeatures.push(i)}}}this._selectedFeatures.length&&this.map.fire("selected",{layer:this,feature:this._selectedFeatures.length?this._selectedFeatures[0]:null,selectedFeatures:this._selectedFeatures})},_applyParam:function(e){var t,s,i,n,r,a=JSON.parse(decodeURIComponent(e)),o=[];for(s in a)i=a[s],i.xy&&(t=smap.core.layerInst.showLayer(s),o.push(t));n=i.xy&&i.xy.length?i.xy[0]:null,n&&(r=L.latLng(n[1],n[0]),this.onMapClick({latlng:r,_layers:o}))},onApplyParams:function(e,t){t.SEL&&this._applyParam(decodeURIComponent(t.SEL))},activate:function(){return this._active?!1:(this._active=!0,void this._bindEvents())},deactivate:function(){this._active=!1,this._unbindEvents()},_bindEvents:function(){this._onApplyParams=this._onApplyParams||$.proxy(this.onApplyParams,this),smap.event.on("smap.core.applyparams",this._onApplyParams),this.map.on("layeradd",this.onLayerAdd,this).on("layerremove",this.onLayerRemove,this).on("click",this.onMapClick,this).on("dblclick",this.onMapDblClick,this)},_unbindEvents:function(){smap.event.off("smap.core.applyparams",this._onApplyParams),this.map.off("layeradd",this.onLayerAdd,this).off("layerremove",this.onLayerRemove,this).off("click",this.onMapClick,this).off("dblclick",this.onMapDblClick,this)},onLayerAdd:function(e){var t=e.layer;this._layerShouldBeAdded(t)===!0&&this._layers.push(t)},onLayerRemove:function(e){var t=e.layer,s=this._hasLayer(t);s!==!1&&this._layers.splice(s,1)},onMapDblClick:function(e){this._dblclickWasRegistered=!0,this.xhr&&this.xhr.abort(),setTimeout($.proxy(function(){this._dblclickWasRegistered=!1},this),400)},onMapClick:function(e){this._selectedFeatures=[];var t=e.latlng;this.xhr&&this.xhr.abort();var s=e._layers||this._layers;if(s.length){var i,n,r,a,o,l=this,c={},p=0;$.each(s,function(e,t){if(o=t.options||{},n=t._url||t._wmsUrl,r=n.toUpperCase(),c[r]){var s=c[r].selectOptions||{},i=o.selectOptions||{},h=s.info_format||l.options.info_format;a=h&&i.info_format&&h!==i.info_format,a&&(r+="_1")}c[r]||(c[r]={layerNames:[],url:n,wmsVersion:t._wmsVersion,layerId:o.layerId,selectOptions:o.selectOptions||{}},p+=1),o.selectOptions&&o.selectOptions.layers?c[r].layerNames.push(o.selectOptions.layers):c[r].layerNames.push(o.layers)});var h,u;setTimeout($.proxy(function(){if(this._dblclickWasRegistered===!0)console.log("NOT requesting");else{var e=[];for(var s in c){i=c[s],h=i.selectOptions.parser,u=this._makeParams({layers:i.layerNames.join(","),version:i._wmsVersion||this.options.wmsVersion,info_format:i.selectOptions.info_format||this.options.info_format,latLng:t,srs:i.selectOptions.srs||"EPSG:4326"},i.selectOptions),"text/plain"===u.info_format&&(u.version="1.1.1");var n=this.onSuccess;this.request(i.selectOptions.url||i.url,u,{onSuccess:function(t,s){p-=1,e.push([t,s]),0>=p&&n.call(this,e)},onError:function(){p-=1},layerId:i.layerId,latLng:t},h)}}},this),100)}},_layerShouldBeAdded:function(e){var t=e.wmsParams?!0:!1;return e.options&&e.options.selectable&&e.options.selectable===!0&&this._hasLayer(e)===!1&&t===!0?!0:!1},_hasLayer:function(e){for(var t=this._layers,s=0,i=t.length;i>s;s++)if(e===t[s])return s;return!1},_makeParams:function(e,t){t=t||{};var s=this.map.latLngToContainerPoint(e.latLng),i=this.map.getBounds(),n=i.toBBoxString();if(t.srs&&"EPSG:4326"!==e.srs){var r=i.getSouthWest(),a=i.getNorthEast();r=utils.projectLatLng(r,"EPSG:4326",e.srs,!1,!1),a=utils.projectLatLng(a,"EPSG:4326",e.srs,!1,!1),i=L.latLngBounds(r,a),n=i.toBBoxString()}if(t.reverseAxisBbox){var o=n.split(",");n=[o[1],o[0],o[3],o[2]].join(",")}var l=$.extend({},{service:"WMS",request:"GetFeatureInfo",version:this.options.version,bbox:n,layers:null,styles:"",typename:e.layers,query_layers:e.layers,info_format:e.info_format,feature_count:this.options.maxFeatures,x:utils.round(s.x),y:utils.round(s.y),buffer:this.options.buffer,width:utils.round(this.map.getSize().x),height:utils.round(this.map.getSize().y),srs:"EPSG:4326",exceptions:"application%2Fvnd.ogc.se_xml"},e);return delete l.latLng,l},_parseTextArcGis:function(e,t){out={},dict={},features=[],numcols=0,featurtype="",rows=e.split("\n"),cols=rows[0].split(";"),cols.length%2==1?numcols=(cols.length-1)/2:numcols=cols.length/2;for(var s=0;s<numcols;s++)dict[cols[s]]=cols[s+numcols];return features[0]=dict,featurtype=t,out[featurtype]=features,out},_parseText:function(e){for(var t,s,i,n,r,a,o={},l={},c=e.split("\n"),p=0,h=c.length;h>p;p++)if(t=c[p],0!==$.trim(t).length)if(-1!==t.search("=")){if(s=t.split("="),s.length>2){var u=s.slice(1);n=u.join("=")}else n=s[1];n=$.trim(n),"null"==n.toLowerCase()&&(n="");var f=/^[0-9.]+$/.test(n),y=n.split("."),m=y.length<=2&&y[0].length>0&&(1===y.length||2===y.length&&y[1].length>0);if(f===!0&&m){try{switch(y.length){case 1:r=parseInt(n);break;case 2:r=parseFloat(n)}}catch(d){}r&&isNaN(r)===!1&&(n=r)}i=$.trim(s[0]),l[i]=n}else{var g=t.search(/'/);if(g>-1){t=t.substring(g+1),g=t.search(/'/),a&&o[a]&&$.isEmptyObject(l)===!1&&(o[a].push($.extend({},l)),l={}),a=t.substring(0,g),o[a]||(o[a]=[]);continue}a&&o[a]&&$.isEmptyObject(l)===!1&&t.search(/\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-/gi)>-1?(o[a].push($.extend({},l)),l={}):i&&n&&(l[i]=n+" "+t)}return a&&o[a]&&$.isEmptyObject(l)===!1&&o[a].push($.extend({},l)),o},request:function(e,t,s,i){t=t||{},s=s||{};var n=null;this.options.useProxy?e=smap.config.ws.proxy+encodeURIComponent(e+"?"+$.param(t)):n=t,this.xhr=$.ajax({url:e,data:n,type:"GET",dataType:"text",context:this,success:function(e,n,r){var a,o=t.info_format;if("undefined"!=typeof i)"PLAINTEXT"==i?a=this._parseText(e):"JSON"==i?a=JSON.parse(e):"ARCGIS"==i&&(a=this._parseTextArcGis(e,s.layerId));else if("text/plain"===o)a=this._parseText(e);else{if("application/json"!==o)return!1;a=JSON.parse(e)}s.onSuccess.call(this,a,{latLng:s.latLng,map:this.map,context:this,params:t})},error:s.onError})},CLASS_NAME:"L.Control.SelectWMS"}),L.control.selectWMS=function(e){return new L.Control.SelectWMS(e)}}]);