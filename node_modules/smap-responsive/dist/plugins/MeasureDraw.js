!function(e){function t(r){if(a[r])return a[r].exports;var o=a[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var a={};return t.m=e,t.c=a,t.p="",t(0)}([function(e,t){"use strict";var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};L.Control.MeasureDraw=L.Control.extend({options:{position:"topright",saveMode:"url",saveWfsUrl:"",saveWfsTypeName:"",layerName:"measurelayer",moreCoordsAsModal:!0,touchShowButtonAsDisabled:!0,stylePolygon:{color:"#0077e2",weight:3},stylePolyline:{color:"#0077e2",weight:9}},_lang:{sv:{btnDisabledBecauseTouch:"Rita & Mät stödjer inte pekskärmar",close:"Stäng",drawTools:"Ritverktyg",draggableMarker:"Markören är dragbar",btnTitle:"Rita & Mät",drawPoint:"Punkt/Koordinater",drawLine:"Linje",drawPolygon:"Yta",drawCircle:"Cirkel",drawRectangle:"Rektangel",circumference:"Omkrets",radius:"Radie",area:"Area",len:"Längd",lenPart:"Sidlängd",easting:"Easting (x/longitud)",northing:"Northing (y/latitud)",clickToAddText:"Klicka för att lägga till text (stäng pratbubblan för att spara)",showMeasures:"Visa mätresultat",remove:"Ta bort",moreCoords:"Fler koordinatsystem",helpTextSavePopup:"Stäng pratbubblan för att spara",handlers:{circle:{tooltip:{start:"Klicka och dra för att rita cirkel."}},marker:{tooltip:{start:"Klicka i kartan för att placera markör."}},polygon:{tooltip:{start:"Klicka för att påbörja yta",cont:"Klicka igen för att fortsätta rita ytan.",end:"Dubbelklicka eller klicka första punkten för att avsluta ytan."}},polyline:{error:"<strong>Error:</strong> linjers kanter kan inte korsa varandra!",tooltip:{start:"Klicka för att påbörja linje.",cont:"Klicka för att fortsätta linje.",end:"Dubbelklicka för att avsluta linje."}},rectangle:{tooltip:{start:"Klicka och dra för att rita rektangel."}},simpleshape:{tooltip:{end:"Släpp musknappen för att avsluta."}}}},en:{btnDisabledBecauseTouch:"Draw & Measure does not work on touch screens",close:"Close",drawTools:"Draw tools",draggableMarker:"The marker is draggable",btnTitle:"Draw & Measure",drawPoint:"Point/Coordinates",drawLine:"Line",drawPolygon:"Area",drawCircle:"Circle",drawRectangle:"Rectangle",circumference:"Circumference",radius:"Radius",area:"Area",len:"Length",easting:"Easting (x/longitude)",northing:"Northing (y/latitude)",clickToAddText:"Click to add text",showMeasures:"Show measure results",remove:"Remove",moreCoords:"More projections",helpTextSavePopup:"Close the popup to save"}},_setLang:function(e){e=e||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.Draw.Polyline.addInitHook(function(){this._vertexChanged=function(e,t){this._updateFinishHandler(),this._updateRunningMeasure(e,t),this._clearGuides(),this._updateTooltip(),this._map.fire("draw:vertexchanged",{latlng:e,context:this})}}),L.setOptions(this,e),this._setLang(e.langCode),this._tools={},this._setLabels()},_jsonCompressDict:{'"FeatureCollection":':":fc:",'"Feature"':":F:",'"Point"':":P:",'"features":':":fs:",'"type":':":t:",'"geometry":':":g:",'"coordinates":':":c:",'"properties":':":p",'"measure_form"':":m:",'"measure_text"':":mt:"},_compressJson:function(e){var t,a=this._jsonCompressDict;for(var r in a)t=new RegExp(r,"g"),e=e.replace(t,a[r]);return e},_uncompressJson:function(e){var t,a=this._jsonCompressDict;for(var r in a)t=new RegExp(a[r],"g"),e=e.replace(t,r);return e},onAdd:function(e){this.map=e,this._container=L.DomUtil.create("div","leaflet-control-measuredraw"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._proxyListeners(),this._initDraw(),this._isTouchOnly=utils.isTouchOnly();var t=this._isTouchOnly&&this.options.touchShowButtonAsDisabled;if(!this._isTouchOnly||t){var a=this._createBtn();t?(a.prop("disabled",!0),a.prop("title",this.lang.btnDisabledBecauseTouch),a.tooltip({placement:"bottom"})):smap.event.on("smap.core.pluginsadded",function(){$(".leaflet-control-measuredraw .dropdown-toggle").dropdown()})}var r=this;return this.map.on("layeradd",function(e){r._layer.bringToFront(),r._layer.setZIndex(1e4),r._layer.eachLayer(function(e){e.options.selectable=!0,e.options.clickable=!1,e.bringToFront&&e.bringToFront(),e.setZIndex&&e.setZIndex(1e4)})}),smap.event.on("smap.core.createparams",$.proxy(this._onCreateParams,this)),smap.event.on("smap.core.applyparams",$.proxy(this._onApplyParams,this)),this._container},_onCreateParams:function(e,t){for(var r=this,o=t.ol,n=0,s=o.length,i=this.options.layerName;s>n;n++)if(o[n]===i){o.splice(n,1);break}if("url"===this.options.saveMode){var l,p,c,d,u,h,g,n,s,m,f,b=function(){var e=function a(e){for(var t,r=0,o=e.length;o>r;r++)t=e[r],t instanceof Array?a(t):e[r]=L.Util.formatNum(t,5)};if(l=[],p=0,r._layer.eachLayer(function(e){e._radius&&(e.properties.radius=e.getRadius()),e._popup&&e._popup._isOpen&&(delete t.sel,e.properties.popupIsOpen=!0),l.push(e.properties),e.properties&&(p+=1)}),0===p)return{v:!1};for(c=r._layer.toGeoJSON(),d=c.features,g=[],n=0,s=d.length;s>n;n++)h=d[n],u=$.extend(!0,{},h),e(u.geometry.coordinates),l[n]&&(u.properties=$.extend({},l[n]),delete u.properties.measure_form,g.push(u));c.features=g,m=JSON.stringify(c),m=r._compressJson(m),f=encodeURIComponent(r.options.saveMode+","+m),f=f.replace(/%3A/g,":"),f=f.replace(/%3A/g,":"),t.md=f}();if("object"===("undefined"==typeof b?"undefined":a(b)))return b.v}},_onApplyParams:function(e,t){if(t.MD){var a=decodeURIComponent(t.MD),r=a.search(","),o=a.substring(0,r),n=a.substring(r+1);if("url"===o){n=this._uncompressJson(n);var s,i=JSON.parse(n),l=L.geoJson(i),p=this;l.eachLayer(function(e){var t={Point:"marker",LineString:"polyline",Polygon:"polygon"};if("Point"===e.feature.geometry.type){var a=e.feature.geometry.coordinates;s=L.marker([a[1],a[0]]),s.properties=$.extend(!0,{},e.feature.properties)}else s=e;p.onCreated({_silent:!0,layerType:t[e.feature.geometry.type],layer:s})})}}},_proxyListeners:function(){this.__onRowClick=$.proxy(this._onRowClick,this)},onRemove:function(e){},readableDistance:function(e,t){t=t||1;var a="m",r=0;if(1===t&&e>=1e3||2===t&&e>=1e5){var o=Math.pow(1e3,t-1);e/=o,e/=1e3,r=3,a="km"}return a=1===t?a:a+t,utils.round(e,r)+" "+a},_renderLabel:function(e,t){this._labels=this._labels||[];var a=utils.createLabel(e,this.readableDistance(t,1),"leaflet-maplabel leaflet-maplabel-small");this._layer.addLayer(a),this._labels.push(a);var r=$(".leaflet-maplabel.leaflet-maplabel-small:last");r.css({"margin-left":-r.width()/2+"px"})},onNodeClick:function(e){this._nodes=this._nodes||[];var t=e.latlng||null,a=this._nodes;if(t&&a.push(t),a.length>1){var r=a.slice(a.length-2),o=utils.getLength(r);if(0>=o)return!1;var n=L.latLng((r[0].lat+r[1].lat)/2,(r[0].lng+r[1].lng)/2);this._renderLabel(n,o)}console.log("node click")},_createCoordsHtml:function(e,t){t=t||!1;var a=utils.projectLatLng(e,"EPSG:4326","EPSG:3006"),r=utils.projectLatLng(e,"EPSG:4326","EPSG:3008"),o=utils.projectLatLng(e,"EPSG:4326","EPSG:3021"),n="",s="",i="";t||(n=" hidden",s='<div style="margin-bottom:1em;">['+this.lang.draggableMarker+"]</div>",i='<br><button ondrag="return false;" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i>&nbsp;&nbsp;'+this.lang.moreCoords+"</button></div></div>");var l=s+"<div><strong>WGS 84 (EPSG:4326)</strong><br>Lat: &nbsp;"+utils.round(e.lng,5)+"<br>Lon: &nbsp;"+utils.round(e.lat,5)+"<div>"+i;return l+="<br><div class='measuredraw-morecoords"+n+"'><strong>Sweref99 TM (EPSG:3006)</strong><br>East: &nbsp;"+utils.round(a.lng)+"<br>North: &nbsp;"+utils.round(a.lat)+"<br><br><strong>Sweref99 13 30 (EPSG:3008)</strong><br>East: &nbsp;"+utils.round(r.lng)+"<br>North: &nbsp;"+utils.round(r.lat)+"<br><br><strong>RT90 2.5 gon V (EPSG:3021)</strong><br>East: &nbsp;"+utils.round(o.lng)+"<br>North: &nbsp;"+utils.round(o.lat)+"</div>"},_getLabel:function(e){var t;return this._layer.eachLayer(function(a){a._parentFeature&&a._parentFeature===e&&(t=a)}),t},onCreated:function(e){var t=this;this._deactivateAll();var a=e.layerType,r=e.layer;if(r.properties&&r.properties.radius){var o=r.properties;a="circle",r=L.circle(r._latlng,r.properties.radius),r.properties=o}if(r.setStyle)switch(a){case"polyline":r.setStyle(this.options.stylePolyline);break;default:r.setStyle(this.options.stylePolygon)}"marker"===a&&(r.options.draggable=!0,r.on("dragstart",function(e){var t=e.target;t.closePopup()}),r.on("drag",function(e){var a=e.target,r=t._getLabel(a);r.setLatLng(a.getLatLng());var o=t._createCoordsHtml(a.getLatLng());$(r._icon).html(o);var n=$(".alert");if(n.length){var s=smap.cmd.notify(t._createCoordsHtml(a.getLatLng(),!0),"blank");s.addClass("notify-transition notify-visible")}})),this._layer.addLayer(r),r.options.layerId=r._leaflet_id,r.feature&&(r.properties=r.feature.properties||r.properties,delete r.feature),r.properties&&(r.properties.measure_form||r.properties.measure_text)||(r.properties={id:r._leaflet_id,measure_form:'<div class="measuredraw-popup-div-save"><textarea class="form-control" placeholder="'+this.lang.clickToAddText+'" rows="3"></textarea></div>',measure_text:""}),r.properties.id=r._leaflet_id,r._measureDrawFeature=!0,this._layer.fire("load"),r.unbindPopup();var n,s,i,l="";switch(a){case"marker":var p=n=r.getLatLng();l=this._createCoordsHtml(p);break;case"polyline":var c=r.getLatLngs();n=c[parseInt(c.length/2)],s=utils.getLength(c),l=this.lang.len+": &nbsp;"+this.readableDistance(s,1)+"<br>";break;case"polygon":n=r.getBounds().getCenter();var c=r.getLatLngs();c.push(c[0]);var i=L.GeometryUtil.geodesicArea(c);s=utils.getLength(c),l=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(i,2);break;case"circle":n=r.getBounds().getCenter();var d=r.getRadius();i=d*d*Math.PI,s=2*d*Math.PI,l=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.radius+": &nbsp;"+this.readableDistance(d,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(i,2);break;case"rectangle":n=r.getBounds().getCenter();var c=r.getLatLngs();c.push(c[0]);var i=L.GeometryUtil.geodesicArea(c);s=utils.getLength(c),l=this.lang.circumference+": &nbsp;"+this.readableDistance(s,1)+"<br>"+this.lang.area+": &nbsp;"+this.readableDistance(i,2)}var u=r._leaflet_id,h="measuredrawlabel_"+u+"_",g="leaflet-maplabel "+h;if(this._isTouchOnly);else{(e._silent||"rectangle"===a)&&r.getLatLngs&&(this._nodes=[],$.each(r.getLatLngs(),function(e,a){t.onNodeClick({latlng:a})}));var m=utils.createLabel(n,l,g);if(this._layer.addLayer(m),r.on("mouseover",this.onMouseOver),r.on("mouseout",this.onMouseOut),m.options.clickable=!0,"marker"===a){var f=function(e){if(t.options.moreCoordsAsModal){var a=t._createCoordsHtml(r.getLatLng(),!0);smap.cmd.notify(a,"blank",{fade:!0})}else{var o=$(this),n=o.parent().parent().parent();n.find(".measuredraw-morecoords").toggleClass("hidden"),o.parent().remove()}return!1},b=function(e){var t=$(this);t.find("button").off("click",f).on("click",f)};$(m._icon).on("mouseenter",b),$(m._icon).on("click",function(){return!1})}this._labels=this._labels||[],this._labels.push(m);for(var _=this._labels||[],v=0,y=_.length;y>v;v++)_[v]._parentFeature=r;this._labels=[];var w=$(".leaflet-maplabel:last");"marker"===a&&w.css("transition","none"),w.css({"margin-left":-w.width()/2-15+"px"})}e._silent?r.properties&&r.properties.popupIsOpen&&(delete r.properties.popupIsOpen,this.map.fire("selected",{feature:r,selectedFeatures:[],layer:this._layer})):w&&(w.addClass("leaflet-maplabel-hover"),setTimeout(function(){w.removeClass("leaflet-maplabel-hover")},2e3))},onMouseOver:function(e){var t=$(".measuredrawlabel_"+e.target._leaflet_id+"_");t.addClass("leaflet-maplabel-hover")},onMouseOut:function(e){$(".measuredrawlabel_"+e.target._leaflet_id+"_").removeClass("leaflet-maplabel-hover")},_setLabels:function(){var e=L.drawLocal.draw;$.extend(!0,e.handlers,this.lang.handlers||{})},_selection:function(e){var t,a,r=[smap.cmd.getControl("L.Control.SelectWMS"),smap.cmd.getControl("L.Control.SelectVector")];for(a=0;a<r.length;a++)t=r[a],t&&(e===!0?t.activate():t.deactivate())},_initDraw:function(){this._layer=L.featureGroup(),this._layer.options={layerId:this.options.layerName,popup:"${measure_text}${measure_form}",uniqueKey:"id"},this.map.addLayer(this._layer),this._drawControl=new L.Control.Draw({draw:{marker:!1,polyline:!1,polygon:!1,rectangle:!1,circle:!1},edit:null}),this._onCreated=this._onCreated||$.proxy(this.onCreated,this),this._onNodeClick=this._onNodeClick||$.proxy(this.onNodeClick,this),this._onPopupOpen=this._onPopupOpen||$.proxy(this.onPopupOpen,this),this.map.on("draw:created",this._onCreated);var e=this;e.map.on("click",function(){this._removeAlerts()},this);var t=function(e){this.onNodeClick(e)}.bind(this);this.map.on("draw:drawstart",function(){e._nodes=[],e._selection(!1),e._map.on("draw:vertexchanged",t)}),this.map.on("draw:drawstop",function(a){e._map.off("draw:vertexchanged",t),e._nodes&&_.indexOf(["polygon","rectangle"],a.layerType)>-1&&e._onNodeClick({latlng:e._nodes[0]}),e._selection(!0)}),this.map.on("popupopen",this._onPopupOpen)},_removeFeature:function(e){var t=this;this.map.fire("unselected",{}),this.map._popup&&this.map.closePopup();this._labels;e.off(),this._layer.eachLayer(function(a){a._parentFeature&&a._parentFeature===e&&(a.off(),t.map.removeLayer(a))}),this._layer.removeLayer(e)},onPopupOpen:function(e){var t=this;this._removeAlerts();var a=e.popup&&e.popup._source?e.popup._source:null;if(a&&a._measureDrawFeature){var r=smap.cmd.getControl("L.Control.SelectWMS");r._dblclickWasRegistered=!0,r&&setTimeout(function(){r._dblclickWasRegistered=!1},400);var o=$(".measuredraw-popup-div-save textarea"),n='<br><br><button class="btn btn-default btn-sm measuredraw-btn-popupremove">'+this.lang.remove+"</button>",s=e.popup,i=s.getContent();if(-1===i.search("measuredraw-btn-popupremove")&&(i+=n,s.setContent(i),s.update(),o=$(".measuredraw-popup-div-save textarea")),$(".leaflet-popup-content").find(".measuredraw-btn-popupremove").on("click",function(){return t._removeFeature(a),!1}),o.length){o.placeholder(),o.tooltip({placement:"top",title:this.lang.helpTextSavePopup,container:".leaflet-popup",trigger:"manual"}),o.on("keypress",function(){$(".tooltip:visible").length||$(this).tooltip("show")});var l=utils.getBrowser();o.on("focus",function(){$(".measuredraw-btn-popupremove").prop("disabled",!0),(l.ie10||l.ie11)&&$(this).val("")});this.lang.clickToAddText;o.on("blur",function(){$(".measuredraw-btn-popupremove").prop("disabled",!1),$(this).tooltip("hide");var t=e.popup._source,a=$(this).val();""===a||(t.properties.measure_text=a,t.properties.measure_form="",t.closePopup())})}}},_getDrawToolbar:function(e){var t;for(var a in this._drawControl._toolbars)if(t=this._drawControl._toolbars[a],t&&t._modes&&t._modes[e])return t._modes[e];return null},_deactivateAll:function(){var e=this._tools;for(var t in e)e[t].disable(),this.$container.find(".dropdown-menu li.active").removeClass("active");this._removeAlerts()},_removeAlerts:function(){var e=$(".alert");e.length&&(e.removeClass("notify-visible"),setTimeout(function(){e.remove()},500))},_onRowClick:function(e){var t="li"===e.target.tagName?$(e.target):$(e.target).parents("li"),a=t.data("geomType");return t.hasClass("active")?(t.removeClass("active"),this._tools[a].disable()):(this._deactivateAll(),t.toggleClass("active"),this._tools[a].enable(),setTimeout(function(){$(".leaflet-control-measuredraw .dropdown-menu").dropdown("toggle")},200)),!1},_createRow:function(e){var t=$('<li><a><div><span class="drawicons '+e.cl+'"></span><span>'+e.label+"</span></div></a></li>");t.data("geomType",e.geomType),t.on("click",this.__onRowClick);var a=L.Draw[utils.capitalize(e.geomType)],r=new a(this.map,this._drawControl.options.draw[e.geomType]);r.options.shapeOptions=r.options.shapeOptions||{};var o={};switch(e.geomType){case"polyline":o=this.options.stylePolyline;break;default:o=this.options.stylePolygon}return $.extend(r.options.shapeOptions,o),this._tools[e.geomType]=r,t},_createBtn:function(){var e=[{label:this.lang.drawPoint,cl:"leaflet-draw-draw-marker",geomType:"marker"},{label:this.lang.drawLine,cl:"leaflet-draw-draw-polyline",geomType:"polyline"},{label:this.lang.drawPolygon,cl:"leaflet-draw-draw-polygon",geomType:"polygon"},{label:this.lang.drawCircle,cl:"leaflet-draw-draw-circle",geomType:"circle"},{label:this.lang.drawRectangle,cl:"leaflet-draw-draw-rectangle",geomType:"rectangle"}],t=$('<div class="btn-group"><button type="button" title="'+this.lang.btnTitle+'" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="fa fa-map-marker"></span></button><ul class="dropdown-menu" role="menu"></ul></div>');utils.getBrowser().ie&&t.find(".measuredraw-btntoggle-image").css({"background-position":"-120px 0"});for(var a,r,o=t.find(".dropdown-menu"),n=0,s=e.length;s>n;n++)r=e[n],a=this._createRow(r),o.append(a);return this.$container.append(t),t}}),L.control.measureDraw=function(e){return new L.Control.MeasureDraw(e)}}]);