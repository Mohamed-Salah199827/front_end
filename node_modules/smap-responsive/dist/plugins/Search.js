!function(e){function t(o){if(s[o])return s[o].exports;var a=s[o]={exports:{},id:o,loaded:!1};return e[o].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t){"use strict";L.Control.Search=L.Control.extend({options:{whitespace:"%20",wsOrgProj:"EPSG:3006",pxDesktop:992,clearEntryAfterSearch:!1,funcSetPosition:function(){var e=smap.cmd.getControl("L.Control.LayerSwitcher");e||$("#smap-search-div").css("left","10px")},gui:!1,addToMenu:!1,popupContent:null,zoom:15,iconOptions:$.extend({},(new L.Icon.Default).options,{iconUrl:L.Icon.Default.imagePath+"/marker-icon.png"}),source:null,acHeight:null,autoScrollAcOnRowNbr:2,acOptions:{items:100}},_lang:{sv:{search:"Sök adress",addressNotFound:"Den sökta adressen hittades inte",remove:"Ta bort"},en:{search:"Search address",addressNotFound:"The searched address was not found",remove:"Remove"}},_setLang:function(e){e=e||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[e]:null)},initialize:function(e){L.setOptions(this,e),this.options._lang&&$.extend(!0,this._lang,this.options._lang),this._setLang(e.langCode);var t=this.options.funcSetPosition;t&&smap.event.on("smap.core.pluginsadded",function(){t()})},onAdd:function(e){var t=this,s=this;if(this.map=e,this._container=L.DomUtil.create("div","leaflet-control-search"),L.DomEvent.disableClickPropagation(this._container),this._searchLayer=L.layerGroup(),this.map.addLayer(this._searchLayer),(void 0===this.options.gui||this.options.gui===!0)&&(this.$container=$(this._container),this.$container.css("display","none"),this._makeSearchField(),this.map.on("click",this._blurSearch)),this.options.vectorSearch&&(this._cachedFeatures=this._cachedFeatures||{},this.map.on("layeradd",this._onLayerAdd,this),this.map.on("layerremove",this._onLayerRemove,this)),this.options.wfsSearch){this._cachedFeatures=this._cachedFeatures||{};var o=this.options.wfsSearch;this._setACOptions(o);var a,n;this._wfsLayerGroup=L.layerGroup();for(var r=0,i=o.layerIds.length;i>r;r++)if(a=smap.cmd.getLayerConfig(o.layerIds[r])){var p;!function(){var o=function r(){this._cacheLayer(p,!1,this.options.wfsSearch),p.off("load",r)};n=$.extend(!0,{},a),n.options.layerId+=1,p=smap.core.layerInst._createLayer(n),t._initVectorSearch(p),t._wfsLayerGroup.addLayer(p),s.map.whenReady(function(){p._map=e,p.on("load",o,s),p._refresh({force:!0,bounds:!1}),p._map=null},1e3)}()}}return this.__onApplyParams=this.__onApplyParams||$.proxy(this._onApplyParams,this),smap.event.on("smap.core.applyparams",this.__onApplyParams),this.__onCreateParams=this.__onCreateParams||$.proxy(this._onCreateParams,this),smap.event.on("smap.core.createparams",this.__onCreateParams),$(".leaflet-top.leaflet-left").addClass("with-search-bar"),s._container},_blurSearch:function(){$(".smap-search-div input").blur()},onRemove:function(e){smap.event.off("smap.core.applyparams",this.__onApplyParams),smap.event.off("smap.core.createparams",this.__onCreateParams),this.map.off("click",this._blurSearch),$(".leaflet-top.leaflet-left").removeClass("with-search-bar")},_onLayerAdd:function(e){var t=e.layer||{};t.options&&!t.options._silent&&t.options.layerId&&!t.feature&&this.options.vectorSearch&&$.inArray(t.options.layerId,this.options.vectorSearch.layerIds)>-1&&(this._setACOptions(this.options.vectorSearch),this._initVectorSearch(t))},_onLayerRemove:function(e){var t=e.layer||{};t.options&&!t.options._silent&&t.options.layerId&&!t.feature&&this.options.vectorSearch&&$.inArray(t.options.layerId,this.options.vectorSearch.layerIds)>-1&&this._cacheLayer(t,!0)},_cacheProperties:function(e,t,s){var o,a,n=[];a=$.extend(!0,{},{name:e[t[0]]}),n=[];for(var r=0,i=t.length;i>r;r++)o=e[t[r]],o&&o.length&&n.push(s[r]+"=="+o);return a.searchWords=n.join("&&"),a},_cacheLayer:function(e,t,s){t=t||!1,s=s||{},this._acVector=this._acVector||[];var o,a,n=[],r=this._cacheProperties,i=s.keyVals,p=this._acVector,c=[],h=[];for(var l in i)c.push(l),h.push(i[l]);e.eachLayer(function(e){o=e.feature.properties,a=r(o,c,h),p.splice(a),t||n.push(a)}),this._acVector=this._acVector.concat(n),$("#smap-search-div input").prop("disabled",!1)},_initVectorSearch:function(e){var t=this,s=e.options;return s?($("#smap-search-div input").prop("disabled",!0),void($.isEmptyObject(e._layers)?!function(){var s=function o(t){this._cacheLayer(e,!1,this.options.vectorSearch),e.off("load",o)};e.on("load",s,t)}():this._cacheLayer(e,!1,this.options.vectorSearch))):!1},_setACOptions:function(e){var t=this;for(var s in e.keyVals)break;var o=e.keyVals[s],a=e.suffix,n=this.options.suffix;this.options.typeaheadOptions=$.extend(!0,{},this.options.typeaheadOptions,{source:$.proxy(function(e,t){e=encodeURIComponent(e);var s=this.options.wsAcUrl;s?(this.options.whitespace&&(e=e.replace(/%20/g,this.options.whitespace)),this._proxyInst&&this._proxyInst.abort(),smap.cmd.loading(!0),this._proxyInst=$.ajax({type:"GET",url:this.options.useProxy?smap.config.ws.proxy+encodeURIComponent(s+"?q=")+e:s+"?q="+e,dataType:"text",context:this,success:function(e){for(var s,o=e.split("\n"),a=[],n=0,r=o.length;r>n;n++)s=$.trim(o[n]),s.length&&a.push({name:s,searchWords:"Adress=="+s});a=this._acVector.concat(a),t(a)},error:function(){},complete:function(){smap.cmd.loading(!1)}})):t(this._acVector)},this),displayText:function(e){return e.searchWords},highlighter:function(e){for(var t,s={},o=e.split("&&"),a=0,n=o.length;n>a;a++)t=o[a].split("=="),s[t[0]]=t[1];var r="",a=0;for(var i in s)r+=0===a?'<div style="font-size:1.2em;">'+s[i]+"</div>":"<div><span>"+i+"</span>:&nbsp;<span>"+s[i]+"</span></div>",a++;return r},updater:function(e){for(var t,s={},r=e.searchWords.split("&&"),i=0,p=r.length;p>i;i++)t=r[i].split("=="),s[t[0]]=t[1];return s[o]?e.name+" "+a:e.name+" "+n},afterSelect:function(s){if(t._searchLayer.clearLayers(),t.options.clearEntryAfterSearch&&$(".smap-search-div input").val(null),encodeURIComponent(s).search(encodeURIComponent(n))>-1)s=$.trim(s.replace(n,"")),t._geoLocate(s,"");else if(encodeURIComponent(s).search(encodeURIComponent(a))>-1){s=$.trim(s.replace(a,""));for(var o in e.keyVals)break;var r,i,p,c,h=t.map;for(c in h._layers)if(r=h._layers[c],r._layers)for(p in r._layers)if(i=r._layers[p],i.feature&&i.feature.properties[o]===s){var l;return l=i.getLatLng?i.getLatLng():i.getBounds().getCenter(),h.setView(l,17),void h.fire("selected",{feature:i.feature,selectedFeatures:[i],layer:r,latLng:l,shiftKeyWasPressed:!1})}t._wfsLayerGroup.eachLayer(function(e){e.eachLayer(function(a){if(a.feature&&a.feature.properties[o]===s){t._searchLayer.addLayer(a),this.marker=a;var n;return n=a.getLatLng?a.getLatLng():a.getBounds().getCenter(),h.setView(n,17),void h.fire("selected",{feature:a.feature,selectedFeatures:[a],layer:e,latLng:n,shiftKeyWasPressed:!1})}})})}}});var r=$("#smap-search-div input");r.typeahead("destroy"),this._initAutoComplete(r)},_onApplyParams:function(e,t){if(t.POI){var s=t.POI instanceof Array?t.POI[0]:t.POI;s=s.replace(/--c--/g,",");var o=t.POI instanceof Array&&t.POI.length>1?t.POI[1]:!1,a=!1,n=smap.core.paramInst.getWebParamsAsObject(),r=config.params,i=n.ZOOM||this.options.zoom;n.CENTER||(a=!0,!n.POI&&r.CENTER&&(a=!1,i=t.ZOOM)),this._geoLocate(decodeURIComponent(s),{setView:a,zoom:i,showPopup:o})}},_onCreateParams:function(e,t){if(this.marker&&this.marker.options.q){var s=this.marker.getPopup()._isOpen?!0:!1;t.poi=[encodeURIComponent(this.marker.options.q.replace(/,/g,"--c--"))],s&&t.poi.push(1)}},_rmAdressMarker:function(e){null!=e&&(this._searchLayer.removeLayer(e),this.addressMarker=null)},_makeSearchField:function(){function e(){var e=$(window).width();if(!(e>=o.options.pxDesktop)&&utils.isTouchOnly()){var t=$("#smap-search-bg");t.length||(t=$('<div id="smap-search-bg" />'),a.addClass("search-active"),$("#mapdiv").append(t),setTimeout(function(){t.addClass("search-bg-visible")},1))}}function t(){var e=$(window).width();e>=o.options.pxDesktop||!utils.isTouchOnly()||(a.removeClass("search-active"),$("#smap-search-bg").removeClass("search-bg-visible"),setTimeout(function(){$("#smap-search-bg").remove()},300))}function s(e){e.stopPropagation()}var o=this,a=$('<div id="smap-search-div" class="smap-search-div input-group input-group-lg"><span class="input-group-addon"><span class="glyphicon glyphicon-search"></span></span><input autocorrect="off" autocomplete="off" data-provide="typeahead" type="text" class="form-control" placeholder="'+this.lang.search+'"></input></div>'),n=a.find("input");n.placeholder(),L.Browser.msTouch&&n.attr("pattern","[0-9]"),n.on("dblclick",s).on("mousedown",s).on("focus",function(){$(this).parent().addClass("smap-search-div-focused"),$("#mapdiv").trigger("touchstart"),o.map.fire("mousedown"),e()}).on("blur",function(){$(this).parent().removeClass("smap-search-div-focused")}).on("touchstart",function(){$(this).focus()}),a.on("click touchstart",function(e){$(this).find("input").focus(),e.stopImmediatePropagation()}),n.on("blur",t),$("#maindiv").append(a),smap.event.on("smap.core.pluginsadded",function(){var e=$("#smap-menu-div nav");e.length&&a.addClass("smap-search-div-in-toolbar")});var r=this.options.whitespace,i=this.options._geoLocate||this._geoLocate,p={items:5,minLength:2,highlight:!0,hint:!0,afterSelect:function(e){return smap.cmd.loading(!0),i.call(o,e),t(),e}};$.extend(p,this.options.acOptions||{}),this.options.source?p.source=$.proxy(this.options.source,this):this.options.wsAcUrl?p.source=function(e,t){e=encodeURIComponent(e);var s=o.options.wsAcUrl;r&&(e=e.replace(/%20/g,r)),o._proxyInst&&o._proxyInst.abort(),o._proxyInst=$.ajax({type:"GET",url:o.options.useProxy?smap.config.ws.proxy+encodeURIComponent(s+"?q=")+e:s+"?q="+e,dataType:"text",success:function(e){var s=e.split("\n");t(s)},error:function(){}})}:this.options.wsAcLocal&&this.options.wsAcLocal instanceof Array&&(p.source=this.options.wsAcLocal),this._initAutoComplete(n,p)},_initAutoComplete:function(e,t){t=t||this.options.typeaheadOptions;var s=this.options.autoScrollAcOnRowNbr;if(this._onKeyPress=this._onKeyPress||function(e){var t=38===e.which,o=40===e.which;if(t||o){var a=$(".typeahead.dropdown-menu li.active"),n=a.parent().find("li").length;if(t&&1===a.index()||o&&a.index()===n-1)a.parent().scrollTo($(".typeahead.dropdown-menu li:first"),0);else if(t&&0===a.index())a.parent().scrollTo($(".typeahead.dropdown-menu li:last"),0);else if(a.index()>=s){for(var r=a,i=0;s/2>i;i++)r=r.prev();r&&r.length&&a.parent().scrollTo(r,0)}}},e.off("keydown",this._onKeyPress).on("keydown",this._onKeyPress),e.typeahead(t),this.options.acHeight){var o=e.data("typeahead").$menu;o.css({"max-height":this.options.acHeight})}},_processLinks:function(e){var t=$("<div />");return t.append(e),t.find("a").each(function(){var e=$("<a onclick=\"window.open('"+$(this).prop("href")+'\')"><i class="fa fa-external-link"></i> '+$(this).text()+"</a>");$(this).after(e),$(this).remove()}),t.html()},_geoLocate:function(e,t){t=t||{};var s={setView:!0,showPopup:!0};t=$.extend({},s,t),this.options.qPattern&&(e=utils.extractToHtml(this.options.qPattern,{q:e})),e=encodeURIComponent(e);var o=this.options.wsLocateUrl;if(this.options.useProxy){o=smap.config.ws.proxy+encodeURIComponent(o+"?q=")+e;var a=this.options.whitespace;a&&(o=o.replace(/%20/g,a))}else o=o+"?q="+e;var n={success:function(s){function o(e){$("#smap-search-popupbtn").off("click").on("click",function(){return a._searchLayer.removeLayer(a.marker),a.marker=null,!1})}var a=this;if(this.marker&&(this._searchLayer.removeLayer(this.marker),this.marker=null),!s.features.length)return void smap.cmd.notify(this.lang.addressNotFound,"error");var n=s.features[0],r=n.geometry.coordinates,i=L.latLng(r[1],r[0]),p="EPSG:4326";if(this.options.wsOrgProj&&this.options.wsOrgProj!==p){var c=window.proj4(this.options.wsOrgProj,p,[i.lng,i.lat]);i=L.latLng(c[1],c[0])}this.map.off("popupopen",o),this.map.on("popupopen",o),this.marker=L.marker(i,{iconOptions:L.icon(this.options.iconOptions)}).addTo(this._searchLayer),this.marker.options.q=e;var h='<div class="smap-search-btnremove"><button id="smap-search-popupbtn" class="btn btn-default btn-sm">'+this.lang.remove+"</button></div>",l='<p class="smap-search-popupcontent lead">'+decodeURIComponent(e)+"</p>",u=l+h,d=u;this.options.popupContent&&(d="",d+=l,d+=this._processLinks(utils.extractToHtml(this.options.popupContent,n.properties)),d+=h),this.marker.bindPopup(d);var m=t.zoom||this.options.zoom;t.setView?this.map.setView(i,m,{animate:!1}):this.marker._popup.options.autoPan=!1,t.showPopup&&this.marker.openPopup(),this.options.clearEntryAfterSearch&&$(".smap-search-div input").val(null),$(".smap-search-div input").blur(),setTimeout(function(){$(".smap-search-div input").blur()},100)},complete:function(){smap.cmd.loading(!1)}};$.ajax({url:o,type:"GET",dataType:"json",context:this,success:this.options.onLocateSuccess||n.success,complete:n.complete})},CLASS_NAME:"L.Control.Search"}),L.control.search=function(e){return new L.Control.Search(e)}}]);