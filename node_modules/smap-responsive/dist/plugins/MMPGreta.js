!function(t){function e(o){if(i[o])return i[o].exports;var a=i[o]={exports:{},id:o,loaded:!1};return t[o].call(a.exports,a,a.exports,e),a.loaded=!0,a.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e){"use strict";L.Control.MMPGreta=L.Control.extend({options:{wsSave:location.protocol+"//kartor.malmo.se/gkgreta/KartService.svc/saveGeometry",xhrType:"GET",inputCrs:"EPSG:3008",saveCrs:"EPSG:3008",uniqueKey:!1,reverseAxis:!1,reverseAxisBbox:!0,colorSaved:"#71A500",colorUnSaved:"#FF0000",statusKey:"Attribut",statusColors:{passed:"blue",now:"darkred",future:"orange"},popup:'<div><div>${TooltipTitle}</div><div>${Tooltip}</div><div style="margin-top: 0.7em;">${TooltipUrl}</div></div>'},_lang:{sv:{addPoint:"Rita punkt",addPolyline:"Rita linje",addPolygon:"Rita yta",remove:"Ta bort",edit:"Redigera",save:"Spara",instructEditing:"Klicka här igen när du redigerat klart",saveSuccess:"<b>Ändringarna har sparats!</b>",saveError:"<b>Ändringarna kunde inte sparas!</b><p>Felet har loggats till utvecklingskonsolen.</p>"},en:{addPoint:"Draw point",addPolyline:"Draw line",addPolygon:"Draw polygon",remove:"Remove",edit:"Edit",save:"Save",instructEditing:"Click here when you are done editing",saveSuccess:"Edits saved!",saveError:"Could not save edits!"}},initialize:function(t){L.setOptions(this,t),t._lang&&$.extend(!0,this._lang,t._lang),this._setLang(t.langCode),L.Edit.Poly.addInitHook(function(){this._poly&&!this._poly.options.editing&&(this._poly.options.editing={}),this._fireEdit=function(){this._poly.edited=!0,this._poly.fire("edit"),smap.map.fire("draw:editedpoly",this._poly)}}),L.Edit.Marker.addInitHook(function(){this._onDragEnd=function(t){var e=t.target;e.edited=!0,smap.map.fire("draw:editedmarker",e)}}),L.EditToolbar.Delete.addInitHook(function(){this._removeLayer=function(t){var e=t.layer||t.target||t,i=e.editing._marker;i&&i.options.hasOwnProperty("editable")&&i.options.editable===!1?smap.cmd.notify("Ärendepunkter kan inte redigeras/tas bort","warning",{fade:!0}):(this._deletableLayers.removeLayer(e),this._deletedLayers.addLayer(e),this._map.fire("mmpgreta:edited"))}})},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-MMPGreta"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._bindEvents(),this._tools={},this._container},_bindEvents:function(){smap.event.on("smap.core.createjsonlayer",function(t,e){function i(t){var e=t.target.feature.properties;if(e.TooltipTitle&&e.Tooltip){var i="<b>"+e.TooltipTitle+"</b><p>"+e.Tooltip+"</p>";$(".leaflet-top.leaflet-right").find("button.active").length||(this._tooltip=utils.createLabel(t.latlng,i,"mmpgreta-tooltip"),this._map.addLayer(this._tooltip))}}function o(t){this._tooltip&&this._map.removeLayer(this._tooltip)}$.extend(e,{inputCrs:this.options.inputCrs,uniqueKey:this.options.uniqueKey,reverseAxis:this.options.reverseAxis,reverseAxisBbox:this.options.reverseAxisBbox,noBindZoom:!0,noBindDrag:!0,style:{fillColor:this.options.colorSaved,color:this.options.colorSaved,opacity:1},pointToLayer:function(t,e){var a=t.properties,n=this.options.statusColors[a[this.options.statusKey]],s=n?!1:!0,r=a.Icon&&a.Icon.length?a.Icon:"warning";r=r.replace("fa fa-","").replace(/fa/g,"");var d=L.AwesomeMarkers.icon({icon:r,prefix:"fa",markerColor:s?"green":n}),l=L.marker(e,{icon:d});return l.on("mouseover",i.bind(this)),l.on("mouseout",o.bind(this)),t.id&&t.id.toUpperCase().indexOf("POI_ARENDE_")>-1&&(l.options.editable=!1,l.options.draggable=!1,delete l.editing,l.editing={enable:function(){},disable:function(){},_marker:l}),l}.bind(this)})}.bind(this));var t=this;smap.event.on("smap.core.beforeapplyparams",function(e,i){i.GRETA_EDITID?(this._editId=parseInt(i.GRETA_EDITID),smap.event.on("smap.core.addedjsonlayer",function(e,i){if(this._hasInitiated)return!1;this._hasInitiated=!0,i.options.popup=t.options.popup;var o=function(){var e=L.featureGroup([],{selectable:!0});e.options={},this.map.removeLayer(i),i.eachLayer(function(t){e.addLayer(t)}),this._editLayer=e,this.map.addLayer(e),this.addEditPanel(e),this.map.on("unselected",function(){e.eachLayer(function(e){if(e.editing&&e.editing._poly&&(e.options||e.editing._poly.options)){var i=e.editing._poly,o=e.editing._poly.options||e.options,a="#FF0000"===o.color?!1:!0;a===!1?setTimeout(function(){t._updateLayerStyle(a,i)},0):t._updateLayerStyle(a,i)}})}),i.off("load",o)}.bind(this);i.on("load",o)}.bind(this))):smap.event.on("smap.core.addedjsonlayer",function(e,i){i.options.popup=t.options.popup,delete i.pointToLayer}.bind(this)),this._map.on("selected",function(){this._tooltip&&this.map.removeLayer(this._tooltip)}.bind(this))}.bind(this))},onRemove:function(t){},_adaptUrl:function(t){if(!t||!t.length||"string"!=typeof t)return t;switch(document.domain){case"localhost":return t.replace("kartor.malmo.se","localhost");case"kartor.malmo.se":return t;default:return t}},onStartEdit:function(){alert("edited indeed")},_getTool:function(t){if(t=utils.capitalize(t.toLowerCase()),!this._tools[t]){var e,i;switch(t){case"Delete":e=L.EditToolbar.Delete;var o={featureGroup:this._editLayer};i=new e(this.map,o);break;case"Edit":i={enable:this.startEditing.bind(this),disable:this.stopEditing.bind(this)};break;default:e=L.Draw[t]||L.Edit[t]||L.EditToolbar[t],i=new e(this.map,o);var o=this._drawControl.options.draw[t],a=this.options.colorUnSaved;i.options.shapeOptions={color:a,fillColor:a}}this._tools[t]=i}return this._tools[t]},_deactivateAllTools:function(t){for(var e in this._tools)t&&e.toUpperCase()===t.toUpperCase()||this._deactivateTool(e)},_activateTool:function(t){this._deactivateAllTools(t);var e=this._getTool(t);switch(t){case"DELETE":}e.enable()},_deactivateTool:function(t){var e=this._getTool(t),i=$(".mmpgreta-type-"+t.toLowerCase());e.disable(),i.removeClass("active btn-danger")},startEditing:function(){this._editLayer.options.editable=!0,smap.cmd.loading(!0);setTimeout(function(){this._editLayer.eachLayer(function(t){switch(t.editing){case void 0:break;default:t.editing.enable()}}),smap.cmd.loading(!1)}.bind(this),1)},stopEditing:function(){this._editLayer.options.editable=!1,smap.cmd.loading(!0),setTimeout(function(){this._editLayer.eachLayer(function(t){t.editing&&t.editing.disable()}),smap.cmd.loading(!1)}.bind(this),1)},addEditPanel:function(t){function e(e){var i=(e.layerType,e.layer);t.addLayer(i),this._deactivateAllTools(),this._map.fire("mmpgreta:edited",i)}function i(t){var e=$(this),i=e.prop("data-geomtype");return e.toggleClass("active btn-danger").hasClass("active")?a._activateTool(i):a._deactivateTool(i),!1}var o=new L.Control.Draw({draw:!1,edit:{featureGroup:t,remove:!1}});this.map.addControl(o),this._drawControl=o,$(".leaflet-draw").remove(),this.map.on("draw:created",e.bind(this));var a=this,n=this._addBtn("fa fa-save",this.lang.save,function(){this._deactivateAllTools(),this.save()}.bind(this));n.prop("id","btn-save"),this._allowSaving(!1),this._map.on("draw:editedpoly",function(t){a._updateLayerStyle(!1,t.editing._poly),a._allowSaving(!0),t.editing._poly.options._save=!1,t.editing._poly.options._saved=t.options._saved=!1}),this._map.on("draw:editedmarker",function(t){a._updateLayerStyle(!1,t.editing._marker),a._allowSaving(!0),t.editing._marker.options._save=t.options._saved=!1}),this._map.on("mmpgreta:edited",function(t){if(this._allowSaving(!0),t&&t.options&&t.options.icon){var e=t.editing._marker||t;e.setIcon(L.AwesomeMarkers.icon({icon:"warning",prefix:"fa",markerColor:"red"})),t.options._saved=!1}}.bind(this)),this._addToolBtn("fa fa-eraser",this.lang.remove,"DELETE",i),this._addToolBtn("fa fa-edit",this.lang.edit,"EDIT",i),this._addToolBtn("fa fa-object-ungroup",this.lang.addPolygon,"POLYGON",i),this._addToolBtn("fa fa-code-fork",this.lang.addPolyline,"POLYLINE",i),this._addToolBtn("fa fa-map-marker",this.lang.addPoint,"MARKER",i);var s=smap.cmd.getControl("ToolHandler");s&&s.update()},_allowSaving:function(t){var e=$("#btn-save .btn");t?e.prop("disabled",!1):e.prop("disabled",!0)},removeEditPanel:function(){},_addBtn:function(t,e,i){var o=$('<div class="leaflet-control"><button title="'+e+'" class="btn btn-default"><span class="'+t+'"></span></button></div>');return o.find(".btn").on("click",i),$(".leaflet-top.leaflet-right").append(o),o.prop("title",e).tooltip({placement:"bottom"}),o},_addToolBtn:function(t,e,i,o){var a=this._addBtn(t,e,o);return a.find(".btn").prop("data-geomtype",i).addClass("mmpgreta-type-"+i.toLowerCase()),a},filterBeforeSave:function(t){var e=this;return t.features.forEach(function(t,i){utils.projectFeature(t,"EPSG:4326",e.options.saveCrs,{reverseAxisOutput:!1,decimals:0}),t.properties.ArendeId=e._editId}),t.features=t.features.filter(function(t){return!t.id||t.id&&-1===t.id.toUpperCase().indexOf("POI_ARENDE_")}),t},_updateLayerStyle:function(t,e){e=e||this._editLayer;var i;if(e.setStyle){i=t?this.options.colorSaved:this.options.colorUnSaved;var o={fillColor:i,color:i,opacity:1};e.setStyle(o),e.options.style=o}else{i=t?"green":"red";var a=t?"red":"green",n="awesome-marker-icon-";e.options.icon.options.markerColor=i,$(e._icon).removeClass(n+a).addClass(n+i)}},_addPreventCacheParam:function(t){var e=t.charAt(t.length-1),i=t.indexOf("?")>0;return i?"&"!==e&&"?"!==e&&(t+="&"):t+="?",t+"_="+(new Date).getTime()},save:function(){var t=this._editLayer.toGeoJSON();t=this.filterBeforeSave(t);var e=this;console.log(t),$.ajax({type:"POST",contentType:"text/plain; charset=utf-8",url:this._adaptUrl(this.options.wsSave),data:JSON.stringify(t),dataType:"json",context:this,success:function(i,o){"true"===i.success?(smap.cmd.notify(this.lang.saveSuccess,"success",{fade:!0}),this._allowSaving(!1),this._updateLayerStyle(!0),this._editLayer.eachLayer(function(t){t.options._saved===!1&&(t.options._saved=!0,e._updateLayerStyle(!0,t))}),this._prevJson=t):smap.cmd.notify(this.lang.saveError,"error",{fade:!0})},error:function(t,e,i){console.log(t.responseText),smap.cmd.notify(this.lang.saveError,"error",{fade:!0})}})}})}]);