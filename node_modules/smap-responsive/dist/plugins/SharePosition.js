!function(t){function e(s){if(n[s])return n[s].exports;var o=n[s]={exports:{},id:s,loaded:!1};return t[s].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e){"use strict";L.Control.SharePosition=L.Control.extend({options:{position:"bottomright",autoActivate:!1,wfsSource:"//kartor.malmo.se:8081/geoserver/wfs",wfsFeatureType:"sandbox:sharedpositions",wfsUri:"//www.malmo.se/sandbox/",useProxy:!0,maxAge:15,_refreshIntervalMs:1e4,_storeIntervalMs:1e4},_lang:{sv:{dTitle:"Dela position",dShare:"Dela!",yourName:"Ditt namn",stopSharing:"Sluta dela",btnCancel:"Avbryt"},en:{dTitle:"Share position",dShare:"Share!",yourName:"Your name",stopSharing:"Stop sharing",btnCancel:"Cancel"}},_setLang:function(t){t=t||smap.config.langCode||navigator.language.split("-")[0]||"en",this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},deactivate:function(){this._stopRefresh(),$("#smap-share-btn").removeClass("btn-danger"),this.dialog.find("input").val(null),$("#smap-share-btn").hide(),this.map.removeLayer(this.layer)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-shareposition"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._drawGui(),this._bindEvents(),this._container},onRemove:function(t){t.stopLocate()},_drawGui:function(){var t=$('<button id="smap-share-btn" class="btn btn-default" type="button"><span class="fa fa-user"></span></button>');t.hide(),this.$container.append(t);var e=this;smap.event.on("smap.core.pluginsadded",function(){$(".leaflet-control-Geolocate").before(e.$container)});var n='<div class="form-group"><label>'+this.lang.yourName+'</label><input type="text" class="form-control" placeholder="'+this.lang.yourName+'"></input></div>',s=$('<button type="button" class="btn btn-default" data-dismiss="modal">'+this.lang.btnCancel+'</button><button type="button" class="btn btn-primary">'+this.lang.dShare+"</button>");this.dialog=utils.drawDialog(this.lang.dTitle,n,s)},_makeFilter:function(){var t=this.options.maxAge,e=new Date,n=e.getTime(),s=n-60*t*1e3,o=new Date(s),a=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.GREATER_THAN,property:"datetime_changed",value:o}),i=new OpenLayers.Format.Filter({version:"1.1.0"}),r=new OpenLayers.Format.XML,l=r.write(i.write(a));return l},_addLayer:function(){var t=this;this.layer=smap.core.layerInst._createLayer({init:"L.GeoJSON.WFS",url:this.options.wfsSource,options:{noBindZoom:!0,noBindDrag:!0,layerId:"_shareposition",displayName:"Shared locations",featureType:this.options.wfsFeatureType,attribution:"Malm√∂ stads WFS",inputCrs:"EPSG:4326",selectable:!0,popup:'<span><strong>${text_username}</strong>&nbsp;&nbsp;(<span style="white-space:nowrap;">${function(p) {var d = new Date(p.datetime_changed);var dNow = new Date(); var dDiff = new Date( Math.abs(dNow.getTime() - d.getTime()) ); return dDiff.getMinutes(); }}</span> min ago)</span>',hoverColor:"#FF0",zIndex:350,reverseAxis:!1,reverseAxisBbox:!0,uniqueKey:"id",params:{typeName:"sandbox:sharedpositions",version:"1.1.0",maxFeatures:1e4,format:"text/geojson",outputFormat:"json"}}}),this.layer.options.params.filter=this._makeFilter(),this.layer.off("load"),this.layer.on("load",function(){t.layer.eachLayer(function(e){var n=L.userMarker(e.getLatLng(),{pulsing:!0,smallIcon:!0});if(t.layer.removeLayer(e),e.feature){var s=parseInt(e.feature.id.split(".")[1]),o=t.uid||localStorage.share_uid||null;o=parseInt(o),(!o||o&&o!==s)&&t.layer.addLayer(n);var a=utils.extractToHtml(t.layer.options.popup,e.feature.properties);n.bindLabel(a,{noHide:!0,direction:"right"}).showLabel()}}),smap.cmd.loading(!1)}),this.map.addLayer(this.layer);var t=this},_bindEvents:function(){var t=this;smap.event.on("smap.core.pluginsadded",function(){$("#smap-glocate-btn").on("click",function(){return $(this).hasClass("btn-primary")?($("#smap-share-btn").show(),t._addLayer(),t._startRefresh()):(t._stopShare(),t.deactivate()),!1}),$("#smap-share-btn").on("click",function(){var e=$(this).hasClass("btn-danger");e?($(this).removeClass("btn-danger"),t._stopShare()):t.dialog.modal("show")})}),this.dialog.find("input").on("click",function(){$(this).focus()}),this.dialog.find(".modal-footer .btn-primary").on("click",function(){$("#smap-share-btn").addClass("btn-danger"),t.dialog.modal("hide");var e=$.trim(t.dialog.find("input[type='text']").val());t._startShare(e)})},_onLocationFound:function(t){this._location=t},_onLocationError:function(t){smap.cmd.loading(!1)},_setLocateSettings:function(){var t={watch:!0,timeout:3e4,enableHighAccuracy:!0,frequency:3e3};$.extend(this.map._locateOptions,t)},_startShare:function(t){return this._storeInterval?!1:(utils.log("START sharing"),this.uName=t,this.__onLocationFound=this.__onLocationFound||$.proxy(this._onLocationFound,this),this.__onLocationError=this.__onLocationError||$.proxy(this._onLocationError,this),this.map.on("locationfound",this.__onLocationFound),this.map.on("locationerror",this.__onLocationFound),this.uid=localStorage.share_uid||null,this.__store=this.__store||$.proxy(this._store,this),this._storeInterval=setInterval(this.__store,this.options._storeIntervalMs),this._setLocateSettings(),void this.map.fire("drag"))},_startRefresh:function(){return this._refreshInterval?!1:(utils.log("start refreshing"),this.__refresh=this.__refresh||$.proxy(this._refresh,this),void(this._refreshInterval=setInterval(this.__refresh,this.options._refreshIntervalMs)))},_stopRefresh:function(){utils.log("stop refreshing"),clearInterval(this._refreshInterval),this._refreshInterval=null},_stopShare:function(){smap.cmd.loading(!1),utils.log("stop sharing"),this._stopRefresh(),clearInterval(this._storeInterval),this._storeInterval=null,this.map.off("locationfound",this.__onLocationFound,this),this.map.off("locationerror",this.__onLocationError,this),this._location=null,this.uid=null,this.uName=null},uid:null,_store:function(){return this._working||!this._location?!1:(this._working=!0,void $.ajax({url:this.options.useProxy?smap.config.ws.proxy+encodeURIComponent(this.options.wfsSource):this.options.wfsSource,type:"POST",context:this,data:this._getXml(this._location.latlng,this._location.accuracy,this.uName,this.uid),contentType:"text/xml",dataType:"text",error:function(t,e,n){utils.log("SharePosition: Error storing coordinates because of: "+e)},success:function(t){var e=$.xml2json(t),n=e?e.TransactionResponse||e["wfs:TransactionResponse"]:null;if(n){var s=n?n.TransactionSummary||n["wfs:TransactionSummary"]:null;if(s){var o=parseInt(s.totalInserted||s["wfs:totalInserted"]),a=parseInt(s.totalUpdated||s["wfs:totalUpdated"]);if(!this.uid&&o>0){var i=n.InsertResults||n["wfs:InsertResults"],r=i.Feature||i["wfs:Feature"],l=r.FeatureId||r["ogc:FeatureId"],h=l.fid||l.$.fid;this.uid=parseInt(h.split(".")[1]),localStorage.share_uid=this.uid}else 0===o&&0===a&&(this.uid=null,delete localStorage.share_uid)}}},complete:function(){this._working=!1}}))},_refresh:function(){this.layer.options.params.filter=this._makeFilter(),this.layer._refresh({force:!0})},_getXml:function(t,e,n,s){var o="",a=this.options.wfsFeatureType.split(":")[1];return o=s?'<wfs:Transaction\n  service="WFS"\n  version="1.1.0"\n  xmlns:grp="'+this.options.wfsUri+'"\n  xmlns:wfs="//www.opengis.net/wfs"\n  xmlns:ogc="//www.opengis.net/ogc"\n  xmlns:gml="//www.opengis.net/gml"\n  xmlns:xsi="//www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="//www.opengis.net/wfs\n                      //schemas.opengis.net/wfs/1.1.0/WFS-transaction.xsd">\n  <wfs:Update typeName="grp:'+a+'">\n	 <wfs:Property><wfs:Name>text_username</wfs:Name><wfs:Value>'+n+"</wfs:Value></wfs:Property>	 <wfs:Property><wfs:Name>int_accuracy</wfs:Name><wfs:Value>"+e+'</wfs:Value></wfs:Property>    <wfs:Property>\n      <wfs:Name>the_geom</wfs:Name>\n      <wfs:Value>\n        <gml:Point srsDimension="2" srsName="urn:x-ogc:def:crs:EPSG:4326">\n          <gml:coordinates decimal="." cs="," ts=" ">'+t.lat+","+t.lng+"</gml:coordinates>\n        </gml:Point>\n      </wfs:Value>\n    </wfs:Property>\n    <ogc:Filter>\n      <PropertyIsEqualTo>\n        <PropertyName>id</PropertyName>\n        <Literal>"+s+"</Literal>\n      </PropertyIsEqualTo>\n    </ogc:Filter>\n  </wfs:Update>\n</wfs:Transaction>":'<wfs:Transaction\n  service="WFS"\n  version="1.1.0"\n  xmlns:grp="'+this.options.wfsUri+'"\n  xmlns:wfs="//www.opengis.net/wfs"\n  xmlns:gml="//www.opengis.net/gml"\n  xmlns:xsi="//www.w3.org/2001/XMLSchema-instance"\n  xsi:schemaLocation="//www.opengis.net/wfs\n                      //schemas.opengis.net/wfs/1.1.0/WFS-transaction.xsd\n                      '+this.options.wfsSource+"/DescribeFeatureType?typename="+this.options.wfsFeatureType+'">\n  <wfs:Insert>\n    <grp:'+a+'>\n      <grp:the_geom>\n        <gml:Point srsDimension="2" srsName="urn:x-ogc:def:crs:EPSG:4326">\n          <gml:coordinates decimal="." cs="," ts=" ">'+t.lat+","+t.lng+"</gml:coordinates>\n        </gml:Point>\n      </grp:the_geom>\n      <grp:int_accuracy>"+e+"</grp:int_accuracy>\n      <grp:text_username>"+n+"</grp:text_username>\n    </grp:"+a+">\n  </wfs:Insert>\n  </wfs:Transaction>"}}),L.control.sharePosition=function(t){return new L.Control.SharePosition(t)}}]);