!function(t){function e(n){if(a[n])return a[n].exports;var r=a[n]={exports:{},id:n,loaded:!1};return t[n].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var a={};return e.m=t,e.c=a,e.p="",e(0)}([function(t,e){"use strict";L.Control.MMP=L.Control.extend({options:{statusColors:{ej_registrerat:"darkred",registrerat:"orange",pagaende:"cadetblue",avslutat:"black",avvisat:"black",vidarebefordrat:"darkpurple",atgardat:"green",senare_behandling:"black"},userMarker:{color:"black",icon:"arrows"},geolocateMoveUserMarker:!0,geoJsonUniqueKey:"ID",position:"bottomright",minZoom:13,externalDataLayerOptions:null,disableClusteringAtZoom:13,wsSave:{dev:location.protocol+"//gkkundservice.test.malmo.se/KartService.svc/saveGeometry",prod:location.protocol+"//gkkundservice.malmo.se/KartService.svc/saveGeometry"}},_lang:{sv:{btnLabel:"Spara",clickHereToSave:"Klicka här för att spara positionen",dragInfo:'<div style="font-size:1.2em;"><strong style="font-size:1.3em;">Instruktioner</strong><ol style="margin:0;padding-left:1.65em;margin-top:0.5em;"><li>Zooma in i kartan så mycket som möjligt</li><li>Klicka i kartan för att markera platsen för ärendet<br />(pekskärm: peka och håll kvar fingret på en plats)</li></ol></div>',youCanDragMeOrClick:"<strong>Klicka i kartan</strong> igen eller <strong>dra i markören</strong> för att ändra positionen",btnSave:"Spara aktuell position",btnSaved:"Position sparad",zoomInMore:"Du måste zooma in mer i kartan för att kunna lägga till markör"},en:{btnLabel:"Save",clickHereToSave:"Click here to save new position",dragInfo:"<h1>Instructions</h1><ol><li>Zoom the map as much as possible</li><li>Then click once in the map to set the location of the incident</li></ol>",youCanDragMeOrClick:"Click on the map again or drag the marker to adjust the location",btnSave:"Save current position",btnSaved:"Position saved",zoomInMore:"You must zoom the map more before you can add a marker"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-mmp"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._bindEvents(),this._mmpExternalLayers=[],this._cluster=L.markerClusterGroup({disableClusteringAtZoom:this.options.disableClusteringAtZoom||this.map.options.maxZoom+1}),this._bindClusterEvents(this._cluster),this.map.addLayer(this._cluster),this._container},onRemove:function(t){this._unbindEvents(),this.$btn.empty().remove(),this._mmpExternalLayers=null,this.map.removeLayer(this._cluster),this.map.off("zoomend dragend",this._refreshCluster),this._cluster=null},_bindClusterEvents:function(t){this.map.on("zoomend dragend",this._refreshCluster,this)},_refreshCluster:function(){var t=this;this._cluster;this._mmpExternalLayers.forEach(function(e){e._refresh&&(e._map=t.map,e._refresh(),delete e._map)})},activateAddMarker:function(){this._editingIsActive=!0,this._createBtn();var t;t=utils.isTouchOnly()?"contextmenu":"click",this.map.on(t,this.onMapClick,this)},deactivateAddMarker:function(){this._editingIsActive=!1;var t;t=utils.isTouchOnly()?"contextmenu":"click",this.map.off(t,this.onMapClick),$("#smap-mmp-btn").empty().remove(),this.$btn=null},onMapClick:function(t){return this.map.getZoom()<this.options.minZoom?void smap.cmd.notify(this.lang.zoomInMore,"error",{fadeOut:5e3}):(this._marker&&(this.map.removeLayer(this._marker),this._marker=null),this._toggleBtn(!1),void this._addMarker(t.latlng))},onHashChange:function(t,e){var a=location.hash.substring(1),n=utils.paramsStringToObject(a,!0);if(n&&n.MMP_DATA){var r=n.MMP_DATA;r=this._adaptUrl(r),r=decodeURIComponent(r),this._counterLayerId=this._counterLayerId||0,this._clearExternalData(),this._counterLayerId+=1;var o=$.extend({layerId:"mmp-extlayer-"+this._counterLayerId},this.options.externalDataLayerOptions);this._addExternalData(r,o)}},_bindEvents:function(){var t=this;smap.event.on("smap.core.beforeapplyparams",function(t,e){var a=e.OL||"";a=a.split(","),a.push(e.CATEGORY),a=a.join(","),e.OL=a}),smap.event.on("smap.core.applyparams",function(e,a){if(t.options.wsSave instanceof Object){var n=a.ISPROD&&a.ISPROD.length?a.ISPROD.toUpperCase():"FALSE",r={FALSE:t.options.wsSave.dev,TRUE:t.options.wsSave.prod};t.options.wsSave=r[n]}a.MMP_EDIT&&"TRUE"===a.MMP_EDIT.toUpperCase()&&t.activateAddMarker();var o=null,s=null;if(a.MMP_XY){var o=a.MMP_XY instanceof Array?a.MMP_XY:a.MMP_XY.split(",");o=$.map(o,function(t){return parseFloat(t)}),s=utils.projectLatLng(L.latLng(o),"EPSG:3008","EPSG:4326",!0,!1)}else this._editingIsActive&&smap.cmd.notify(t.lang.dragInfo,"info");a.MMP_ID&&(t._tempId=a.MMP_ID),s&&t._addMarker(s),t.onHashChange()}),smap.event.on("hashchange",this.onHashChange.bind(this))},_clearExternalData:function(){for(var t=this._mmpExternalLayers,e=0;e<t.length;e++)smap.cmd.hideLayer(t[e]);this._mmpExternalLayers=[]},_addExternalData:function(t,e){function a(t){return t.toLowerCase().replace(/ /g,"_").replace(/å/g,"a").replace(/ä/g,"a").replace(/ö/g,"o")}e=e||{};var n,r={url:t,init:"L.GeoJSON.WFS",options:$.extend(!0,{layerId:L.stamp(this),displayName:"Incidenter",xhrType:this.options.xhrType?this.options.xhrType:"GET",attribution:"Malmö stad",inputCrs:"EPSG:3008",uniqueKey:this.options.geoJsonUniqueKey,selectable:!0,reverseAxis:!1,showInLayerSwitcher:!0,reverseAxisBbox:!0,geomType:"POINT",includeParams:["bbox"],separator:"&",noParams:e.noParams||!1,popup:"*",pointToLayer:function(t,e){var n=L.AwesomeMarkers.icon({icon:"warning",prefix:"fa",markerColor:o.options.statusColors[a(t.properties.Status)]||"white"}),r=L.marker(e,{icon:n});return r.options.icon.options.className+=" easyincident-smallmarker",r}},e)};smap.cmd.getControl("LayerSwitcher");n=smap.core.layerInst._createLayer(r),this._mmpExternalLayers.push(n);var o=this;n.on("load",function(t){t.target.eachLayer(function(t){o._cluster.addLayer(t)})}),this.map.fire("layeradd",{layer:n,target:n}),this._refreshCluster()},_unbindEvents:function(){this.map.off("click",this.onMapClick)},_adaptUrl:function(t){return t&&t.length&&"string"==typeof t?("localhost"===document.domain?t=t.replace("gkkundservice.malmo.se","localhost/gkkundservicedev").replace("gkkundservice.test.malmo.se","localhost/gkkundservicedev").replace("kartor.malmo.se","localhost"):"kartor.malmo.se"===document.domain&&(t=t.replace("gkkundservice.test.malmo.se/","kartor.malmo.se/gkkundservicedev/").replace("gkkundservice.malmo.se/","kartor.malmo.se/gkkundservice/")),t):t},_save:function(t,e){var a=this.options.wsSave;a=this._adaptUrl(a),smap.cmd.loading(!0),$.ajax($.extend({url:a,type:"GET",data:t,context:this,cache:!1,dataType:"json",success:function(t){t.success&&JSON.parse(t.success)?(console.log("Saved position successfully. Code: "+t.code+". Msg: "+t.msg),this._toggleBtn(!0)):alert("Could not save because "+t.msg+". Error code: "+t.code)},error:function(t,e,a){alert("Could not save because: "+e)},complete:function(){smap.cmd.loading(!1)}},e))},save:function(){var t=utils.projectPoint(this._latLng.lng,this._latLng.lat,"EPSG:4326","EPSG:3008"),e=t[0],a=t[1],n={x:Math.round(e),y:Math.round(a),tempId:this._tempId||null};console.log("Skickar: "+JSON.stringify(n)),this._save(n)},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-mmp-btn" class="btn btn-primary btn-lg hidden"> '+this.lang.btnSave+"</button>"),this.$btn.on("click",function(e){return e.stopPropagation(),t.save(),!1}),$("#mapdiv").append(this.$btn)},_toggleBtn:function(t){t?this.$btn.removeClass("btn-primary").addClass("btn-success").html('<span class="fa fa-check"></span> '+this.lang.btnSaved):this.$btn.removeClass("btn-success").addClass("btn-primary").html(this.lang.btnSave)},_addMarker:function(t){var e=this;t&&(this._latLng=t);var a=L.AwesomeMarkers.icon({icon:this._editingIsActive?e.options.userMarker.icon:"lock",markerColor:e.options.userMarker.color,prefix:"fa",extraClasses:"mmpmarker"}),n=L.marker(t,{draggable:this._editingIsActive||!1,icon:a,zIndexOffset:999});n.on("dragstart",function(t){t.target.closePopup()}),n.on("dragend",function(t){e._toggleBtn(!1),e._latLng=t.target.getLatLng()}),e.options.geolocateMoveUserMarker&&e.map.on("locationfound",function(t){locationLatLng=L.latLng(t.latlng.lat,t.latlng.lng),e._toggleBtn(!1),e._marker.setLatLng(locationLatLng)}),this.map.addLayer(n),n.openPopup(),this._marker=n,this.$btn&&(this.$btn.removeClass("hidden"),$(".alert").remove())}})}]);