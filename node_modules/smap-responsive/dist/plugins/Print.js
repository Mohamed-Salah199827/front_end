!function(t){function n(o){if(i[o])return i[o].exports;var e=i[o]={exports:{},id:o,loaded:!1};return t[o].call(e.exports,e,e.exports,n),e.loaded=!0,e.exports}var i={};return n.m=t,n.c=i,n.p="",n(0)}([function(t,n){"use strict";L.Control.Print=L.Control.extend({options:{position:"topleft",printUrl:"//localhost/print-servlet/print",compactConditions:!0},_lang:{sv:{caption:"Skriv ut",mTitle:"Skriv ut/Exportera",header:"Rubrik",tip_header:"Rubrik (valfritt)",descript:"Beskrivning",tip_descript:"Beskrivning (valfritt)",layout:"Pappersformat",resolution:"Upplösning",orientation:"Orientering",portrait:"Stående",landscape:"Liggande",create:"Skapa bild",close:"Stäng",loading:"Laddar…",processingPrint:"Skapar bild…",northarrow:"Nordpil",scale:"Skala",misc:"Övrigt",legend:"Teckenförklaring",couldNotLoadCapabilities:"Kan inte skriva ut/exportera. Fick inget/felaktigt svar från servern.",conditionsHeader:"Jag godkänner <span>användarvillkoren</span>",conditions:'För utdrag från kartan/flygfotot till tryck eller annan publicering, krävs tillstånd från Malmö Stadsbyggnadskontor. Vid frågor om tillstånd, användningsområden eller kartprodukter kontakta Stadsbyggnadskontorets kartförsäljning:<br>040-34 24 35 eller <a href="mailto:sbk.sma@malmo.se?subject=Best%E4lla karta">sbk.sma@malmo.se</a>.',conditionsTip:"För att kunna skriva ut måste du godkänna användarvillkoren.",confirm:"Kom ihåg mitt val"},en:{caption:"Print",mTitle:"Print/Export",header:"Rubrik",tip_header:"Header (optional)",descript:"Description",tip_descript:"Description (optional)",layout:"Layout",resolution:"Resolution",orientation:"Orientation",portrait:"Portrait",landscape:"landscape",create:"Create image",close:"Close",loading:"Loading…",processingPrint:"Creating image…",northarrow:"North arrow",scale:"Scale",misc:"Miscellaneous",legend:"Legend",couldNotLoadCapabilities:"Cannot print/export. Bad response from the server.",conditionsHeader:"I agree to these <span>terms</span>",conditions:'For excerpts from the map or aerial photo for commercial printing or other types of publication, permission is required from the City Planning Office. For questions about these terms or map products, please contact our sales office: <br> +46 40 34 24 35 or <a href="mailto:sbk.sma@malmo.se?subject=Best%E4lla karta">sbk.sma@malmo.se</a>.',conditionsTip:"To print you must agree to the user terms.",confirm:"Remember my choice"}},_setLang:function(t){t=t||smap.config.langCode,this._lang&&(this.lang=this._lang?this._lang[t]:null)},initialize:function(t){L.setOptions(this,t),this._setLang(t.langCode)},onAdd:function(t){return this.map=t,this._container=L.DomUtil.create("div","leaflet-control-Print"),L.DomEvent.disableClickPropagation(this._container),this.$container=$(this._container),this._createBtn(),this._initPrint(),this._drawModal(),this._container},onRemove:function(t){this._removeBtn(),this._destroyPrint()},_createBtn:function(){var t=this;this.$btn=$('<button id="smap-print-btn" title="'+t.lang.caption+'" class="btn btn-default"><span class="fa fa-print"></span></button>'),this.$btn.on("click touchstart",function(){return t.show(),!1}),this.$container.append(this.$btn)},_removeBtn:function(){this.$btn.remove()},_initPrint:function(){function t(){smap.cmd.notify(n.lang.couldNotLoadCapabilities,"error",{parent:$(".modal-body")}),n._modal.off("shown.bs.modal",t)}var n=this;L.mapbox=L.mapbox||{TileLayer:L.Class.extend({})},this.printProvider=L.print.provider({method:"POST",url:this.options.printUrl,autoLoad:!0,copy:"© Stadsbyggnadskontoret, Malmö stad",layout:"A4_Portrait_NoArrow_NoBar",outputFormat:"pdf",map:this.map}),this.printProvider.on("printexception printsuccess",function(){var t=n._modal.find("button[type='submit']");t.button("reset"),smap.cmd.loading(!1)}),this.printProvider.on("oncapabilitiesloaderror",function(i){n._modal&&($(".modal-body").length?t():n._modal.on("shown.bs.modal",t))}),this.printOptions={paperFormat:"A4",orientation:"Portrait",arrow:!1,scalebar:!1,dpi:96,legends:[]},this.printProvider.on("capabilitiesload",function(t){t.capabilities.printURL=t.capabilities.printURL.replace(/localhost:8080/g,"localhost").replace(document.domain,"localhost"),t.capabilities.createURL=t.capabilities.createURL.replace(/localhost:8080/g,"localhost").replace(document.domain,"localhost")})},_destroyPrint:function(){this.printProvider.destroy(),this.printProvider=null,this._modal.remove()},_getMercatorScaleForLat:function(){var t=this.map.getCenter().lat,n=this.printProvider._getScale(),i=1/Math.cos(t*Math.PI/180);return n=parseInt(Math.round(n/i))},_makeLegends:function(){var t,n,i,o,e,a=[],r=this.map._layers;for(e in r)t=r[e],o=t.options,!o||void 0!==o.legend&&o.legend===!1||(o.isBaseLayer?delete o.legend:o&&(o.legend||t instanceof L.TileLayer.WMS||t instanceof L.GeoJSON.WFS)&&(n=o.legend,n&&n.length||(n=-1===t._url.search(/\?/)?t._url+"?":t._url,n=n+"request=GetLegendGraphic&format=image/png&width=20&height=20&layer="+o.layers),n&&(i=o.displayName||"Unnamed layer"),a.push({name:i,icon:n})));var s=[{name:"Teckenförklaring",classes:a}];return s},_preprocessPrintOptions:function(t){var n={mapTitle:t.mapTitle,comment:t.comment,dpi:t.dpi,legends:this._makeLegends(),displayscale:this.lang.scale+" 1:",layout:[t.paperFormat,t.orientation,t.legend?"Legend":"NoLegend"].join("_")};return n},_preprocessLayers:function(){var t,n,i=this.map;for(t in i._layers){var o=i._layers[t];if(o.options&&o.options.layerId){if(n=smap.cmd.getLayerConfig(o.options.layerId),!n)continue;if(o instanceof L.NonTiledLayer.WMS&&!n.options.printLayer){var e=$.extend(!0,{},n.options);e.layerId+="1",n.options.printLayer={url:n.url,init:"L.TileLayer.WMS",options:e},o.options.printLayer=$.extend(!0,{},n.options.printLayer)}}}},print:function(t){if(!this.printProvider._capabilities)return console.log("Print capabilities could not be loaded. Cannot print."),!1;var n=this._modal.find("button[type='submit']");n.attr("data-loading-text",this.lang.processingPrint),n.button("loading"),smap.cmd.loading(!0),this._preprocessLayers(),this.printProvider.print(t)},_drawModal:function(){var t=this,n="resources/PrintModal.html";document.URL.search(/\/dev.html/)>-1&&(n="plugins/Print/"+n);var i=utils.isTouchOnly()?"tap":"click";$.get(n,function(n){n=utils.extractToHtml(n,t.lang),t._modal=utils.drawDialog(t.lang.mTitle,n);var o=t._modal.find(".print-conditions");t.conditionsCheckbox=t._modal.find('[name="conditions"]'),t.submitDiv=t._modal.find("#submitDiv");var e=t._modal.find("button[type=submit]"),a=t._modal.find("#conditionsLink span"),r=t._modal.find('[name="storeAnswer"]');t.options.compactConditions?("yes"===localStorage.getItem("smapConditionsAgreed")?(t.conditionsCheckbox.prop("checked",!0),r.prop({checked:!0,disabled:!1}),e.prop("disabled",!1)):t.conditionsCheckbox.prop("checked",!1),a.addClass("link"),r.change(function(){t._storeConditions(r.prop("checked"))}),r.next().on(i,function(){var t=$(this).prev();return t.prop("checked",!t.prop("checked")),!1}),o.hide(),a.on(i,function(){o.slideToggle(250)})):(a.append(":"),t._modal.find("#store").hide()),t.conditionsCheckbox.change(function(){t._setButtonState(t.conditionsCheckbox.prop("checked"))}),t.submitDiv.on(i,function(n){t.conditionsCheckbox.prop("checked")||(t.conditionsCheckbox=$("#printmodal").find('[name="conditions"]'),t.conditionsCheckbox.popover({content:t.lang.conditionsTip,trigger:"manual",placement:"right",animation:"false"}),t.conditionsCheckbox.popover("show"),n.stopPropagation(),t._modal.one(i,function(){t.conditionsCheckbox.popover("destroy")}))}),t._modal.attr("id","printmodal"),t._modal.addClass("printmodal"),t._modal.find("form").submit(function(){var n=utils.paramsStringToObject($(this).serialize(),!1);return n=t._preprocessPrintOptions(n),t.printProvider.setDpi(n.dpi),t.print(n),!1}),smap.event.trigger("smap:print:modaldrawn"),t._modal.find("[placeholder]").placeholder()})},_setButtonState:function(t){var n=$("#printmodal").find("button[type=submit]"),i=$("#printmodal").find('[name="storeAnswer"]');n.prop("disabled",t?!1:!0),i.prop({disabled:t?!1:!0})},_storeConditions:function(t){if("undefined"!=typeof Storage){var n=localStorage.getItem("smapConditionsAgreed");if("yes"===n&&t)return!1;n&&!t?localStorage.removeItem("smapConditionsAgreed"):t&&localStorage.setItem("smapConditionsAgreed","yes")}else console.log("No local storage support, unable to set user conditions confirmation.")},_loadCapabilities:function(){},show:function(){var t=this;this.printProvider._capabilities||this._loadCapabilities(),this._modal?this._modal.modal("show"):smap.event.off("smap:print:modaldrawn").on("smap:print:modaldrawn",function(){t._modal.modal("show")})},hide:function(){this._modal.modal("hide")}}),L.control.Print=function(t){return new L.Control.Print(t)}}]);